<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ü™∂ Mody Poetry</title>
  <meta name="description" content="ŸÖÿ¨ŸÜŸàŸÜ ÿßŸÑÿ¥Ÿêÿπÿ± ‚Äî ŸÖŸàŸÇÿπ Ÿäÿ¨ŸÖÿπ ÿ£ÿ¨ŸÖŸÑ ŸÇÿµÿßÿ¶ÿØŸä Ÿàÿ™ÿ£ŸÖŸÑÿßÿ™Ÿä ÿßŸÑÿ¥ÿπÿ±Ÿäÿ©" />
  
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-gradient-1:#fff8f0;
      --bg-gradient-2:#fef3e8;
      --card:#ffffff;
      --card-hover:#fffbf5;
      --muted:#8b7355;
      --accent:#3a1f0b;
      --brown:#8b5e3c;
      --brown-hover:#a67c52;
      --text:#2e1a0f;
      --shadow:rgba(58,31,11,0.08);
      --shadow-lg:rgba(58,31,11,0.12);
      --border:#e8dcc8;
      --placeholder:rgba(139,94,60,0.08);
      --header-dark:#e8d2bf; 
      --header-dark-2:#d9c0a6;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow-x:hidden}
    body{
      font-family:'Cairo',system-ui,sans-serif;
      background:linear-gradient(135deg,var(--bg-gradient-1) 0%,var(--bg-gradient-2) 100%);
      background-attachment:fixed;
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.7;
      padding:0;
    }
    .container{max-width:1100px;margin:0 auto;padding:20px}
    header{
      background:linear-gradient(180deg,var(--header-dark) 0%, var(--header-dark-2) 100%);
      backdrop-filter:blur(6px);
      border-bottom:1px solid rgba(0,0,0,0.06);
      position:sticky;
      top:0;
      z-index:100;
      box-shadow:0 6px 28px rgba(0,0,0,0.08);
      animation:slideDown 0.35s ease;
    }
    @keyframes slideDown{from{transform:translateY(-100%)}to{transform:translateY(0)}}
    .header-content{max-width:1100px;margin:0 auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px;background:rgba(58,31,11,0.06);color:var(--brown);box-shadow:0 4px 12px rgba(0,0,0,0.06)}
    .brand h1{font-size:20px;font-weight:700;color:var(--accent)}
    .brand p{font-size:13px;color:rgba(0,0,0,0.45);margin-top:2px}
    nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap;position:relative}
    .btn{padding:8px 12px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;border:1.4px solid var(--brown);background:#fff;color:#5a3f2a;display:inline-flex;align-items:center;gap:8px;transition:all .18s ease}
    .btn:hover{background:#f5ebe0;border-color:var(--brown-hover)}
    .small{padding:6px 10px;font-size:13px}
    
    .menu-container{position:relative}
    .menu-toggle{position:relative}
    .dropdown-menu{
      position:absolute;
      top:calc(100% + 8px);
      left:0;
      background:#fff;
      border-radius:10px;
      box-shadow:0 12px 32px rgba(0,0,0,0.15);
      border:1px solid var(--border);
      min-width:240px;
      display:none;
      z-index:200;
      padding:6px;
    }
    .dropdown-menu.show{display:block}
    .menu-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:8px;
      font-size:14px;
      font-weight:600;
      color:#5a3f2a;
      cursor:pointer;
      transition:all .15s ease;
      border:none;
      background:transparent;
      width:100%;
      text-align:right;
    }
    .menu-item:hover{background:#f5ebe0}
    .menu-divider{height:1px;background:var(--border);margin:6px 0}

    .hero{background:linear-gradient(135deg,rgba(255,255,255,0.92) 0%,rgba(255,251,245,0.92) 100%);backdrop-filter:blur(8px);border-radius:14px;padding:16px;margin:18px 0;box-shadow:0 8px 32px var(--shadow-lg);border:1px solid var(--border)}
    .search-wrapper{display:flex;gap:8px;flex-wrap:wrap}
    input[type="search"]{flex:1;min-width:200px;padding:10px 12px;border-radius:8px;border:1.5px solid #e8dcc8;font-size:15px;background:#fff}

    .tags-wrapper{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;align-items:center}
    .tag{padding:7px 12px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;border:1.2px solid #d4c4b0;background:#fff;color:#5a3f2a;transition:all .18s ease}
    .tag:hover{background:#f5ebe0;border-color:var(--brown)}
    .tag.active{background:#f5ebe0;border-color:var(--brown);box-shadow:0 6px 14px rgba(58,31,11,0.06)}

    .tag-input-wrapper{display:flex;gap:8px;margin-bottom:8px}
    .tag-badge{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;background:#f5ebe0;border:1px solid var(--brown);border-radius:8px;font-size:13px;color:var(--brown);font-weight:600}
    .tag-badge button{background:none;border:none;color:var(--brown);cursor:pointer;font-size:16px;padding:0;margin:0;line-height:1}
    .tag-badge button:hover{color:#d9534f}

    .audio-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .audio-item{display:flex;align-items:center;gap:8px;padding:8px;background:#f9f9f9;border-radius:8px;border:1px solid var(--border)}
    .audio-item button{background:#d9534f;color:#fff;border:none;padding:4px 8px;border-radius:6px;cursor:pointer;font-size:12px}
    .audio-item button:hover{background:#c9302c}

    .upload-progress{
      margin-top:10px;
      padding:10px;
      background:#f0f8ff;
      border-radius:8px;
      border:1px solid #4a90e2;
      display:none;
    }
    .upload-progress.show{display:block}
    .progress-bar{
      width:100%;
      height:20px;
      background:#e0e0e0;
      border-radius:10px;
      overflow:hidden;
      margin-top:8px;
    }
    .progress-fill{
      height:100%;
      background:#4a90e2;
      transition:width 0.3s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:12px;
      font-weight:600;
    }

    .sync-status{
      position:fixed;
      bottom:20px;
      right:20px;
      padding:10px 16px;
      background:rgba(139,94,60,0.95);
      color:#fff;
      border-radius:8px;
      font-size:13px;
      font-weight:600;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
      z-index:1000;
      display:none;
      align-items:center;
      gap:8px;
    }
    .sync-status.show{display:flex}

    .hidden-poem{
      opacity:0.4;
      position:relative;
    }
    .hidden-poem::after{
      content:'üëÅÔ∏è ŸÖÿÆŸÅŸäÿ©';
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      background:rgba(0,0,0,0.8);
      color:#fff;
      padding:8px 16px;
      border-radius:8px;
      font-size:13px;
      font-weight:600;
      pointer-events:none;
    }

    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-top:18px}
    .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 8px 20px rgba(0,0,0,0.04);border:1px solid var(--border);transition:all .22s cubic-bezier(0.4, 0, 0.2, 1);display:flex;gap:10px;align-items:flex-start;user-select:none;position:relative;overflow:hidden}
    .card::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(139,94,60,0.15),transparent);transition:left .5s ease;pointer-events:none}
    .card:hover{transform:translateY(-4px);box-shadow:0 12px 28px rgba(0,0,0,0.08)}
    .card:hover::before{left:100%}
    .card .drag-handle{flex:0 0 36px;display:flex;align-items:center;justify-content:center;border-radius:8px;cursor:grab;font-size:17px;color:var(--brown);user-select:none}
    .card .drag-handle:active{cursor:grabbing}
    .card .content{flex:1}
    .card h3{font-family:'Amiri',serif;margin:0 0 6px 0;color:var(--accent);font-size:19px;font-weight:700}
    .excerpt{font-family:'Amiri',serif;color:var(--muted);line-height:1.9;font-size:16px;min-height:56px}
    .card-footer{margin-top:8px;display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap}
    .card-tags{display:flex;gap:6px;flex-wrap:wrap}
    .card-tag{padding:4px 8px;border-radius:12px;font-size:12px;background:rgba(139,94,60,0.12);color:var(--brown);font-weight:700;display:inline-flex;align-items:center;gap:4px}
    .card-ghost{opacity:.4 !important;transform:scale(.98) rotate(2deg) !important;box-shadow:0 20px 40px rgba(0,0,0,.15) !important;transition:all .2s cubic-bezier(0.4, 0, 0.2, 1) !important}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;padding:18px;z-index:1200}
    .modal-inner{background:var(--card);max-width:820px;width:100%;border-radius:12px;padding:20px;max-height:90vh;overflow:auto;box-shadow:0 30px 60px rgba(0,0,0,.25);border:1px solid var(--border)}
    .modal-title{font-family:'Amiri',serif;font-size:22px;margin-bottom:6px;color:var(--accent)}
    .poem-text{font-family:'Amiri',serif;white-space:pre-line;font-size:18px;line-height:2;margin-top:12px;color:var(--text);text-align:justify}
    .modal-tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    
    .confirm-modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;padding:18px;z-index:1400}
    .confirm-modal.show{display:flex}
    .confirm-box{background:var(--card);border-radius:12px;padding:24px;max-width:400px;width:100%;box-shadow:0 20px 50px rgba(0,0,0,.3);border:1px solid var(--border)}
    .confirm-message{font-size:16px;margin-bottom:20px;line-height:1.6;white-space:pre-line}
    .confirm-buttons{display:flex;gap:10px;justify-content:flex-end}

    footer{text-align:center;color:var(--muted);margin-top:36px;padding:20px;font-size:13px}

    @media (max-width:768px){
      .grid{grid-template-columns:1fr}
      .header-content{padding:12px}
      nav{gap:6px}
      .dropdown-menu{min-width:200px;right:0;left:auto}
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="brand">
        <div class="brand-icon">‚òï</div>
        <div>
          <h1>Mody Poetry üî•</h1>
          <p class="muted">ÿ¥ÿßÿ±ŸÉ ŸÇÿµÿßÿ¶ÿØŸÉ ŸÖÿπ ÿßŸÑÿ£ÿ∫ÿßŸÜŸä ŸàÿßŸÑŸÅŸäÿØŸäŸàŸáÿßÿ™</p>
        </div>
      </div>

      <nav>
        <button class="btn small" id="btnAdd">‚úçÔ∏è ÿ£ÿ∂ŸÅ</button>
        <div class="menu-container">
          <button class="btn small menu-toggle" id="menuToggle">‚ò∞ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©</button>
          <div class="dropdown-menu" id="dropdownMenu">
            <button class="menu-item" id="btnDownload">üíæ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÇÿµÿßÿ¶ÿØ</button>
            <div class="menu-divider"></div>
            <button class="menu-item" id="btnReloadAndSort">ü•≥ ÿ¨ÿØŸäÿØ ŸÖŸàÿØŸä + ÿ™ÿ±ÿ™Ÿäÿ®</button>
            <div class="menu-divider"></div>
            <button class="menu-item" id="btnImportJSON">üì• ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ JSON</button>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <!-- Sync Status -->
  <div id="syncStatus" class="sync-status">
    <span id="syncText">üîÑ ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©...</span>
  </div>

  <!-- User Info -->
  <div id="userInfoDisplay" style="display:none;padding:10px 20px;background:rgba(139,94,60,0.1);border-bottom:1px solid var(--border)">
    <div style="max-width:1100px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
      <div>
        <span style="font-weight:600">üë§ ŸÖÿ±ÿ≠ÿ®ÿßŸãÿå </span>
        <span id="currentUserName" style="color:var(--brown)">---</span>
      </div>
      <button class="btn small" id="btnChangeProfile">ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÖŸÑŸÅ</button>
    </div>
  </div>

  <div class="container">
    <section class="hero">
      <div class="search-wrapper">
        <input id="searchInput" type="search" placeholder="üîç ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿπŸÜŸàÿßŸÜ ÿ£Ÿà ÿßŸÑŸÜÿµ..." />
      </div>
      <div id="tagsWrapper" class="tags-wrapper"></div>
    </section>

    <section id="listSection">
      <div id="poemGrid" class="grid"></div>
      <div id="emptyState" style="display:none;margin-top:18px;padding:18px;border-radius:12px;border:2px dashed var(--border);text-align:center">
        <div style="font-size:28px">üìú</div>
        <div style="font-weight:700;margin-top:8px">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÇÿµÿßÿ¶ÿØ</div>
        <div class="muted" style="margin-top:6px">ÿßÿ∂ÿ∫ÿ∑ "ÿ£ÿ∂ŸÅ" ŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÇÿµŸäÿØÿ© ÿ¨ÿØŸäÿØÿ©</div>
      </div>
    </section>

    <!-- User Profile Modal -->
    <div id="userProfileModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:1500;align-items:center;justify-content:center;padding:18px">
      <div style="background:var(--card);border-radius:12px;padding:20px;max-width:400px;width:100%;box-shadow:0 20px 50px rgba(0,0,0,.25);border:1px solid var(--border)">
        <h3 style="margin:0 0 15px 0">üë§ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä</h3>
        <div style="display:flex;flex-direction:column;gap:10px">
          <input id="userName" type="text" placeholder="ÿßÿ≥ŸÖŸÉ *" required style="padding:10px;border-radius:8px;border:1px solid #e8dcc8" />
          <input id="userEmail" type="email" placeholder="ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)" style="padding:10px;border-radius:8px;border:1px solid #e8dcc8" />
          <textarea id="userBio" placeholder="ŸÜÿ®ÿ∞ÿ© ÿπŸÜŸÉ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)" style="min-height:80px;padding:10px;border-radius:8px;border:1px solid #e8dcc8"></textarea>
          <button class="btn" id="btnSaveProfile">ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä</button>
        </div>
      </div>
    </div>

    <!-- Add Poem Modal -->
    <div id="addModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:1300;align-items:center;justify-content:center;padding:18px">
      <div style="background:var(--card);border-radius:12px;padding:16px;max-width:720px;width:100%;box-shadow:0 20px 50px rgba(0,0,0,.25);border:1px solid var(--border);max-height:90vh;overflow-y:auto">
        <h3 style="margin:0 0 10px 0" id="modalFormTitle">‚úçÔ∏è ÿ£ÿ∂ŸÅ ŸÇÿµŸäÿØÿ©</h3>
        <form id="poemForm">
          <div style="display:flex;flex-direction:column;gap:8px">
            <input id="inputTitle" type="text" placeholder="ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÇÿµŸäÿØÿ© *" required style="padding:10px;border-radius:8px;border:1px solid #e8dcc8" />
            <input id="inputAuthor" type="text" placeholder="ÿßŸÑŸÖÿ§ŸÑŸÅ / ÿßŸÑÿ±ÿßŸàŸä" style="padding:10px;border-radius:8px;border:1px solid #e8dcc8" />
            <textarea id="inputText" placeholder="ŸÜÿµ ÿßŸÑŸÇÿµŸäÿØÿ© *" required style="min-height:140px;padding:10px;border-radius:8px;border:1px solid #e8dcc8;font-family:Amiri,serif"></textarea>
            <input id="inputExcerpt" type="text" placeholder="ŸÖŸÇÿ™ÿ∑ŸÅ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)" style="padding:10px;border-radius:8px;border:1px solid #e8dcc8" />
            
            <div>
              <label style="display:block;margin-bottom:6px;font-size:14px;font-weight:600">ÿßŸÑŸàÿ≥ŸàŸÖ (ÿßÿ∂ÿ∫ÿ∑ Enter)</label>
              <div id="tagsDisplay" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px"></div>
              <input id="inputTagField" type="text" placeholder="ÿßŸÉÿ™ÿ® Ÿàÿ≥ŸÖ Ÿàÿßÿ∂ÿ∫ÿ∑ Enter" style="padding:10px;border-radius:8px;border:1px solid #e8dcc8;width:100%" />
            </div>

            <div>
              <label style="display:block;margin-bottom:6px;font-size:14px;font-weight:600">üì§ ÿ±ŸÅÿπ ÿßŸÑÿ£ÿ∫ÿßŸÜŸä ŸàÿßŸÑŸÅŸäÿØŸäŸàŸáÿßÿ™</label>
              <div id="audioDisplay" class="audio-list"></div>
              
              <!-- File Upload -->
              <div style="margin-top:8px">
                <input type="file" id="inputAudioFile" accept="audio/*,video/*" multiple style="padding:8px;border-radius:8px;border:1px solid #e8dcc8;width:100%;font-size:13px" />
              </div>
              
              <!-- Upload Progress -->
              <div id="uploadProgress" class="upload-progress">
                <div id="uploadText" style="font-size:13px;font-weight:600;color:#4a90e2">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ±ŸÅÿπ...</div>
                <div class="progress-bar">
                  <div id="progressFill" class="progress-fill" style="width:0%">0%</div>
                </div>
              </div>
              
              <div style="margin-top:6px;font-size:12px;color:var(--muted)">
                üí° ŸäŸÖŸÉŸÜŸÉ ÿ±ŸÅÿπ ŸÖŸÑŸÅÿßÿ™ ÿµŸàÿ™Ÿäÿ© ÿ£Ÿà ŸÅŸäÿØŸäŸà (ÿ£Ÿä ÿ≠ÿ¨ŸÖ) - ÿ≥Ÿäÿ™ŸÖ ÿ±ŸÅÿπŸáÿß ÿπŸÑŸâ Firebase Storage
              </div>
            </div>

            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button type="button" class="btn" id="btnCancelAdd">ÿ•ŸÑÿ∫ÿßÿ°</button>
              <button type="submit" class="btn">ŸÜÿ¥ÿ± ÿßŸÑŸÇÿµŸäÿØÿ© üì§</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="confirm-modal">
      <div class="confirm-box">
        <div id="confirmMessage" class="confirm-message"></div>
        <div class="confirm-buttons" id="confirmButtons"></div>
      </div>
    </div>
  </div>

  <footer>
    ¬© <span id="year"></span> ŸÖÿ¨ŸÜŸàŸÜ ÿßŸÑÿ¥Ÿêÿπÿ± ‚Äî Powered by Firebase üî•
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyANYJJ3gTxEgeaj731npdx37OHd4Xf3t70",
      authDomain: "modypoems.firebaseapp.com",
      databaseURL: "https://modypoems-default-rtdb.firebaseio.com",
      projectId: "modypoems",
      storageBucket: "modypoems.firebasestorage.app",
      messagingSenderId: "805060440847",
      appId: "1:805060440847:web:bc4f89cd351c9c244f447a",
      measurementId: "G-V1QZ976MYE"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const storage = getStorage(app);

    // State
    const USER_KEY = 'mody_user_profile';
    const HIDDEN_KEY = 'mody_hidden_poems';
    let poems = [];
    let originalPoems = null;
    let hiddenPoems = [];
    let isDragging = false;
    let activeTag = null;
    let editingPoem = null;
    let currentTags = [];
    let currentAudios = [];
    let currentUser = null;
    let isUpdatingFromFirebase = false;

    // DOM Elements
    const poemGrid = document.getElementById('poemGrid');
    const emptyState = document.getElementById('emptyState');
    const searchInput = document.getElementById('searchInput');
    const tagsWrapper = document.getElementById('tagsWrapper');
    const year = document.getElementById('year');
    const btnDownload = document.getElementById('btnDownload');
    const btnReloadAndSort = document.getElementById('btnReloadAndSort');
    const btnImportJSON = document.getElementById('btnImportJSON');
    const btnAdd = document.getElementById('btnAdd');
    const addModal = document.getElementById('addModal');
    const poemForm = document.getElementById('poemForm');
    const btnCancelAdd = document.getElementById('btnCancelAdd');
    const menuToggle = document.getElementById('menuToggle');
    const dropdownMenu = document.getElementById('dropdownMenu');
    const confirmModal = document.getElementById('confirmModal');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmButtons = document.getElementById('confirmButtons');
    const inputTagField = document.getElementById('inputTagField');
    const tagsDisplay = document.getElementById('tagsDisplay');
    const audioDisplay = document.getElementById('audioDisplay');
    const syncStatus = document.getElementById('syncStatus');
    const syncText = document.getElementById('syncText');
    const userProfileModal = document.getElementById('userProfileModal');
    const userInfoDisplay = document.getElementById('userInfoDisplay');
    const userName = document.getElementById('userName');
    const userEmail = document.getElementById('userEmail');
    const userBio = document.getElementById('userBio');
    const btnSaveProfile = document.getElementById('btnSaveProfile');
    const btnChangeProfile = document.getElementById('btnChangeProfile');
    const currentUserName = document.getElementById('currentUserName');
    const inputAudioFile = document.getElementById('inputAudioFile');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadText = document.getElementById('uploadText');
    const progressFill = document.getElementById('progressFill');

    year.textContent = new Date().getFullYear();

    // Load hidden poems
    function loadHiddenPoems() {
      const stored = localStorage.getItem(HIDDEN_KEY);
      if (stored) {
        try {
          hiddenPoems = JSON.parse(stored);
        } catch (e) {
          hiddenPoems = [];
        }
      }
    }

    function saveHiddenPoems() {
      localStorage.setItem(HIDDEN_KEY, JSON.stringify(hiddenPoems));
    }

    function isPoemHidden(poemId) {
      return hiddenPoems.includes(poemId);
    }

    function toggleHidePoem(poemId) {
      const index = hiddenPoems.indexOf(poemId);
      if (index > -1) {
        hiddenPoems.splice(index, 1);
      } else {
        hiddenPoems.push(poemId);
      }
      saveHiddenPoems();
      renderPoems();
    }

    function isOwnPoem(poem) {
      return poem.userId === currentUser.id;
    }

    // Utilities
    function showSyncStatus(message, duration = 2000) {
      syncText.textContent = message;
      syncStatus.classList.add('show');
      setTimeout(() => syncStatus.classList.remove('show'), duration);
    }

    function showAlert(message) {
      confirmMessage.textContent = message;
      confirmButtons.innerHTML = '<button class="btn" onclick="document.getElementById(\'confirmModal\').classList.remove(\'show\')">ÿ≠ÿ≥ŸÜÿßŸã</button>';
      confirmModal.classList.add('show');
    }
    
    function showConfirm(message, onConfirm) {
      confirmMessage.textContent = message;
      confirmButtons.innerHTML = '';
      const btnCancel = document.createElement('button');
      btnCancel.className = 'btn';
      btnCancel.textContent = 'ÿ•ŸÑÿ∫ÿßÿ°';
      btnCancel.onclick = () => confirmModal.classList.remove('show');
      const btnOk = document.createElement('button');
      btnOk.className = 'btn';
      btnOk.textContent = 'ÿ™ÿ£ŸÉŸäÿØ';
      btnOk.onclick = () => {
        confirmModal.classList.remove('show');
        onConfirm();
      };
      confirmButtons.appendChild(btnCancel);
      confirmButtons.appendChild(btnOk);
      confirmModal.classList.add('show');
    }

    function escapeHtml(text) {
      const d = document.createElement('div');
      d.textContent = text || '';
      return d.innerHTML;
    }

    // User Profile
    function checkUserProfile() {
      const stored = localStorage.getItem(USER_KEY);
      if (stored) {
        currentUser = JSON.parse(stored);
        showUserInfo();
      } else {
        userProfileModal.style.display = 'flex';
      }
    }

    function showUserInfo() {
      currentUserName.textContent = currentUser.name;
  userInfoDisplay.style.display = 'block';
      }
    btnSaveProfile.addEventListener('click', function() {
      const name = userName.value.trim();
      if (!name) {
        showAlert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖŸÉ');
        return;
      }
      currentUser = {
        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        name: name,
        email: userEmail.value.trim(),
        bio: userBio.value.trim(),
        createdAt: new Date().toISOString()
      };
      localStorage.setItem(USER_KEY, JSON.stringify(currentUser));
      userProfileModal.style.display = 'none';
      showUserInfo();
      saveUserProfileToFirebase();
    });

    btnChangeProfile.addEventListener('click', function() {
      userName.value = currentUser.name;
      userEmail.value = currentUser.email || '';
      userBio.value = currentUser.bio || '';
      userProfileModal.style.display = 'flex';
    });

    // Firebase Functions
    async function saveUserProfileToFirebase() {
      try {
        await set(ref(database, 'users/' + currentUser.id), currentUser);
        console.log('‚úÖ Profile saved');
      } catch (error) {
        console.error('Profile save error:', error);
      }
    }

    async function savePoemsToFirebase() {
      if (isUpdatingFromFirebase) return;
      try {
        showSyncStatus('üîÑ ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©...');
        await set(ref(database, 'poems'), poems);
        showSyncStatus('‚úÖ ÿ™ŸÖ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
        console.log('‚úÖ Poems synced');
      } catch (error) {
        console.error('Sync error:', error);
        showSyncStatus('‚ùå ŸÅÿ¥ŸÑÿ™ ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©', 3000);
      }
    }

    async function loadPoemsFromFirebase() {
      try {
        const snapshot = await get(ref(database, 'poems'));
        if (snapshot.exists()) {
          isUpdatingFromFirebase = true;
          poems = snapshot.val() || [];
          renderPoems();
          isUpdatingFromFirebase = false;
          console.log('‚úÖ Poems loaded:', poems.length);
        }
      } catch (error) {
        console.error('Load error:', error);
      }
    }

    function setupFirebaseListener() {
      const poemsRef = ref(database, 'poems');
      onValue(poemsRef, (snapshot) => {
        if (snapshot.exists() && !isUpdatingFromFirebase) {
          isUpdatingFromFirebase = true;
          poems = snapshot.val() || [];
          renderPoems();
          showSyncStatus('üîÑ ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÜ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¢ÿÆÿ±!', 2000);
          isUpdatingFromFirebase = false;
        }
      });
    }

    // Load from GitHub JSON
    async function loadFromGitHub() {
      const urls = [
        'https://raw.githubusercontent.com/abdomedo2033-code/ModyPoetry/main/poems.json',
        'poems.json'
      ];

      for (let i = 0; i < urls.length; i++) {
        try {
          const response = await fetch(urls[i] + '?_=' + Date.now(), {cache: 'no-store'});
          if (!response.ok) throw new Error('fetch failed: ' + response.status);
          const data = await response.json();
          if (!Array.isArray(data)) throw new Error('poems.json must be an array');
          originalPoems = data.map(p => ({...p}));
          console.log('‚úÖ GitHub poems loaded:', originalPoems.length);
          return originalPoems;
        } catch (error) {
          console.warn('Failed to load from:', urls[i], error);
        }
      }
      return null;
    }

    // File Upload to Firebase Storage
    async function uploadFileToStorage(file) {
      return new Promise((resolve, reject) => {
        const timestamp = Date.now();
        const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
        const path = `media/${currentUser.id}/${timestamp}_${safeName}`;
        
        const fileRef = storageRef(storage, path);
        const uploadTask = uploadBytesResumable(fileRef, file);

        uploadProgress.classList.add('show');
        uploadText.textContent = `ÿ¨ÿßÿ±Ÿä ÿ±ŸÅÿπ: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;

        uploadTask.on('state_changed',
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            progressFill.style.width = progress + '%';
            progressFill.textContent = Math.round(progress) + '%';
          },
          (error) => {
            console.error('Upload error:', error);
            uploadProgress.classList.remove('show');
            showAlert('‚ùå ŸÅÿ¥ŸÑ ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ: ' + error.message);
            reject(error);
          },
          async () => {
            try {
              const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
              uploadProgress.classList.remove('show');
              progressFill.style.width = '0%';
              showSyncStatus('‚úÖ ÿ™ŸÖ ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ ÿ®ŸÜÿ¨ÿßÿ≠!', 2000);
              resolve({
                url: downloadURL,
                name: file.name,
                size: file.size,
                type: file.type,
                uploadedBy: currentUser.name,
                uploadedAt: new Date().toISOString()
              });
            } catch (error) {
              reject(error);
            }
          }
        );
      });
    }

    // File Input Handler
    if (inputAudioFile) {
      inputAudioFile.addEventListener('change', async function(e) {
        const files = e.target.files;
        
        for (const file of Array.from(files)) {
          try {
            const uploadedFile = await uploadFileToStorage(file);
            currentAudios.push(uploadedFile);
            renderAudiosInForm();
          } catch (error) {
            console.error('Upload failed:', error);
          }
        }
        
        e.target.value = '';
      });
    }

    // Tag Management
    function renderTagsInForm() {
      tagsDisplay.innerHTML = '';
      currentTags.forEach(function(tag, index) {
        const badge = document.createElement('span');
        badge.className = 'tag-badge';
        badge.innerHTML = escapeHtml(tag) + ' <button type="button" onclick="removeTag(' + index + ')">√ó</button>';
        tagsDisplay.appendChild(badge);
      });
    }

    function addTag() {
      const tag = inputTagField.value.trim();
      if (tag && !currentTags.includes(tag)) {
        currentTags.push(tag);
        renderTagsInForm();
        inputTagField.value = '';
      }
    }

    function removeTag(index) {
      currentTags.splice(index, 1);
      renderTagsInForm();
    }

    window.removeTag = removeTag;

    inputTagField.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        addTag();
      }
    });

    // Audio Management
    function renderAudiosInForm() {
      audioDisplay.innerHTML = '';
      currentAudios.forEach(function(audio, index) {
        const item = document.createElement('div');
        item.className = 'audio-item';
        
        let displayText = '';
        let badge = '';
        
        if (audio.url) {
          const sizeMB = audio.size ? (audio.size / 1024 / 1024).toFixed(2) : '?';
          displayText = `üì¶ ${escapeHtml(audio.name)} (${sizeMB} MB)`;
          badge = '<span style="background:#28a745;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:6px">Firebase</span>';
        } else if (typeof audio === 'string') {
          displayText = 'üéµ ' + escapeHtml(audio.substring(0, 50));
        }
        
        item.innerHTML = badge + displayText + ' <button type="button" onclick="removeAudio(' + index + ')">ÿ≠ÿ∞ŸÅ</button>';
        audioDisplay.appendChild(item);
      });
    }

    function removeAudio(index) {
      currentAudios.splice(index, 1);
      renderAudiosInForm();
    }

    window.removeAudio = removeAudio;

    // Menu Handlers
    menuToggle.addEventListener('click', function(e) {
      e.stopPropagation();
      dropdownMenu.classList.toggle('show');
    });

    document.addEventListener('click', function(e) {
      if (!e.target.closest('.menu-container')) {
        dropdownMenu.classList.remove('show');
      }
    });

    document.querySelectorAll('.menu-item').forEach(function(item) {
      item.addEventListener('click', function() {
        dropdownMenu.classList.remove('show');
      });
    });

    // Rendering Functions
    function renderTags() {
      const tagSet = new Set();
      poems.forEach(function(p) {
        (p.tags || []).forEach(function(t) { tagSet.add(t); });
      });
      tagsWrapper.innerHTML = '';
      const allBtn = document.createElement('button');
      allBtn.className = 'tag';
      allBtn.textContent = 'ÿßŸÑŸÉŸÑ';
      if (!activeTag) allBtn.classList.add('active');
      allBtn.addEventListener('click', function() {
        activeTag = null;
        searchInput.value = '';
        renderPoems();
      });
      tagsWrapper.appendChild(allBtn);
      Array.from(tagSet).sort().forEach(function(tag) {
        const btn = document.createElement('button');
        btn.className = 'tag';
        btn.textContent = tag;
        if (activeTag === tag) btn.classList.add('active');
        btn.addEventListener('click', function() {
          activeTag = tag;
          searchInput.value = '';
          renderPoems();
        });
        tagsWrapper.appendChild(btn);
      });
    }

    function renderPoems() {
      const q = (searchInput.value || '').trim().toLowerCase();
      poemGrid.innerHTML = '';

      let filtered;
      if (activeTag) {
        filtered = poems.filter(function(p) {
          return (p.tags || []).includes(activeTag);
        });
      } else {
        filtered = poems.filter(function(p) {
          if (!q) return true;
          const s = (p.title + ' ' + p.text + ' ' + (p.excerpt || '') + ' ' + (p.tags||[]).join(' ')).toLowerCase();
          return s.includes(q);
        });
      }

      if (filtered.length === 0) {
        emptyState.style.display = 'block';
        renderTags();
        return;
      } else {
        emptyState.style.display = 'none';
      }

      filtered.forEach(function(poem) {
        const card = document.createElement('div');
        card.className = 'card';
        if (isPoemHidden(poem.id)) {
          card.classList.add('hidden-poem');
        }
        card.dataset.id = poem.id || ('p-' + (Math.random()*1e9|0));

        const tagsHtml = (poem.tags || []).slice(0,3).map(function(t){ 
          return '<span class="card-tag">' + escapeHtml(t) + '</span>'; 
        }).join('');

        const userBadge = poem.createdBy ? '<span class="muted" style="font-size:11px">üë§ ' + escapeHtml(poem.createdBy) + '</span>' : '';
        
        const audioCount = (poem.audios || []).length;
        const mediaBadge = audioCount > 0 ? '<span class="card-tag" style="background:#4a90e2;color:#fff">üéµ ' + audioCount + ' ŸÖŸÑŸÅ</span>' : '';

        card.innerHTML = `
          <div class="drag-handle">‚ò∞</div>
          <div class="content">
            <h3>${escapeHtml(poem.title)}</h3>
            <div class="excerpt">${escapeHtml(poem.excerpt || poem.text.slice(0,120) + (poem.text.length>120?'...':''))}</div>
            <div class="card-footer">
              <div>
                ${poem.author?'<span class="muted">‚úíÔ∏è '+escapeHtml(poem.author)+'</span>':''}
                ${userBadge}
              </div>
              <div class="card-tags">${tagsHtml} ${mediaBadge}</div>
            </div>
          </div>
        `;

        card.addEventListener('click', function(e) {
          if (isDragging) return;
          openModal(poem);
        });

        poemGrid.appendChild(card);
      });

      renderTags();
    }

    function openModal(poem) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      
      const tagsHtml = (poem.tags || []).map(function(t){ 
        return '<span class="card-tag">' + escapeHtml(t) + '</span>'; 
      }).join('');

      const audiosHtml = (poem.audios || []).map(function(audio){ 
        return '<div style="margin-top:12px">' + getAudioHtml(audio) + '</div>'; 
      }).join('');

      const userInfo = poem.createdBy ? '<div class="muted" style="margin-top:4px">üë§ ÿ£ÿ∂ŸäŸÅÿ™ ÿ®Ÿàÿßÿ≥ÿ∑ÿ©: ' + escapeHtml(poem.createdBy) + '</div>' : '';

      const canEdit = isOwnPoem(poem);
      const canDelete = isOwnPoem(poem);
      const isHidden = isPoemHidden(poem.id);

      const editButton = canEdit ? '<button class="btn small" id="editPoem">‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ</button>' : '';
      const deleteButton = canDelete ? '<button class="btn small" id="deletePoem">üóëÔ∏è ÿ≠ÿ∞ŸÅ</button>' : '';
      const hideButton = !canEdit ? `<button class="btn small" id="hidePoem">${isHidden ? 'üëÅÔ∏è ÿ•ÿ∏Ÿáÿßÿ±' : 'üôà ÿ•ÿÆŸÅÿßÿ°'}</button>` : '';

      modal.innerHTML = `
        <div class="modal-inner">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
            <div style="flex:1">
              <div class="modal-title">${escapeHtml(poem.title)}</div>
              <div class="muted" style="margin-top:6px">${poem.author? '‚úíÔ∏è '+escapeHtml(poem.author):''}</div>
              ${userInfo}
              ${tagsHtml ? '<div class="modal-tags">' + tagsHtml + '</div>' : ''}
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              ${editButton}
              ${deleteButton}
              ${hideButton}
              <button class="btn small" id="closeModal">‚úñÔ∏è ÿ•ÿ∫ŸÑÿßŸÇ</button>
            </div>
          </div>
          <div class="poem-text">${escapeHtml(poem.text)}</div>
          ${audiosHtml}
        </div>
      `;
      document.body.appendChild(modal);

      modal.querySelector('#closeModal').addEventListener('click', function() { modal.remove(); });
      modal.addEventListener('click', function(e) { if (e.target === modal) modal.remove(); });
      
      if (canEdit) {
        modal.querySelector('#editPoem').addEventListener('click', function() {
          editingPoem = poem;
          document.getElementById('inputTitle').value = poem.title || '';
          document.getElementById('inputAuthor').value = poem.author || '';
          document.getElementById('inputText').value = poem.text || '';
          document.getElementById('inputExcerpt').value = poem.excerpt || '';
          currentTags = poem.tags || [];
          renderTagsInForm();
          currentAudios = poem.audios || [];
          renderAudiosInForm();
          document.getElementById('modalFormTitle').textContent = '‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÇÿµŸäÿØÿ©';
          addModal.style.display = 'flex';
          modal.remove();
        });
      }
      
      if (canDelete) {
        modal.querySelector('#deletePoem').addEventListener('click', function() {
          showConfirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÇÿµŸäÿØÿ©ÿü', function() {
            poems = poems.filter(function(p) { return p.id !== poem.id; });
            savePoemsToFirebase();
            renderPoems();
            modal.remove();
          });
        });
      }

      if (!canEdit && modal.querySelector('#hidePoem')) {
        modal.querySelector('#hidePoem').addEventListener('click', function() {
          toggleHidePoem(poem.id);
          modal.remove();
        });
      }
      
      document.addEventListener('keydown', function esc(e){ 
        if (e.key === 'Escape') { 
          modal.remove(); 
          document.removeEventListener('keydown', esc); 
        }
      });
    }

    function getAudioHtml(audio) {
      if (!audio) return '';
      
      if (audio.url) {
        const isVideo = audio.type && audio.type.startsWith('video/');
        const sizeMB = audio.size ? (audio.size / 1024 / 1024).toFixed(2) : '?';
        
        if (isVideo) {
          return `
            <div style="background:#f9f9f9;padding:12px;border-radius:8px;border:1px solid var(--border)">
              <div style="font-size:13px;margin-bottom:8px;color:var(--brown)">
                üé¨ ${escapeHtml(audio.name)} (${sizeMB} MB)
              </div>
              <video controls style="width:100%;max-height:400px;border-radius:8px">
                <source src="${audio.url}" type="${audio.type}">
              </video>
            </div>
          `;
        } else {
          return `
            <div style="background:#f9f9f9;padding:12px;border-radius:8px;border:1px solid var(--border)">
              <div style="font-size:13px;margin-bottom:8px;color:var(--brown)">
                üéµ ${escapeHtml(audio.name)} (${sizeMB} MB)
              </div>
              <audio controls style="width:100%;border-radius:8px">
                <source src="${audio.url}" type="${audio.type}">
              </audio>
            </div>
          `;
        }
      }
      
      return '';
    }

    // Sortable
    let sortableInstance = null;
    function initSortable() {
      if (!poemGrid) return;
      if (sortableInstance && typeof sortableInstance.destroy === 'function') {
        try { sortableInstance.destroy(); } catch(e){}
      }
      sortableInstance = new Sortable(poemGrid, {
        animation: 200,
        ghostClass: 'card-ghost',
        handle: '.drag-handle',
        dataIdAttr: 'data-id',
        onStart: function() { isDragging = true; },
        onEnd: function() {
          const ids = Array.from(poemGrid.children).map(c => c.dataset.id).filter(Boolean);
          const newOrder = [];
          ids.forEach(id => {
            const found = poems.find(p => p.id === id);
            if (found) newOrder.push(found);
          });
          const missing = poems.filter(p => !ids.includes(p.id));
          poems = newOrder.concat(missing);
          savePoemsToFirebase();
          setTimeout(() => isDragging = false, 80);
        }
      });
    }

    // Event Listeners
    function attachListeners() {
      searchInput.addEventListener('input', function() {
        activeTag = null;
        renderPoems();
      });

      btnDownload.addEventListener('click', function() {
        const a = document.createElement('a');
        const blob = new Blob([JSON.stringify(poems, null, 2)], {type: 'application/json'});
        a.href = URL.createObjectURL(blob);
        a.download = 'mody_poems_' + Date.now() + '.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
      });

      btnReloadAndSort.addEventListener('click', async function() {
        showConfirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ¨ŸÑÿ® ÿ¢ÿÆÿ± ŸÇÿµÿßÿ¶ÿØ ŸÖŸàÿØŸä ŸÖŸÜ GitHub Ÿàÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÇÿµÿßÿ¶ÿØÿü\n\nÿ≥Ÿäÿ™ŸÖ ÿØŸÖÿ¨ ÿßŸÑŸÇÿµÿßÿ¶ÿØ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÖÿπ ŸÇÿµÿßÿ¶ÿØŸÉ ÿßŸÑÿ≠ÿßŸÑŸäÿ©.', async function() {
          showSyncStatus('üîÑ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿµÿßÿ¶ÿØ ŸÖŸàÿØŸä...', 3000);
          
          const githubPoems = await loadFromGitHub();
          
          if (!githubPoems) {
            showAlert('‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖŸÑŸÅ ÿπŸÑŸâ GitHub.\n\nüí° ŸÜÿµŸäÿ≠ÿ©:\n1. ÿ£ŸÜÿ¥ÿ¶ ŸÖŸÑŸÅ poems.json ŸÅŸä ŸÖÿ≥ÿ™ŸàÿØÿπŸÉ\n2. ÿ™ÿ£ŸÉÿØ ÿ£ŸÜ ÿßŸÑŸÖÿ≥ÿ™ŸàÿØÿπ Public\n3. ÿßÿ≥ÿ™ÿÆÿØŸÖ "ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ JSON" ŸÑÿ±ŸÅÿπ ŸÖŸÑŸÅ ŸÖŸÜ ÿ¨Ÿáÿßÿ≤ŸÉ');
            return;
          }

          const currentMap = new Map(poems.map(p => [p.id, p]));
          let added = 0;
          
          githubPoems.forEach(orig => {
            if (!currentMap.has(orig.id)) {
              poems.push({...orig});
              added++;
            }
          });

          const ordered = [];
          const seen = new Set();
          
          githubPoems.forEach(orig => {
            const found = poems.find(p => p.id === orig.id);
            if (found) {
              ordered.push(found);
              seen.add(found.id);
            }
          });
          
          poems.forEach(p => {
            if (!seen.has(p.id)) ordered.push(p);
          });
          
          poems = ordered;
          
          await savePoemsToFirebase();
          renderPoems();
          showAlert(`‚úÖ ÿ™ŸÖ ÿ®ŸÜÿ¨ÿßÿ≠!\n\nüéâ ÿ£Ÿèÿ∂ŸäŸÅ: ${added} ŸÇÿµŸäÿØÿ© ÿ¨ÿØŸäÿØÿ©\nüìã ÿπÿØÿØ ÿßŸÑŸÇÿµÿßÿ¶ÿØ ÿßŸÑŸÉŸÑŸä: ${poems.length}\n‚ú® ÿ™ŸÖ ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÇÿµÿßÿ¶ÿØ ÿ≠ÿ≥ÿ® ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä`);
        });
      });

      btnImportJSON.addEventListener('click', function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = function(e) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function(evt) {
            try {
              const data = JSON.parse(evt.target.result);
              if (!Array.isArray(data)) throw new Error('Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿßŸÑŸÖŸÑŸÅ ŸÖÿµŸÅŸàŸÅÿ©');
              const currentIds = new Set(poems.map(p => p.id));
              let added = 0;
              data.forEach(p => {
                if (!p.id) p.id = 'p-' + Date.now() + Math.random();
                if (!currentIds.has(p.id)) {
                  // Add imported by info
                  if (!p.createdBy) {
                    p.createdBy = currentUser.name + ' (ŸÖÿ≥ÿ™Ÿàÿ±ÿØ)';
                    p.userId = currentUser.id;
                    p.importedAt = new Date().toISOString();
                  }
                  poems.push({...p});
                  added++;
                }
              });
              if (added > 0) {
                savePoemsToFirebase();
                renderPoems();
              }
              showAlert(`ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ${added} ŸÇÿµŸäÿØÿ© ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅ\n\nüìù ÿ¨ŸÖŸäÿπ ÿßŸÑŸÇÿµÿßÿ¶ÿØ ÿßŸÑŸÖÿ≥ÿ™Ÿàÿ±ÿØÿ© ÿ™ÿ≠ŸÖŸÑ ÿßÿ≥ŸÖŸÉ: "${currentUser.name} (ŸÖÿ≥ÿ™Ÿàÿ±ÿØ)"`);
            } catch (err) {
              showAlert('ÿÆÿ∑ÿ£: ' + err.message);
            }
          };
          reader.readAsText(file);
        };
        input.click();
      });

      btnAdd.addEventListener('click', function() {
        editingPoem = null;
        poemForm.reset();
        currentTags = [];
        currentAudios = [];
        renderTagsInForm();
        renderAudiosInForm();
        document.getElementById('modalFormTitle').textContent = '‚úçÔ∏è ÿ£ÿ∂ŸÅ ŸÇÿµŸäÿØÿ©';
        addModal.style.display = 'flex';
      });
      
      btnCancelAdd.addEventListener('click', function() {
        editingPoem = null;
        addModal.style.display = 'none';
        poemForm.reset();
        currentTags = [];
        currentAudios = [];
        renderTagsInForm();
        renderAudiosInForm();
      });
      
      poemForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const poemData = {
          title: document.getElementById('inputTitle').value.trim() || 'ÿ®ÿØŸàŸÜ ÿπŸÜŸàÿßŸÜ',
          author: document.getElementById('inputAuthor').value.trim(),
          text: document.getElementById('inputText').value.trim(),
          excerpt: document.getElementById('inputExcerpt').value.trim(),
          tags: currentTags,
          audios: currentAudios,
          createdBy: currentUser.name,
          userId: currentUser.id,
          createdAt: new Date().toISOString()
        };
        
        if (editingPoem) {
          const index = poems.findIndex(p => p.id === editingPoem.id);
          if (index !== -1) {
            poems[index] = { ...poemData, id: editingPoem.id };
          }
          editingPoem = null;
        } else {
          poemData.id = 'p-' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          poems.unshift(poemData);
        }
        
        savePoemsToFirebase();
        renderPoems();
        addModal.style.display = 'none';
        poemForm.reset();
        currentTags = [];
        currentAudios = [];
        renderTagsInForm();
        renderAudiosInForm();
      });
    }

    // Init
    async function init() {
      checkUserProfile();
      loadHiddenPoems();
      await loadPoemsFromFirebase();
      setupFirebaseListener();
      renderPoems();
      initSortable();
      attachListeners();
      showSyncStatus('‚úÖ ŸÖÿ™ÿµŸÑ ŸÖÿπ Firebase!', 2000);
    }

    init();
  </script>
</body>
</html>
