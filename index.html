 <!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mody Poetry</title>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/9087/9087118.png">
   <style>
    :root{--bg-gradient-1:#fff8f0;--bg-gradient-2:#fef3e8;--card:#ffffff;--muted:#8b7355;--accent:#3a1f0b;--brown:#b38660;--brown-hover:#a67c52;--text:#2e1a0f;--shadow:rgba(58,31,11,0.08);--shadow-lg:rgba(58,31,11,0.12);--border:#e8dcc8;--header-dark:#e8d2bf;--header-dark-2:#d9c0a6;--success:#28a745;--danger:#dc3545;--info:#17a2b8;--warning:#ffc107}
    [data-theme="dark"]{--bg-gradient-1:#1a1a1a;--bg-gradient-2:#2d2d2d;--card:#2a2a2a;--muted:#b8a088;--accent:#f4e4d7;--brown:rgba(201,150,107, .9);--brown-hover:#e0b080;--text:#e8dcc8;--shadow:rgba(0,0,0,0.3);--shadow-lg:rgba(0,0,0,0.5);--border:#4a4a4a;--header-dark:#3a3a3a;--header-dark-2:#2a2a2a}
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow-x:hidden}
    body{font-family:'Cairo',system-ui,sans-serif;background:linear-gradient(135deg,var(--bg-gradient-1) 0%,var(--bg-gradient-2) 100%);background-attachment:fixed;color:var(--text);line-height:1.7;padding:0;transition:background 0.3s ease,color 0.3s ease}

      /* Professional Custom Scrollbar */
::-webkit-scrollbar {
  width: 12px;
  height: 12px;
}
::-webkit-scrollbar-track {
  background: var(--bg-gradient-2);
  border-radius: 10px;
  margin: 2px;
}
::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, var(--brown) 0%, var(--brown-hover) 100%);
  border-radius: 10px;
  border: 2px solid var(--bg-gradient-2);
  transition: all 0.3s ease;
}
::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(180deg, var(--brown-hover) 0%, var(--brown) 100%);
  border-color: var(--brown);
  box-shadow: 0 0 6px var(--brown);
}
::-webkit-scrollbar-thumb:active {
  background: var(--accent);
}

/* Firefox Scrollbar */
* {
  scrollbar-width: thin;
  scrollbar-color: var(--brown) var(--bg-gradient-2);
}

    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{background:linear-gradient(180deg,var(--header-dark) 0%, var(--header-dark-2) 100%);border-bottom:1px solid rgba(0,0,0,0.06);position:sticky;top:0;z-index:100;box-shadow:0 6px 28px rgba(0,0,0,0.08);transition:all 0.3s ease}
    .header-content{max-width:1200px;margin:0 auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .brand-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px;background:rgba(58,31,11,0.06);color:var(--brown);box-shadow:0 4px 12px rgba(0,0,0,0.06)}
    .brand h1{font-size:20px;font-weight:700;color:var(--accent)}
    .brand p{font-size:13px;color:var(--muted);margin-top:2px}
    nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:8px 12px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;border:1.4px solid var(--brown);background:var(--card);color:var(--text);transition:all .18s ease}
    .btn:hover{background:var(--brown);color:#fff;transform:translateY(-1px);box-shadow:0 4px 12px var(--shadow)}
.btn-primary{background:var(--brown);color:#fff;border-color:var(--brown)}
.btn-primary:hover{background:var(--brown-hover)}
    .btn-danger{background:var(--danger);color:#fff;border-color:var(--danger)}
    .btn-success{background:var(--success);color:#fff;border-color:var(--success)}
    .small{padding:6px 10px;font-size:13px}
    .icon-btn{width:36px;height:36px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:20px;position:relative;border:1.4px solid var(--brown);background:var(--card);color:var(--text)}
    .menu-container{position:relative}
.dropdown-menu{
      position:absolute;top:calc(100% + 8px);left:0;
      background:var(--card);
      border-radius:10px;
      box-shadow:0 12px 32px var(--shadow-lg);
      border:2px solid var(--brown);
      min-width:240px;
      max-width:320px;
      display:none;
      z-index:200;
      padding:8px;
      max-height:500px;
      overflow-y:auto
    }    .dropdown-menu.show{display:block}
.menu-item{
      display:flex;align-items:center;gap:10px;padding:10px 12px;
      border-radius:8px;font-size:14px;font-weight:600;color:var(--text);
      cursor:pointer;transition:all .2s ease;border:none;
      background:transparent;width:100%;text-align:right;
      border-bottom:1px solid transparent;
    }
    .menu-item:hover{
      background:rgba(139,94,60,0.15);
      border-bottom-color:var(--border);
    }

    .menu-divider{height:1px;background:var(--border);margin:6px 0}
    .hero{background:var(--card);border-radius:14px;padding:16px;margin:20px 0;box-shadow:0 8px 32px var(--shadow-lg);border:1px solid var(--border)}
    input[type="search"],input[type="text"],input[type="email"],input[type="url"],input[type="password"],textarea,select{padding:10px 12px;border-radius:8px;border:1.5px solid var(--border);font-size:15px;background:var(--card);color:var(--text);width:100%;font-family:'Cairo',sans-serif;transition:border 0.2s ease}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--brown)}
    .search-filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:12px}
    .tags-wrapper{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .tag{padding:7px 12px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;border:1.2px solid var(--border);background:var(--card);color:var(--text);transition:all .18s ease}
    .tag:hover{background:var(--brown);color:#fff;border-color:var(--brown);transform:translateY(-2px)}
    .tag.active{background:var(--brown);color:#fff;border-color:var(--brown)}
    .tag-badge{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;background:rgba(139,94,60,0.1);border:1px solid var(--brown);border-radius:8px;font-size:13px;color:var(--brown);font-weight:600}
    .tag-badge button{background:none;border:none;color:var(--brown);cursor:pointer;font-size:16px;padding:0;line-height:1;transition:transform 0.2s}
    .tag-badge button:hover{transform:scale(1.3)}
   .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-top:20px;padding-bottom:40px}
.card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 4px 16px var(--shadow);border:2px solid var(--border);transition:all .22s;position:relative;min-height:180px}
.card:hover{transform:translateY(-4px);box-shadow:0 12px 28px var(--shadow-lg);border-color:var(--brown)}
    .card-author{display:flex;align-items:center;gap:8px;margin-bottom:8px;cursor:pointer;transition:opacity 0.2s}
    .card-author:hover{opacity:0.8}
    .avatar-small{width:39px;height:39px;border-radius:50%;object-fit:cover;border:2px solid var(--brown)}
    .card h3{font-family:'Amiri',serif;margin:0 0 6px 0;color:var(--accent);font-size:20px;font-weight:700;padding-bottom:8px;border-bottom:2px solid var(--border)}
    .excerpt{font-family:'Amiri',serif;color:var(--muted);line-height:1.9;font-size:16px;min-height:56px}
    .card-footer{margin-top:10px;display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap}
    .card-indicators{display:flex;gap:8px;align-items:center;font-size:14px;color:var(--muted)}
    .card-indicators span{display:flex;align-items:center;gap:4px}
    .like-btn{background:none;border:none;cursor:pointer;font-size:20px;transition:all .2s;padding:4px 8px;border-radius:6px;display:flex;align-items:center;gap:4px}
    .like-btn:hover{background:rgba(220,53,69,0.1);transform:scale(1.1)}
    .like-btn.liked{color:var(--danger)}
    .like-count{font-size:13px;font-weight:600;color:var(--muted)}
    .card-tags{display:flex;gap:6px;flex-wrap:wrap}
    .card-tag{padding:4px 8px;border-radius:12px;font-size:12px;background:rgba(139,94,60,0.12);color:var(--brown);font-weight:700}
    /* Drag handle for cards */
    .drag-handle{
      position:absolute;top:10px;left:10px;width:22px;height:22px;border-radius:6px;
      border:1px solid var(--border);background:rgba(139,94,60,0.08);display:flex;align-items:center;justify-content:center;
      cursor:grab;font-size:14px;color:var(--muted);z-index:10
    }
    .drag-handle:active{cursor:grabbing}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;padding:20px;z-index:1200;overflow-y:auto}
.modal-inner{
  background:var(--card);
  max-width:900px;
  width:100%;
  border-radius:12px;
  padding:20px;
  max-height:90vh;
  overflow-y:auto;
  box-shadow:0 30px 60px rgba(0,0,0,.4);
  border:1px solid var(--border);
  position:relative;
  overflow-x:hidden;
}    .modal-title{font-family:'Amiri',serif;font-size:24px;margin-bottom:8px;color:var(--accent)}
    .poem-text{font-family:'Amiri',serif;white-space:pre-line;font-size:20px;line-height:2;margin-top:12px;color:var(--text);padding:15px;background:rgba(139,94,60,0.03);border-radius:8px;border-right:4px solid var(--brown)}
    .media-container{margin-top:16px;border-top:1px solid var(--border);padding-top:16px}
    .media-item{margin-bottom:12px;background:rgba(139,94,60,0.03);padding:10px;border-radius:8px;border:1px solid var(--border)}
    .media-item audio,.media-item video,.media-item iframe,.media-item img{width:100%;border-radius:6px;max-height:600px;object-fit:contain;cursor:pointer}
    .media-item video,.media-item img{max-width:800px;margin:0 auto;display:block}
    .media-item iframe{min-height:400px}
.comments-section{margin-top:20px;border-top:2px solid var(--border);padding-top:20px}
.comments-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;font-size:16px;font-weight:700;color:var(--accent)}
    .comment-form{display:flex;flex-direction:column;gap:8px;margin-bottom:20px;padding:12px;background:rgba(139,94,60,0.03);border-radius:8px;border:1px solid var(--border)}
    .comment-input{padding:10px;border-radius:6px;border:1.5px solid var(--border);font-size:14px;resize:vertical;min-height:60px;background:var(--card)}
    .comment-submit{align-self:flex-end;padding:8px 16px;background:var(--brown);color:#fff;border:none;border-radius:6px;font-weight:600;cursor:pointer;transition:all .2s}
    .comment-submit:hover{background:var(--brown-hover);transform:translateY(-1px)}
    .comments-list{display:flex;flex-direction:column;gap:12px}
    .comment{background:var(--card);padding:12px;border-radius:8px;border:1px solid var(--border)}
    .comment-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .comment-author{display:flex;align-items:center;gap:8px}
    .comment-author-name{font-weight:700;color:var(--accent);font-size:14px}
    .comment-time{font-size:12px;color:var(--muted)}
    .comment-text{font-size:14px;line-height:1.6;color:var(--text)}
    .comment-actions{margin-top:8px;display:flex;gap:8px}
    .comment-action-btn{background:none;border:none;color:var(--brown);font-size:12px;cursor:pointer;padding:4px 8px;border-radius:4px;transition:all .2s}
    .comment-action-btn:hover{background:rgba(139,94,60,0.1)}
.no-comments{text-align:center;padding:30px;color:var(--muted);font-size:14px}
    .notification-item {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .notification-item:hover {
      background: rgba(139,94,60,0.08);
    }
    .notification-item.unread {
      background: rgba(139,94,60,0.05);
      border-left: 3px solid var(--brown);
    }    .sync-status{position:fixed;bottom:20px;right:20px;padding:10px 16px;background:var(--brown);color:#fff;border-radius:8px;font-size:13px;font-weight:600;box-shadow:0 4px 12px var(--shadow-lg);z-index:1000;display:none}
    .sync-status.show{display:flex}
    .confirm-modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;padding:20px;z-index:1400}
    .confirm-modal.show{display:flex}
    .confirm-box{background:var(--card);border-radius:12px;padding:24px;max-width:450px;width:100%;box-shadow:0 20px 50px rgba(0,0,0,.4);border:1px solid var(--border)}
    .confirm-message{font-size:16px;margin-bottom:20px;line-height:1.6;white-space:pre-line}
    .confirm-buttons{display:flex;gap:10px;justify-content:flex-end}
    .error-message{color:var(--danger);font-size:13px;margin-top:4px;display:none}
    .error-message.show{display:block}
    .empty-state{margin-top:20px;padding:40px 20px;border-radius:12px;border:2px dashed var(--border);text-align:center}
    .empty-icon{font-size:48px;margin-bottom:10px}
    .audio-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .audio-item{display:flex;align-items:center;gap:8px;padding:8px;background:rgba(139,94,60,0.05);border-radius:8px;border:1px solid var(--border);font-size:13px;justify-content:space-between}
    .audio-item button{background:var(--danger);color:#fff;border:none;padding:4px 8px;border-radius:6px;cursor:pointer;font-size:12px}
    .upload-progress{margin-top:10px;padding:10px;background:rgba(74,144,226,0.1);border-radius:8px;border:1px solid #4a90e2;display:none}
    .upload-progress.show{display:block}
    .progress-bar{width:100%;height:20px;background:#e0e0e0;border-radius:10px;overflow:hidden;margin-top:8px}
    .progress-fill{height:100%;background:linear-gradient(90deg,#4a90e2,#357abd);transition:width 0.3s ease;display:flex;align-items:center;justify-content:center;color:#fff;font-size:12px;font-weight:600}

    .profile-list{display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto;margin-bottom:15px}
    .profile-item{padding:12px;background:rgba(139,94,60,0.05);border-radius:8px;cursor:pointer;transition:all .2s ease;border:2px solid transparent}
    .profile-item:hover{border-color:var(--brown);background:rgba(139,94,60,0.1)}
    .profile-item-name{font-weight:700;color:var(--accent);font-size:15px}
    .profile-item-email{font-size:12px;color:var(--muted);margin-top:2px}
    .image-preview-grid{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .image-preview-item{position:relative;width:100px;height:100px;border-radius:8px;overflow:hidden;border:2px solid var(--border)}
    .image-preview-item img{width:100%;height:100%;object-fit:cover}
    .image-preview-remove{position:absolute;top:4px;right:4px;width:24px;height:24px;border-radius:50%;background:var(--danger);color:#fff;border:none;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}
/* DM Modal - Full Screen Design */
.dm-layout {
  display: flex;
  flex-direction: column;
  height: 80vh;
  max-height: calc(100vh - 80px);
  position: relative;
}

.modal-inner.dm-modal {
  max-height: 95vh;
   max-width: 180vh;
  height: auto;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
/* Sidebar Toggle Button - Moved to header */
.dm-conversations-toggle {
  padding: 6px 10px;
  background: var(--brown);
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 14px;
  transition: all 0.2s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.dm-conversations-toggle:hover {
  background: var(--brown-hover);
  transform: scale(1.05);
}

.dm-conversations-toggle span:last-child {
  display: none;
}
/* Sidebar - Hidden by default, opens on top */
.dm-sidebar {
  position: absolute;
  top: 0;
  left: 0;
  width: 320px;
  max-height: 100%;
  border: none;

  border-radius: 10px;
  background: var(--card);
  overflow: auto;
  z-index: 1000;
  box-shadow: 0 8px 32px var(--shadow-lg);
  opacity: 0;
  transform: translateX(-20px);
  pointer-events: none;
  transition: all 0.3s ease;
}

.dm-sidebar.show {
  opacity: 1;
  transform: translateX(0);
  pointer-events: all;
}
/* Main content takes full width */
.dm-content {
  border: none;

  border-radius: 10px;
  background: var(--card);
  height: 100%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.dm-list-item {
  padding: 12px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  transition: all 0.2s;
}

.dm-list-item:hover {
  background: rgba(139,94,60,0.1);
}
.dm-messages {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 15px;
  background: rgba(139,94,60,0.02);
}
.dm-message {
  margin-bottom: 12px;
  max-width: 70%;
  position: relative;
  cursor: pointer;
  padding: 0;
  border-radius: 0;
  transition: all 0.2s;
  display: block;
  width: fit-content;
  background: transparent;
}

.dm-message:not(.me) {
  margin-right: auto;
  margin-left: 0;
  text-align: left;
}

.dm-message:not(.me):not(:has(img)):hover::after,
.dm-message:not(.me):not(:has(img)).active::after {
  content: '';
  position: absolute;
  top: 0;
  bottom: 0;
  left: 100%;
  width: 400px;
  background: rgba(139,94,60,0.04);
  z-index: -1;
  border-radius: 0 12px 12px 0;
}

.dm-message.me {
  margin-left: auto;
  margin-right: 0;
  text-align: right;
}

.dm-message.me:not(:has(img)):hover::after,
.dm-message.me:not(:has(img)).active::after {
  content: '';
  position: absolute;
  top: 0;
  bottom: 0;
  right: 100%;
  width: 400px;
  background: rgba(139,94,60,0.04);
  z-index: -1;
  border-radius: 12px 0 0 12px;
}

.dm-message .bubble {
  display: inline-block;
  padding: 10px 14px;
  border-radius: 12px;
  background: rgba(139,94,60,0.05);
  position: relative;
  word-break: break-word;
  max-width: 100%;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  transition: all 0.2s;
  z-index: 1;
}
.dm-message.me .bubble {
  background: var(--brown);
  color: #fff;
}

/* Dark mode adjustments */
[data-theme="dark"] .dm-message:not(.me) .bubble {
  background: rgba(255,255,255,0.08); /* Lighter in dark mode */
}

[data-theme="dark"] .dm-message.me .bubble {
  background: var(--brown);
  color: #fff;
}
.dm-message:hover .bubble {
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.dm-message.me:hover .bubble {
  background: var(--brown-hover);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.dm-message.active .bubble {
  box-shadow: 0 0 0 2px var(--brown), 0 4px 12px rgba(0,0,0,0.2);
}



.dm-message.active .dm-message-actions {
  display: flex;
}

.dm-action-btn {
  background: var(--card);
  border: 1px solid var(--border);
  cursor: pointer;
  font-size: 16px;
  padding: 8px 10px;
  border-radius: 6px;
  transition: all 0.2s;
  color: var(--text);
}

.dm-action-btn:hover {
  background: var(--brown);
  color: #fff;
  transform: scale(1.1);
}

.dm-reply-indicator {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 4px;
  padding: 6px 10px;
  background: rgba(139,94,60,0.05);
  border-left: 3px solid var(--brown);
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.2s;
}

.dm-reply-indicator:hover {
  background: rgba(139,94,60,0.1);
}

.dm-editing-indicator,
.dm-replying-indicator {
  background: rgba(255,193,7,0.1);
  border-left: 3px solid #ffc107;
  padding: 10px;
  border-radius: 6px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.dm-replying-indicator {
  background: rgba(139,94,60,0.08);
  border-left-color: var(--brown);
}

/* Reactions */



/* Typing indicator */
.dm-typing-indicator {
  padding: 10px 15px;
  font-size: 13px;
  color: var(--muted);
  font-style: italic;
  display: none;
  background: rgba(139,94,60,0.05);
  border-radius: 8px;
  margin: 0 15px 10px;
}

.dm-typing-indicator.show {
  display: block;
}

.dm-typing-dots {
  display: inline-block;
  animation: dmTyping 1.4s infinite;
}

@keyframes dmTyping {
  0%, 60%, 100% { opacity: 0.3; }
  30% { opacity: 1; }
}




/* Mobile responsive */
@media (max-width: 768px) {
  .dm-modal {
    max-width: 100vw;
    width: 100vw;
    max-height: 100vh;
    height: 100vh;
    border-radius: 0;
  }

  .dm-sidebar {
    width: 280px;
  }

  .dm-content {
    height: calc(100vh - 100px);
  }
}
 .dm-message-actions {
  display: none;
  position: absolute;
  background: var(--card);
  border: 2px solid var(--brown);
  border-radius: 8px;
  padding: 6px;
  gap: 6px;
  box-shadow: 0 8px 24px var(--shadow-lg);
  z-index: 100;
  flex-direction: row;
  top: 0;
}

/* Actions for opponent messages - Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± */
.dm-message:not(.me) .dm-message-actions {
  left: calc(100% - 8px);
  right: auto;
}

/* Actions for own messages - Ø±Ø³Ø§Ø¦Ù„Ùƒ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† */
.dm-message.me .dm-message-actions {
  right: calc(100% - 8px);
  left: auto;
}

.dm-message.active .dm-message-actions {
  display: flex;
}
 .dm-action-btn{background:var(--card);border:1px solid var(--border);cursor:pointer;font-size:14px;padding:6px 8px;border-radius:6px;transition:all 0.2s;color:var(--text)}
.dm-action-btn:hover{background:var(--brown);color:#fff;transform:scale(1.1)}
.dm-reply-indicator{font-size:12px;color:var(--muted);margin-bottom:4px;padding:4px 8px;background:rgba(139,94,60,0.05);border-left:2px solid var(--brown);border-radius:4px;max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dm-editing-indicator{background:rgba(255,193,7,0.1);border-left:2px solid #ffc107;padding:8px;border-radius:4px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;max-width:60px}
.dm-replying-indicator{background:rgba(139,94,60,0.08);border-left:2px solid var(--brown);padding:8px;border-radius:4px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;max-width:240px}
.dm-input {
  display: flex;
  gap: 10px;
  padding: 0px;
  border-top: 2px solid var(--border);
  background: var(--card);
  align-items: flex-end;
  width: 100%;
  box-sizing: border-box;
}

.dm-input > div {
  display: flex;
  gap: 8px;
  align-items: center;
  width: 100%;
}

.dm-input textarea {
  flex: 1;
  min-height: 40px;
  max-height: 120px;
  resize: none;
  padding: 10px 14px;
  border-radius: 8px;
  border: 0.5px solid var(--border);
  font-size: 14px;
  line-height: 1;
  overflow-y: 0;
  width: 100%;
  box-sizing: border-box;
}

.dm-input textarea:focus {
  outline: none;
  border-color: var(--brown);
}

.dm-input textarea:focus {
  outline: none;
  border-color: var(--brown);
}

.dm-input .btn {
  flex-shrink: 0;
}

/* edits */

.dm-reaction {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  background: transparent;
  border: none;
  border-radius: 12px;
  font-size: 18px;
  cursor: pointer;
  transition: all 0.2s;
}
.dm-message-reactions {
  display: flex;
  gap: 4px;
  margin-top: 4px;
  flex-wrap: wrap;
}

.dm-message.me .dm-message-reactions {
  justify-content: flex-start;
}

.dm-message:not(.me) .dm-message-reactions {
  justify-content: flex-end;
}
.dm-reaction:hover {
  background: rgba(139,94,60,0.1);
  transform: scale(1.15);
}

.dm-reaction.reacted {
  background: rgba(139,94,60,0.15);
  border: 1px solid var(--brown);
}
.dm-reaction-count {
  font-size: 11px;
  font-weight: 600;
}
.dm-typing-indicator {
  padding: 10px;
  font-size: 13px;
  color: var(--muted);
  font-style: italic;
  display: none;
}
.dm-typing-indicator.show {
  display: block;
}
.dm-typing-dots {
  display: inline-block;
  animation: dmTyping 1.4s infinite;
}
@keyframes dmTyping {
  0%, 60%, 100% { opacity: 0.3; }
  30% { opacity: 1; }
}
.dm-conversations-toggle {
  padding: 6px 6px;
  background: var(--brown);
  color: #fff;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 14px;
  transition: all 0.2s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.dm-conversations-toggle:hover {
  background: var(--brown-hover);
}
.dm-image-preview {
  max-width: 500px;
  max-height: 500px;
  width: auto;
  height: auto;
  border-radius: 8px;
  margin-top: 8px;
  cursor: pointer;
  transition: transform 0.2s;
  border: none;
  display: block;
  object-fit: contain;
  background: transparent;
}

.dm-image-preview:hover {
  transform: scale(1.02);
}


    /* UI polish overrides */
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .poem-images-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
    .poem-images-grid img { width: 100%; height: 300px; object-fit: cover; border-radius: 8px; transition: transform 0.2s ease; }
    .poem-images-grid img:hover { transform: scale(1.02); }

    .media-item video { max-height: 500px; width: auto; max-width: 100%; }
    .media-item audio { width: 100%; max-width: 600px; margin: 0 auto; display: block; }

    .profile-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 12px; margin-top: 15px; }
    .stat-item { text-align: center; padding: 12px; background: var(--card); border-radius: 10px; border: 1px solid var(--border); box-shadow: 0 2px 6px rgba(0,0,0,0.08); transition: transform 0.2s; }
    .stat-item:hover { transform: translateY(-2px); }
    .stat-number { font-size: 20px; font-weight: 700; color: var(--brown); }
    .stat-label { font-size: 13px; color: var(--muted); margin-top: 4px; display: flex; align-items: center; justify-content: center; gap: 4px; }

    .tabs { display: flex; border-bottom: 2px solid var(--border); margin-top: 20px; }
    .tab { flex: 1; padding: 10px; text-align: center; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; }
    .tab.active { border-color: var(--brown); color: var(--brown); }
    .tabs .tab span { font-weight: normal; font-size: 12px; color: var(--muted); }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Modal action menu (kebab) */

    .actions-menu-container{position:relative}
    .actions-trigger{
      background:var(--card); border:1.5px solid var(--border); color:var(--text);
      padding:6px 10px; border-radius:8px; cursor:pointer; font-size:14px; display:flex; align-items:center; gap:6px
    }
    .actions-dropdown{
      position:fixed;
      background:var(--card);
      border:2px solid var(--brown);
      border-radius:10px;
      box-shadow:0 12px 32px var(--shadow-lg);
      width:180px;
      max-height:280px;
      overflow-y:auto;
      overflow-x:hidden;
      z-index:9999;
      display:none;
      padding:4px;
    }
    .actions-dropdown.show{display:block}
.action-item{
      display:block;
      width:100%;
      padding:10px 12px;
      border-radius:6px;
      cursor:pointer;
      background:transparent;
      border:none;
      font-size:13px;
      font-weight:600;
      color:var(--text);
      text-align:right;
      transition:all 0.2s ease;
      white-space:nowrap;
      border-bottom:1px solid var(--border);
    }
    .action-item:last-child{
      border-bottom:none;
    }
    .action-item:hover{
      background:var(--brown);
      color:#fff;
    }
    @media (max-width:768px){
      .grid{grid-template-columns:1fr}
      .dropdown-menu{right:0;left:auto}
      .search-filters{grid-template-columns:1fr}
      .dm-layout{grid-template-columns:1fr}
      .dm-sidebar{height:30vh}
      .dm-content{height:50vh}
    }/* ğŸŸ¢ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ­Ø¯ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†ÙŠØ© (Love, Close, Menu) */
.icon-btn {
    background: var(--card);
    border: 1.5px solid var(--border); /* ØªÙˆØ­ÙŠØ¯ Ø³Ù…Ùƒ ÙˆÙ„ÙˆÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯ */
    color: var(--text);
    width: 40px; /* Ø­Ø¬Ù… Ù…ÙˆØ­Ø¯ */
    height: 40px; /* Ø­Ø¬Ù… Ù…ÙˆØ­Ø¯ */
    border-radius: 50%; /* Ù„Ø¬Ø¹Ù„Ù‡Ø§ Ø¯Ø§Ø¦Ø±ÙŠØ© */
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    padding: 0;
    transition: background 0.2s, border-color 0.2s;
    font-size: 20px;
}

/* Modal action menu (Menu button icon style) */
.actions-menu-container{position:relative}

/* ğŸŸ¢ ØªØ¹Ø¯ÙŠÙ„ Ø²Ø± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù„ÙŠÙƒÙˆÙ† Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¯Ø§Ø¦Ø±ÙŠØ© Ù…ØªØ·Ø§Ø¨Ù‚Ø© */
.actions-trigger.icon-btn { /* Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© icon-btn */
    padding: 0; /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ø§Ø¯ÙŠÙ†Ø¬ Ø§Ù„Ù‚Ø¯ÙŠÙ… */
    border-radius: 50%;
    /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø®Ø±Ù‰ ØªÙØ¹Ø¯Ù„ Ø¨Ø§Ù„Ù€ icon-btn ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ */
}

/* ğŸŸ¢ Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ (Ù…Ø¹ Ø§Ù„Ø¹Ø¯Ø¯) - Override Ù„Ø¬Ø¹Ù„Ù‡ Ø¨ÙŠØ¶Ø§ÙˆÙŠÙ‹Ø§ */
.like-btn-with-count {
    display: flex !important;
    align-items: center;
    justify-content: center;

    width: auto !important;
    min-width: 40px;
    height: 40px; /* ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ */
    padding: 0 8px; /* Ù…Ø³Ø§ÙØ© Ø¯Ø§Ø®Ù„ÙŠØ© Ø£ÙÙ‚ÙŠØ© */
    border-radius: 20px; /* Ù„Ø¬Ø¹Ù„Ù‡ Ø¨ÙŠØ¶Ø§ÙˆÙŠÙ‹Ø§ */

    /* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø§Ù„Ø­Ø¯ÙˆØ¯ */
    border: 1.5px solid var(--border);
    background: var(--card);
}

.like-count {
    font-size: 14px;
    margin-left: 4px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ù‚Ù„Ø¨ ÙˆØ§Ù„Ø¹Ø¯Ø¯ */
    font-weight: 600;
    color: var(--text);
    line-height: 1;
}

.like-icon {
    font-size: 16px;
    line-height: 1;
}

/* ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù€ CSS Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ .actions-dropdown Ùˆ @media ... */
/* ÙŠØ¬Ø¨ Ø£Ù„Ø§ ÙŠØªÙ… Ù…Ø³Ø­Ù‡Ø§ØŒ ÙŠØ¬Ø¨ ÙÙ‚Ø· Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„ØªÙŠ Ø¹Ø¯Ù„Ù†Ø§Ù‡Ø§ */

.mention-dropdown {
  position: absolute;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  box-shadow: 0 8px 24px var(--shadow-lg);
  max-height: 200px;
  overflow-y: auto;
  z-index: 2000;
  display: none;
}
.mention-dropdown.show { display: block; }
.mention-item {
  padding: 8px 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: background 0.2s;
}
.mention-item:hover {
  background: rgba(139,94,60,0.1);
}
.mention-item img {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  object-fit: cover;
}




/* Fix image upload preview positioning */
.dm-image-upload {
  display: none;
  gap: 8px;
  align-items: center;
  padding: 8px 12px;
  background: transparent;

  border-radius: 8px;
  margin-bottom: 8px;
  border: none;
}

.dm-image-upload img {
  border: none;
}

#dmImagePreview {
  border: none;
}
.dm-image-upload.show {
  display: flex;
}

/* Ensure proper spacing for all message elements */
.dm-message .muted {
  padding: 0 4px;
  margin-top: 4px;
}

.media-resizable {
  position: relative;
  display: inline-block;
  max-width: 100%;
  margin-bottom: 15px;
  border: 2px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
}
.media-resizable img, .media-resizable video {
  display: block;
  border-radius: 8px;
}
.media-size-controls {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 10;
}
.media-size-btn {
  background:rgba(0,0,0,0);color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:700;
}
.media-size-btn:hover {
  background: rgba(139,94,60,0.4);
  transform: scale(1.05);
}


/* Hover effects for action buttons in poem modal */
.modal-inner .icon-btn:hover {
  transform: scale(1.1);
  transition: all 0.2s ease;
}

/* Like button hover - Red heart color */
.like-btn-with-count:hover {
  background: rgba(220, 53, 69, 0.1) !important;
  border-color: var(--danger) !important;
}

.like-btn-with-count:hover .like-icon {
  transform: scale(1.2);
  filter: drop-shadow(0 0 8px rgba(220, 53, 69, 0.5));
}

/* Menu button (â˜°) hover - Brown accent */
.actions-trigger:hover {
  background: var(--brown) !important;
  color: #fff !important;
  transform: scale(1.1);
  box-shadow: 0 4px 12px var(--shadow-lg);
}

/* Close button (âœ–ï¸) hover - Red color */
#closeModal:hover {
  background: var(--danger) !important;
  color: #fff !important;
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
}


but dont alter the code of messge date

 .dm-message:not(.me) .dm-message-date {
  text-align: left;
  margin-left: 0;
  margin-right: auto;
  display: block;
}

.dm-message:not(.me) .dm-reply-indicator {
  margin-left: 0;
  margin-right: auto;
  text-align: left;
  direction: ltr;              /* force left-to-right flow */
  border-left: none;           /* remove left border */
  border-right: 3px solid var(--brown); /* put the accent on the right side */
}




/* Hide date + seen by default */
.dm-message .dm-message-footer {
  display: none !important;
}

/* Show only when parent message is active */
.dm-message.active .dm-message-footer {
  display: flex !important;
}


/* Add this to your CSS section */
.dm-message-date {
  width: 100%;
  text-align: center;
  padding: 12px 20px;
  margin: 20px 0;
  background: linear-gradient(90deg, transparent 0%, var(--border) 20%, var(--border) 80%, transparent 100%);
  color: var(--muted);
  font-size: 13px;
  font-weight: 600;
  position: relative;
  display: block;
}

.dm-message-date::before,
.dm-message-date::after {
  content: '';
  position: absolute;
  top: 50%;
  width: 100%;
  height: 1px;
  background: var(--border);
}

.dm-message-date::before {
  right: calc(100% + 10px);
}

.dm-message-date::after {
  left: calc(100% + 10px);
}

/* Override for message footer date (keep it small) */
.dm-message .dm-message-footer .dm-message-date {
  width: auto;
  padding: 0;
  margin: 0;
  background: none;
  font-weight: normal;
}

.dm-message .dm-message-footer .dm-message-date::before,
.dm-message .dm-message-footer .dm-message-date::after {
  display: none;
}

  </style>



</head>
<body>
  <header>
    <div class="header-content">
      <div class="brand">
      <div class="brand-icon">
    <img src="https://cdn-icons-png.flaticon.com/512/9087/9087118.png" alt="Brand Icon" width="32" height="32">
  </div>
        <div>
          <h1>Mody Poetry</h1>
          <p class="muted">Ù‚ØµØ§Ø¦Ø¯ Ù…ÙˆØ¯ÙŠ Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© - Ø£Ù‚Ø±Ø£ Ø´Ø§Ø±Ùƒ ÙˆØ§Ø³ØªÙ…ØªØ¹</p>
        </div>
      </div>
      <nav>
        <button class="icon-btn" id="btnThemeToggle" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù…Ø©">ğŸŒ™</button>

        <!-- Add poem: guard if not logged in -->
        <button class="btn small" id="btnAdd" title="Ø£Ø¶Ù Ù‚ØµÙŠØ¯Ø©">âœï¸ Ø£Ø¶Ù</button>

        <div class="menu-container">
          <button class="icon-btn" id="btnNotifications" title="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª">
            ğŸ””
            <span class="notification-badge" id="notifBadge" style="display:none">0</span>
          </button>
          <div class="dropdown-menu" id="notificationsMenu" style="width:380px">
            <div style="padding:10px;font-weight:700;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
              <span>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
              <button class="btn small" id="clearAllNotifications" style="padding:4px 8px;font-size:11px">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
            </div>
            <div id="notificationsList" style="max-height:400px;overflow-y:auto;padding:6px"></div>
          </div>
        </div>

        <div class="menu-container">
          <button class="icon-btn" id="btnDM" title="Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©">
            ğŸ’Œ
            <span class="notification-badge" id="dmBadge" style="display:none">0</span>
          </button>
        </div>

        <div class="menu-container">
          <button class="btn small" id="menuToggle">â˜° Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
          <div class="dropdown-menu" id="dropdownMenu">
         <button class="menu-item" id="btnMyProfile">ğŸ‘¤ Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</button>
            <button class="menu-item" id="btnFavorites">â­ Ø§Ù„Ù‚ØµØ§Ø¦Ø¯ Ø§Ù„Ù…ÙØ¶Ù„Ø©</button>
            <button class="menu-item" id="btnFollowing">ğŸ‘¥ Ø§Ù„Ù…ØªØ§Ø¨ÙØ¹ÙˆÙ†</button>
            <div class="menu-divider"></div>
            <button class="menu-item" id="btnEnableNotifications">ğŸ”” ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
            <div class="menu-divider"></div>
            <button class="menu-item" id="btnReloadAndSort">ğŸ¥³ Ø¬Ø¯ÙŠØ¯ Ù…ÙˆØ¯ÙŠ</button>
            <button class="menu-item" id="btnDownload">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ØµØ§Ø¦Ø¯</button>
            <button class="menu-item" id="btnImportJSON">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
            <div class="menu-divider"></div>
            <button class="menu-item" id="btnDeleteProfile">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù</button>
            <button class="menu-item" id="btnLogout">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <div id="syncStatus" class="sync-status"><span id="syncText">ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...</span></div>

  <div id="userInfoDisplay" style="display:none;padding:10px 20px;background:rgba(139,94,60,0.1);border-bottom:1px solid var(--border)">
    <div style="max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
      <div><span style="font-weight:600">ğŸ‘¤ Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ </span><span id="currentUserName" style="color:var(--brown)">---</span></div>
    </div>
  </div>

  <div class="container">
    <section class="hero">
      <label for="searchInput" style="display:none">Ø§Ù„Ø¨Ø­Ø«</label>
      <input id="searchInput" name="searchInput" type="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„Ù†Øµ... (Ø§Ø³ØªØ®Ø¯Ù… @Ø§Ø³Ù…_Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ø¶ØºØ· Enter Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ³Ù…)" />
      <div id="tagsWrapper" class="tags-wrapper"></div>
      <div id="activeSearchTags" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px"></div>
    </section>

    <section>
      <div id="poemGrid" class="grid"></div>
      <div id="emptyState" class="empty-state" style="display:none">
        <div class="empty-icon">ğŸ“œ</div>
        <div style="font-weight:700;margin-top:8px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ØµØ§Ø¦Ø¯</div>
        <div class="muted" style="margin-top:6px">Ø§Ø¶ØºØ· "Ø£Ø¶Ù" Ù„Ø¥Ø¶Ø§ÙØ© Ù‚ØµÙŠØ¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
      </div>
    </section>

    <!-- Auth modal -->
    <div id="authModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:1500;align-items:center;justify-content:center;padding:20px">
      <div style="background:var(--card);border-radius:12px;padding:20px;max-width:450px;width:100%;box-shadow:0 20px 50px rgba(0,0,0,.25);border:1px solid var(--border)">
        <h3 style="margin:0 0 15px 0">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h3>
        <div class="tabs" style="border-bottom:2px solid var(--border);margin-bottom:15px;display:flex;gap:8px">
          <button class="tab active" id="tabLogin">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
          <button class="tab" id="tabSignup">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        </div>
        <div id="loginForm">
          <div id="loginProfilesList" class="profile-list" style="max-height:250px"></div>
          <div style="margin-top:15px;text-align:center;color:var(--muted);font-size:13px">Ø§Ø®ØªØ± Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¹Ù„Ø§Ù‡</div>
        </div>
        <div id="signupForm" style="display:none">
          <div style="display:flex;flex-direction:column;gap:10px">
            <label for="signupUsername" style="font-size:14px;font-weight:600">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… *</label>
            <input id="signupUsername" name="signupUsername" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ±ÙŠØ¯Ø§Ù‹)" required autocomplete="username" />
            <div id="usernameError" class="error-message">âš ï¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„! ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø¢Ø®Ø±.</div>

            <label for="signupPassword" style="font-size:14px;font-weight:600">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *</label>
            <input id="signupPassword" name="signupPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" required autocomplete="new-password" />
            <div id="passwordError" class="error-message">âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)</div>

            <label for="signupEmail" style="font-size:14px;font-weight:600">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="signupEmail" name="signupEmail" type="email" placeholder="Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" autocomplete="email" />

            <label for="signupBio" style="font-size:14px;font-weight:600">Ù†Ø¨Ø°Ø© Ø¹Ù†Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <textarea id="signupBio" name="signupBio" placeholder="Ù†Ø¨Ø°Ø© Ø¹Ù†Ùƒ" style="min-height:80px"></textarea>

            <button class="btn" id="btnSignup">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
          </div>
        </div>
        <div id="passwordForm" style="display:none">
          <div style="margin-bottom:15px">
            <button class="btn small" id="btnBackToProfiles">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
          </div>
          <div style="display:flex;flex-direction:column;gap:10px">
            <div style="font-weight:600;color:var(--accent)">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ€: <span id="loginUserName"></span></div>
            <input id="loginPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *" required />
            <div id="loginPasswordError" class="error-message">âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!</div>
            <button class="btn" id="btnLoginSubmit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add/Edit poem modal -->
    <div id="addModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:1300;align-items:center;justify-content:center;padding:20px">
      <div style="background:var(--card);border-radius:12px;padding:16px;max-width:720px;width:100%;box-shadow:0 20px 50px rgba(0,0,0,.25);border:1px solid var(--border);max-height:90vh;overflow-y:auto">
        <h3 style="margin:0 0 10px 0" id="modalFormTitle">âœï¸ Ø£Ø¶Ù Ù‚ØµÙŠØ¯Ø©</h3>
        <form id="poemForm">
          <div style="display:flex;flex-direction:column;gap:8px">
            <label for="inputTitle" style="font-size:14px;font-weight:600;margin-bottom:4px">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚ØµÙŠØ¯Ø© *</label>
            <input id="inputTitle" name="poemTitle" type="text" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚ØµÙŠØ¯Ø©" required />

            <label for="inputAuthor" style="font-size:14px;font-weight:600;margin-bottom:4px">Ø§Ù„Ù…Ø¤Ù„Ù / Ø§Ù„Ø±Ø§ÙˆÙŠ</label>
            <input id="inputAuthor" name="poemAuthor" type="text" placeholder="Ø§Ù„Ù…Ø¤Ù„Ù / Ø§Ù„Ø±Ø§ÙˆÙŠ" />

            <label for="inputText" style="font-size:14px;font-weight:600;margin-bottom:4px">Ù†Øµ Ø§Ù„Ù‚ØµÙŠØ¯Ø© *</label>
            <textarea id="inputText" name="poemText" placeholder="Ù†Øµ Ø§Ù„Ù‚ØµÙŠØ¯Ø©" required style="min-height:140px;font-family:Amiri,serif"></textarea>

            <label for="inputExcerpt" style="font-size:14px;font-weight:600;margin-bottom:4px">Ù…Ù‚ØªØ·Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="inputExcerpt" name="poemExcerpt" type="text" placeholder="Ù…Ù‚ØªØ·Ù" />

            <label style="display:block;margin-bottom:6px;font-size:14px;font-weight:600">Ø§Ù„ÙˆØ³ÙˆÙ… (Ø§Ø¶ØºØ· Enter)</label>
            <div id="tagsDisplay" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px"></div>
            <input id="inputTagField" type="text" placeholder="Ø§ÙƒØªØ¨ ÙˆØ³Ù… ÙˆØ§Ø¶ØºØ· Enter" />
          </div>

          <div>
            <label style="display:block;margin-bottom:6px;font-size:14px;font-weight:600">ğŸ–¼ï¸ Ø§Ù„ØµÙˆØ±</label>
            <input type="file" id="inputImages" accept="image/*" multiple style="font-size:13px" />
            <div id="imagesPreview" class="image-preview-grid"></div>
          </div>

          <div>
            <label style="display:block;margin-bottom:6px;font-size:14px;font-weight:600">ğŸ¤ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· (Ø£ØºØ§Ù†ÙŠ / ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª)</label>
            <div id="audioDisplay" class="audio-list"></div>
            <div style="margin-top:8px"><input type="file" id="inputAudioFile" accept="audio/*,video/*" multiple style="font-size:13px" /></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="inputAudioLink" type="url" placeholder="Ø£Ùˆ Ø§Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· (YouTube, SoundCloud, Ø¥Ù„Ø®)" style="flex:1" />
              <button type="button" id="btnAddAudioLink" class="btn small">â• Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <div id="uploadProgress" class="upload-progress">
              <div id="uploadText" style="font-size:13px;font-weight:600;color:#4a90e2">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...</div>
              <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width:0%">0%</div></div>
            </div>
            <div style="margin-top:6px;font-size:12px;color:var(--muted)">ğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ø±ÙˆØ§Ø¨Ø·</div>
          </div>

          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button type="button" class="btn" id="btnCancelAdd">Ø¥Ù„ØºØ§Ø¡</button>
            <button type="submit" class="btn">Ù†Ø´Ø± Ø§Ù„Ù‚ØµÙŠØ¯Ø© ğŸ“¤</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Confirm modal -->
    <div id="confirmModal" class="confirm-modal">
      <div class="confirm-box">
        <div id="confirmMessage" class="confirm-message"></div>
        <div class="confirm-buttons" id="confirmButtons"></div>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL, deleteObject, listAll } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
    import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js';

  const app = initializeApp({
      apiKey: "AIzaSyANYJJ3gTxEgeaj731npdx37OHd4Xf3t70",
      authDomain: "modypoems.firebaseapp.com",
      databaseURL: "https://modypoems-default-rtdb.firebaseio.com",
      projectId: "modypoems",
      storageBucket: "modypoems.firebasestorage.app",
      messagingSenderId: "805060440847",
      appId: "1:805060440847:web:bc4f89cd351c9c244f447a"
    });

    const database = getDatabase(app);
    const storage = getStorage(app);
    const messaging = getMessaging(app);

    const FCM_VAPID_KEY = 'BH1rxDUeea6grr0gIXTI19kSWTMa50nHwu-GIShvIBKBndborG647a1A4xnHJ8KjB8iQkn5SuLbIOKdm_PXqIV8';

    const USER_KEY = 'mody_current_user';
    const HIDDEN_KEY_PREFIX = 'mody_hidden_poems';
    const ALL_USERS_KEY = 'mody_all_users';
    const FAVORITES_KEY = 'mody_favorites';
    const FOLLOWING_KEY = 'mody_following';
    const THEME_KEY = 'mody_theme';

    let poems = [];
    let hiddenPoems = [];
    let allUsers = [];
    let favorites = [];
    let following = [];
    let notifications = [];
    let isDragging = false;
    let activeSearchTags = [];
    let editingPoem = null;
    let currentTags = [];
    let currentAudios = [];
    let currentImages = [];
    let currentUser = null;
    let dmMessagesLimit = 10;
    let allDMMessages = [];
    let isLoadingMoreMessages = false;
    let isUpdatingFromFirebase = false;
    let selectedUserForLogin = null;

    let isRendering = false;


    function initTheme() {
      const savedTheme = localStorage.getItem(THEME_KEY) || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      const btn = document.getElementById('btnThemeToggle');
      btn.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
      btn.title = savedTheme === 'dark' ? 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ' : 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ';
    }
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem(THEME_KEY, newTheme);
      const btn = document.getElementById('btnThemeToggle');
      btn.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
      btn.title = newTheme === 'dark' ? 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ' : 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ';
    }
    document.getElementById('btnThemeToggle').addEventListener('click', toggleTheme);
    initTheme();

    function hashPassword(password) {
      let hash = 0;
      for (let i = 0; i < password.length; i++) {
        const char = password.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return Math.abs(hash).toString(36);
    }

    async function loadAllUsersFromFirebase() {
      try {
        const snapshot = await get(ref(database, 'users'));
        if (snapshot.exists()) {
          const users = snapshot.val();
          allUsers = Object.values(users);
          saveAllUsers();
        }
      } catch (error) { console.error('Error loading users:', error); }
    }
    function loadAllUsers() {
      const stored = localStorage.getItem(ALL_USERS_KEY);
      if (stored) { try { allUsers = JSON.parse(stored); } catch { allUsers = []; } }
    }
    function saveAllUsers() { localStorage.setItem(ALL_USERS_KEY, JSON.stringify(allUsers)); }
    function checkUserNameExists(username, excludeId = null) {
      return allUsers.some(u => u.username.toLowerCase().trim() === username.toLowerCase().trim() && u.id !== excludeId);
    }

    function loadFavorites() {
      if (!currentUser) return;
      const key = FAVORITES_KEY + '_' + currentUser.id;
      const stored = localStorage.getItem(key);
      if (stored) { try { favorites = JSON.parse(stored); } catch { favorites = []; } }
    }
    function saveFavorites() {
      if (!currentUser) return;
      const key = FAVORITES_KEY + '_' + currentUser.id;
      localStorage.setItem(key, JSON.stringify(favorites));
    }
    function toggleFavorite(poemId) {
      const index = favorites.indexOf(poemId);
      if (index > -1) { favorites.splice(index, 1); showSyncStatus('âŒ ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‚ØµÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©', 2000); }
      else { favorites.push(poemId); showSyncStatus('â­ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚ØµÙŠØ¯Ø© Ù„Ù„Ù…ÙØ¶Ù„Ø©', 2000); }
      saveFavorites();
    }
    function isFavorite(poemId) { return favorites.includes(poemId); }

    function loadFollowing() {
      if (!currentUser) return;
      const key = FOLLOWING_KEY + '_' + currentUser.id;
      const stored = localStorage.getItem(key);
      if (stored) { try { following = JSON.parse(stored); } catch { following = []; } }
    }
    function saveFollowing() {
      if (!currentUser) return;
      const key = FOLLOWING_KEY + '_' + currentUser.id;
      localStorage.setItem(key, JSON.stringify(following));
    }
    function toggleFollow(userId) {
      const index = following.indexOf(userId);
      if (index > -1) { following.splice(index, 1); showSyncStatus('ğŸ‘‹ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©', 2000); }
      else { following.push(userId); showSyncStatus('âœ… ØªÙ…Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­', 2000); }
      saveFollowing();
    }
    function isFollowing(userId) { return following.includes(userId); }

    function loadHiddenPoems() {
      if (!currentUser) return;
      const key = HIDDEN_KEY_PREFIX + '_' + currentUser.id;
      const stored = localStorage.getItem(key);
      if (stored) { try { hiddenPoems = JSON.parse(stored); } catch { hiddenPoems = []; } }
    }
    function saveHiddenPoems() {
      if (!currentUser) return;
      const key = HIDDEN_KEY_PREFIX + '_' + currentUser.id;
      localStorage.setItem(key, JSON.stringify(hiddenPoems));
    }
    function isPoemHidden(poemId) { return hiddenPoems.includes(poemId); }
    function toggleHidePoem(poemId) {
      const index = hiddenPoems.indexOf(poemId);
      if (index > -1) hiddenPoems.splice(index, 1); else hiddenPoems.push(poemId);
      saveHiddenPoems();
    }
    function isOwnPoem(poem) { return poem.userId === currentUser.id; }
    function isOriginalModyPoem(poem) { return !poem.userId && !poem.createdBy; }

    async function toggleLike(poemId) {
      try {
        const likesRef = ref(database, `likes/${poemId}`);
        const snapshot = await get(likesRef);
        let likes = snapshot.exists() ? snapshot.val() : {};
        if (likes[currentUser.id]) { delete likes[currentUser.id]; }
        else {
          likes[currentUser.id] = { username: currentUser.username, timestamp: new Date().toISOString() };
          const poem = poems.find(p => p.id === poemId);
          if (poem && poem.userId && poem.userId !== currentUser.id) {
            await addNotification(poem.userId, { type: 'like', from: currentUser.username, fromId: currentUser.id, poemId, poemTitle: poem.title, timestamp: new Date().toISOString() });
          }
        }
        await set(likesRef, likes);
        return Object.keys(likes).length;
      } catch (error) { console.error('Error toggling like:', error); return 0; }
    }
    async function getLikesCount(poemId) {
      try {
        const snapshot = await get(ref(database, `likes/${poemId}`));
        if (snapshot.exists()) return Object.keys(snapshot.val()).length;
        return 0;
      } catch { return 0; }
    }
    async function isLiked(poemId) {
      try { const snapshot = await get(ref(database, `likes/${poemId}/${currentUser.id}`)); return snapshot.exists(); }
      catch { return false; }
    }
// Register Service Worker and get FCM token
async function registerServiceWorkerAndGetToken() {
  try {
    // Check if we're on a secure context (https or localhost)
    if (window.location.protocol === 'file:') {
      console.warn('âš ï¸ Service Worker not supported on file:// URLs. FCM notifications will not work.');
      return null;
    }

    if ('serviceWorker' in navigator) {
      const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
      console.log('Service Worker registered:', registration);

      const token = await getToken(messaging, {
        vapidKey: FCM_VAPID_KEY,
        serviceWorkerRegistration: registration
      });

      if (token) {
        console.log('FCM Token:', token);
        // Save token to user profile
        if (currentUser) {
          currentUser.fcmToken = token;
          await set(ref(database, `users/${currentUser.id}/fcmToken`), token);
          localStorage.setItem(USER_KEY, JSON.stringify(currentUser));
        }
        return token;
      }
    }
  } catch (error) {
    console.warn('âš ï¸ FCM not available:', error.message);
    // Fail silently - app will work without FCM
  }
  return null;
}
    // Listen for foreground messages
    onMessage(messaging, (payload) => {
      console.log('Foreground message received:', payload);

      const title = payload.notification?.title || 'Mody Poetry';
      const body = payload.notification?.body || 'Ù„Ø¯ÙŠÙƒ Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯';

      showBrowserNotification(title, body, payload.data || {});
    });

    // Handle messages from service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'NOTIFICATION_CLICK') {
          const data = event.data.data;

          if (data.poemId) {
            const poem = poems.find(p => p.id === data.poemId);
            if (poem) openModal(poem);
          } else if (data.fromId) {
            if (data.type === 'message') {
              openDMWindow(data.fromId);
            } else if (data.type === 'follow') {
              openUserProfile(data.fromId);
            }
          }
        }
      });
    }

    // Browser Notification Support (enhanced with FCM)
    async function requestNotificationPermission() {
      if (!('Notification' in window)) {
        console.log('This browser does not support notifications');
        return false;
      }

      if (Notification.permission === 'granted') {
        await registerServiceWorkerAndGetToken();
        return true;
      }

      if (Notification.permission !== 'denied') {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          await registerServiceWorkerAndGetToken();
          return true;
        }
      }

      return false;
    }


function showBrowserNotification(title, body, data = {}) {
  if (!('Notification' in window) || Notification.permission !== 'granted') {
    return;
  }


  const options = {
    body: body,
    icon: 'https://cdn-icons-png.flaticon.com/512/9087/9087118.png',
    badge: 'https://cdn-icons-png.flaticon.com/512/9087/9087118.png',
    tag: data.id || 'mody-poetry',
    requireInteraction: false,
    silent: false,
    vibrate: [200, 100, 200],
    data: data
  };

  const notification = new Notification(title, options);

  notification.onclick = function(event) {
    event.preventDefault();
    window.focus();
    notification.close();

    if (data.poemId) {
      const poem = poems.find(p => p.id === data.poemId);
      if (poem) openModal(poem);
    } else if (data.fromId) {
      if (data.type === 'message') {
        openDMWindow(data.fromId);
      } else if (data.type === 'follow') {
        openUserProfile(data.fromId);
      }
    }
  };

  setTimeout(() => notification.close(), 8000);
}

    async function addNotification(userId, notification)   {
  try {
    const notifId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);

    // Ø­ÙØ¸ ÙÙŠ Database
    await set(ref(database, `notifications/${userId}/${notifId}`), {
      ...notification,
      id: notifId,
      read: false
    });

    // Ø¬Ù„Ø¨ FCM Token Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const targetUserSnapshot = await get(ref(database, `users/${userId}/fcmToken`));
    const fcmToken = targetUserSnapshot.exists() ? targetUserSnapshot.val() : null;

    if (!fcmToken) {
      console.log('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ FCM Token');
      return;
    }

    // ØªØ­Ø¶ÙŠØ± Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
    let title = 'Mody Poetry';
    let body = '';

    if (notification.type === 'like') {
      title = 'Ø¥Ø¹Ø¬Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ â¤ï¸';
      body = `${notification.from} Ø£Ø¹Ø¬Ø¨ Ø¨Ù‚ØµÙŠØ¯ØªÙƒ "${notification.poemTitle}"`;
    } else if (notification.type === 'comment') {
      title = 'ØªØ¹Ù„ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯ ğŸ’¬';
      body = `${notification.from} Ø¹Ù„Ù‚ Ø¹Ù„Ù‰ Ù‚ØµÙŠØ¯ØªÙƒ "${notification.poemTitle}"`;
    } else if (notification.type === 'follow') {
      title = 'Ù…ØªØ§Ø¨Ø¹ Ø¬Ø¯ÙŠØ¯ ğŸ‘¥';
      body = `${notification.from} Ø¨Ø¯Ø£ Ø¨Ù…ØªØ§Ø¨Ø¹ØªÙƒ`;
    } else if (notification.type === 'mention') {
      title = 'Ø°ÙƒØ±Ùƒ ÙÙŠ ØªØ¹Ù„ÙŠÙ‚ ğŸ“¢';
      body = `${notification.from} Ø°ÙƒØ±Ùƒ ÙÙŠ ØªØ¹Ù„ÙŠÙ‚`;
    } else if (notification.type === 'message') {
      title = 'Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸ’Œ';
      body = `${notification.from}: ${notification.messagePreview}`;
    } else if (notification.type === 'new_poem') {
      title = 'Ù‚ØµÙŠØ¯Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸª¶';
      body = `${notification.from} Ù†Ø´Ø± Ù‚ØµÙŠØ¯Ø© Ø¬Ø¯ÙŠØ¯Ø© "${notification.poemTitle}"`;
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± FCM Ù…Ø¨Ø§Ø´Ø±Ø©
    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ù…ÙØªÙˆØ­
    // Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø©ØŒ Ù†Ø­ØªØ§Ø¬ Server-side API

    // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ù…Ø­Ù„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ Ø§Ù„Ø­Ø§Ù„ÙŠ
    if (currentUser && userId === currentUser.id) {
      showBrowserNotification(title, body, notification);
    }

  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:', error);
  }
}
 async function loadNotifications() {
      if (!currentUser) return;
      try {
        const snapshot = await get(ref(database, `notifications/${currentUser.id}`));
        if (snapshot.exists()) {
          const newNotifications = Object.values(snapshot.val());

          // Check for new unread notifications and show browser notifications
          if (notifications.length > 0) {
            newNotifications.forEach(notif => {
              const existing = notifications.find(n => n.id === notif.id);
              if (!existing || (!existing.read && notif.read === false)) {
                // This is a new notification or still unread
                let title = 'Mody Poetry';
                let body = '';

                if (notif.type === 'like') {
                  title = 'Ø¥Ø¹Ø¬Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ â¤ï¸';
                  body = `${notif.from} Ø£Ø¹Ø¬Ø¨ Ø¨Ù‚ØµÙŠØ¯ØªÙƒ "${notif.poemTitle}"`;
                } else if (notif.type === 'comment') {
                  title = 'ØªØ¹Ù„ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯ ğŸ’¬';
                  body = `${notif.from} Ø¹Ù„Ù‚ Ø¹Ù„Ù‰ Ù‚ØµÙŠØ¯ØªÙƒ "${notif.poemTitle}"`;
                } else if (notif.type === 'follow') {
                  title = 'Ù…ØªØ§Ø¨Ø¹ Ø¬Ø¯ÙŠØ¯ ğŸ‘¥';
                  body = `${notif.from} Ø¨Ø¯Ø£ Ø¨Ù…ØªØ§Ø¨Ø¹ØªÙƒ`;
                } else if (notif.type === 'mention') {
                  title = 'Ø°ÙƒØ±Ùƒ ÙÙŠ ØªØ¹Ù„ÙŠÙ‚ ğŸ“¢';
                  body = `${notif.from} Ø°ÙƒØ±Ùƒ ÙÙŠ ØªØ¹Ù„ÙŠÙ‚`;
                } else if (notif.type === 'message') {
                  title = 'Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸ’Œ';
                  body = `${notif.from}: ${notif.messagePreview}`;
                } else if (notif.type === 'new_poem') {
                  title = 'Ù‚ØµÙŠØ¯Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸª¶';
                  body = `${notif.from} Ù†Ø´Ø± Ù‚ØµÙŠØ¯Ø© Ø¬Ø¯ÙŠØ¯Ø© "${notif.poemTitle}"`;
                }

                if (!existing && !notif.read) {
                  showBrowserNotification(title, body, notif);
                }
              }
            });
          }

          notifications = newNotifications;
          renderNotifications();
          updateNotificationBadge();
        }
      } catch (error) { console.error('Error loading notifications:', error); }
    }
    function renderNotifications() {
      const container = document.getElementById('notificationsList');
      container.innerHTML = '';
      if (notifications.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>';
        return;
      }
      notifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      notifications.forEach(notif => {
        const div = document.createElement('div');
        div.className = 'notification-item' + (notif.read ? '' : ' unread');
        let icon = 'ğŸ””', text = '';
        if (notif.type === 'like') { icon = 'â¤ï¸'; text = `${notif.from} Ø£Ø¹Ø¬Ø¨ Ø¨Ù‚ØµÙŠØ¯ØªÙƒ "${notif.poemTitle}"`; }
        else if (notif.type === 'comment') { icon = 'ğŸ’¬'; text = `${notif.from} Ø¹Ù„Ù‚ Ø¹Ù„Ù‰ Ù‚ØµÙŠØ¯ØªÙƒ "${notif.poemTitle}"`; }
        else if (notif.type === 'follow') { icon = 'ğŸ‘¥'; text = `${notif.from} Ø¨Ø¯Ø£ Ø¨Ù…ØªØ§Ø¨Ø¹ØªÙƒ`; }
        else if (notif.type === 'mention') { icon = 'ğŸ“¢'; text = `${notif.from} Ø°ÙƒØ±Ùƒ ÙÙŠ ØªØ¹Ù„ÙŠÙ‚`; }
        else if (notif.type === 'message') { icon = 'ğŸ’Œ'; text = `${notif.from} Ø£Ø±Ø³Ù„ Ù„Ùƒ Ø±Ø³Ø§Ù„Ø©: "${notif.messagePreview}"`; }
        else if (notif.type === 'new_poem') { icon = 'ğŸª¶'; text = `${notif.from} Ù†Ø´Ø± Ù‚ØµÙŠØ¯Ø© Ø¬Ø¯ÙŠØ¯Ø© "${notif.poemTitle}"`; }

    div.innerHTML = `
          <div class="notification-content" style="flex:1;display:flex;align-items:center;gap:10px">
            <span style="font-size:20px">${icon}</span>
            <div class="notification-text" style="flex:1">${text}</div>
            <div class="notification-time" style="font-size:12px;color:var(--muted)">${formatTimeAgo(notif.timestamp)}</div>
          </div>
          <button class="icon-btn" style="width:28px;height:28px;font-size:16px;flex-shrink:0" title="Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±" onclick="event.stopPropagation();window.deleteNotification('${notif.id}')">Ã—</button>
        `;
        div.onclick = async () => {
          if (!notif.read) await markNotificationAsRead(notif.id);
          if (notif.poemId) {
            const poem = poems.find(p => p.id === notif.poemId);
            if (poem) openModal(poem);
          } else if (notif.type === 'follow' && notif.fromId) {
            openUserProfile(notif.fromId);
          } else if (notif.type === 'message' && notif.fromId) {
            openDMWindow(notif.fromId);
          }
          document.getElementById('notificationsMenu').classList.remove('show');
        };
        container.appendChild(div);
      });
    }
    window.deleteNotification = async function(notifId) {
      try {
        await set(ref(database, `notifications/${currentUser.id}/${notifId}`), null);
        notifications = notifications.filter(n => n.id !== notifId);
        renderNotifications();
        updateNotificationBadge();
        showSyncStatus('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±', 1500);
      } catch (error) { console.error('Error deleting notification:', error); }
    };
    document.getElementById('clearAllNotifications').addEventListener('click', async () => {
      showConfirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§ØªØŸ', async () => {
        try {
          await set(ref(database, `notifications/${currentUser.id}`), null);
          notifications = [];
          renderNotifications();
          updateNotificationBadge();
          showSyncStatus('âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 2000);
          document.getElementById('notificationsMenu').classList.remove('show');
        } catch { showAlert('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª'); }
      });
    });
    async function markNotificationAsRead(notifId) {
      try { await set(ref(database, `notifications/${currentUser.id}/${notifId}/read`), true);
        const notif = notifications.find(n => n.id === notifId); if (notif) notif.read = true; updateNotificationBadge();
      } catch (error) { console.error('Error marking notification as read:', error); }
    }
    function updateNotificationBadge() {
      const unreadCount = notifications.filter(n => !n.read).length;
      const badge = document.getElementById('notifBadge');
      if (unreadCount > 0) { badge.textContent = unreadCount; badge.style.display = 'flex'; }
      else badge.style.display = 'none';
    }

    // DM System
// DM System
    let dmConversations = [];
    let editingMessageId = null;
    let replyingToMessage = null;
// Real-time unsubscribe for current conversation messages
let dmMessagesUnsubscribe = null;



function getConversationId(userA, userB) { return [userA, userB].sort().join('_'); }

// Helper to build message element - MOVED TO GLOBAL SCOPE
function buildMessageElement(m, convId, withUser, allMessages) {
  const div = document.createElement('div');
  div.className = 'dm-message' + (m.fromId === currentUser.id ? ' me' : '');
  div.dataset.messageId = m.id;
  div.dataset.conversationId = convId;
  div.id = 'msg-' + m.id;

  let replyHtml = '';
  if (m.replyTo) {
    const replyMsg = allMessages.find(x => x.id === m.replyTo);
    if (replyMsg) {
      const replyFromMe = replyMsg.fromId === currentUser.id;
      const replyAuthor = replyFromMe ? 'Ø£Ù†Øª' : withUser?.username || 'Ù…Ø³ØªØ®Ø¯Ù…';
      const replyText = replyMsg.text?.substring(0, 30) || (replyMsg.imageUrl ? 'ğŸ–¼ï¸ ØµÙˆØ±Ø©' : '');
      replyHtml = `<div class="dm-reply-indicator" onclick="(function(){ const el = document.getElementById('msg-${m.replyTo}'); if(el){ el.scrollIntoView({behavior:'smooth',block:'center'}); el.style.boxShadow='0 0 0 3px var(--brown)'; setTimeout(()=>el.style.boxShadow='', 2000); } })()">â†©ï¸ Ø±Ø¯ Ø¹Ù„Ù‰ ${replyAuthor}: ${escapeHtml(replyText)}${(replyMsg.text?.length || 0) > 30 ? '...' : ''}</div>`;
    }
  }

  const editedLabel = m.edited ? '<span style="font-size:10px;color:#ffc107;font-weight:600;margin-left:4px"><br> (Ù…Ø¹Ø¯Ù‘Ù„) </span>' : '';

  let mediaHtml = '';
  if (m.imageUrl) {
    const fileType = m.fileType || '';
    const mediaId = 'dm-media-' + m.id;
    if (fileType.startsWith('video/')) {
      mediaHtml = `<div style="position:relative;border:2px solid var(--border);border-radius:8px;overflow:hidden;display:inline-block;margin-top:8px;max-width:100%"><div style="position:absolute;top:8px;right:8px;z-index:10"><button onclick="window.resizeMedia('${mediaId}')" class="media-size-btn">ğŸ”</button></div><video id="${mediaId}" controls style="width:300px;height:auto;max-width:100%;display:block;border-radius:8px"><source src="${m.imageUrl}" type="${fileType}"></video></div>`;
    } else if (fileType.startsWith('audio/')) {
      mediaHtml = `<audio controls style="max-width:100%;margin-top:8px"><source src="${m.imageUrl}" type="${fileType}"></audio>`;
    } else {
      mediaHtml = `<div style="position:relative;border:2px solid var(--border);border-radius:8px;overflow:hidden;display:inline-block;margin-top:8px;max-width:100%"><div style="position:absolute;top:8px;right:8px;z-index:10"><button onclick="window.resizeMedia('${mediaId}')" class="media-size-btn">ğŸ”</button></div><img id="${mediaId}" src="${m.imageUrl}" onclick="window.open('${m.imageUrl}','_blank')" style="cursor:pointer;width:300px;height:auto;max-width:100%;display:block;border-radius:8px"></div>`;
    }
  }

  let textHtml = '';
  if (m.text && m.text.trim()) {
    const links = extractLinks(m.text);
    let processedText = escapeHtml(m.text);
    links.forEach(link => {
      const escapedLink = escapeHtml(link);
      processedText = processedText.replace(escapedLink, `<a href="${link}" target="_blank" style="color:var(--brown);text-decoration:underline;word-break:break-all">${escapedLink}</a>`);
    });
    textHtml = `<div class="bubble">${processedText}${editedLabel}</div>`;
    if (links.length > 0) {
      links.forEach(link => {
        const preview = renderLinkPreview(link);
        if (preview && !preview.startsWith('<a href')) textHtml += preview;
      });
    }
  }

  let reactionsHtml = '';
  if (m.reactions && Object.keys(m.reactions).length > 0) {
    const reactionCounts = {};
    Object.values(m.reactions).forEach(r => {
      reactionCounts[r.emoji] = (reactionCounts[r.emoji] || 0) + 1;
    });
    reactionsHtml = '<div class="dm-message-reactions">';
    for (const [emoji, count] of Object.entries(reactionCounts)) {
      const hasReacted = m.reactions[currentUser.id]?.emoji === emoji;
      reactionsHtml += `<span class="dm-reaction ${hasReacted ? 'reacted' : ''}" onclick="window.toggleReaction('${convId}','${m.id}','${emoji}')">${emoji} <span class="dm-reaction-count">${count}</span></span>`;
    }
    reactionsHtml += '</div>';
  }

  const readIcon = m.fromId === currentUser.id ? `<span style="font-size:10px;margin-left:8px;color:${m.read ? '#4a90e2' : 'var(--muted)'}">${m.read ? 'âœ“âœ“' : 'âœ“'}</span>` : '';

  div.innerHTML = `${replyHtml}${textHtml}${mediaHtml}${reactionsHtml}<div class="dm-message-footer" style="font-size:11px;margin-top:4px;display:flex;align-items:center;gap:0px">${readIcon}<span class="dm-message-date">${formatTimeAgo(m.timestamp)}</span></div>${m.fromId === currentUser.id ? `<div class="dm-message-actions"><button class="dm-action-btn" onclick="window.dmReact('${m.id}')" title="ØªÙØ§Ø¹Ù„">ğŸ˜Š</button><button class="dm-action-btn" onclick="window.replyToMessage('${m.id}')" title="Ø±Ø¯">â†©ï¸</button><button class="dm-action-btn" onclick="window.editMessage('${m.id}')" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button><button class="dm-action-btn" onclick="window.deleteMessage('${convId}', '${m.id}')" title="Ø­Ø°Ù">ğŸ—‘ï¸</button></div>` : `<div class="dm-message-actions"><button class="dm-action-btn" onclick="window.dmReact('${m.id}')" title="ØªÙØ§Ø¹Ù„">ğŸ˜Š</button><button class="dm-action-btn" onclick="window.replyToMessage('${m.id}')" title="Ø±Ø¯">â†©ï¸</button></div>`}`;

  div.addEventListener('click', function(e) {
    if (e.target.closest('.dm-message-actions')) return;
    if (e.target.tagName === 'A' || e.target.tagName === 'IFRAME') return;
    document.querySelectorAll('.dm-message.active').forEach(msg => {
      if (msg !== div) msg.classList.remove('active');
    });
    div.classList.toggle('active');
  });

  return div;
}

// Helper to update existing message
function updateMessageElement(div, m, convId, allMessages) {
  const existingReactions = div.querySelector('.dm-message-reactions');
  let newReactionsHtml = '';

  if (m.reactions && Object.keys(m.reactions).length > 0) {
    const reactionCounts = {};
    Object.values(m.reactions).forEach(r => {
      reactionCounts[r.emoji] = (reactionCounts[r.emoji] || 0) + 1;
    });
    newReactionsHtml = '<div class="dm-message-reactions">';
    for (const [emoji, count] of Object.entries(reactionCounts)) {
      const hasReacted = m.reactions[currentUser.id]?.emoji === emoji;
      newReactionsHtml += `<span class="dm-reaction ${hasReacted ? 'reacted' : ''}" onclick="window.toggleReaction('${convId}','${m.id}','${emoji}')">${emoji} <span class="dm-reaction-count">${count}</span></span>`;
    }
    newReactionsHtml += '</div>';
  }

  if (existingReactions) {
    if (newReactionsHtml) {
      existingReactions.outerHTML = newReactionsHtml;
    } else {
      existingReactions.remove();
    }
  } else if (newReactionsHtml) {
    const bubble = div.querySelector('.bubble');
    if (bubble) bubble.insertAdjacentHTML('afterend', newReactionsHtml);
  }

  const footer = div.querySelector('.dm-message-footer');
  if (footer && m.fromId === currentUser.id) {
    const readIcon = footer.querySelector('span:first-child');
    if (readIcon) {
      readIcon.style.color = m.read ? '#4a90e2' : 'var(--muted)';
      readIcon.textContent = m.read ? 'âœ“âœ“' : 'âœ“';
    }
  }

  if (m.edited) {
    const bubble = div.querySelector('.bubble');
    if (bubble && !bubble.textContent.includes('(Ù…Ø¹Ø¯Ù‘Ù„)')) {
      const links = extractLinks(m.text);
      let processedText = escapeHtml(m.text);
      links.forEach(link => {
        const escapedLink = escapeHtml(link);
        processedText = processedText.replace(escapedLink, `<a href="${link}" target="_blank" style="color:var(--brown);text-decoration:underline;word-break:break-all">${escapedLink}</a>`);
      });
      bubble.innerHTML = processedText + '<span style="font-size:10px;color:#ffc107;font-weight:600;margin-left:4px"><br> (Ù…Ø¹Ø¯Ù‘Ù„) </span>';
    }
  }
}

function renderDMMessages(convId, withUser) {
  const messagesToShow = allDMMessages.slice(-dmMessagesLimit);
  const messagesEl = document.querySelector('#dmMessages');
  if (!messagesEl) return;

  messagesEl.innerHTML = '';

  if (messagesToShow.length === 0) {
    messagesEl.innerHTML = '<div style="padding:10px;color:var(--muted)">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ„Ù‰.</div>';
    return;
  }

  // Show "Load More" button if there are older messages
  if (allDMMessages.length > dmMessagesLimit) {
    const loadMoreBtn = document.createElement('button');
    loadMoreBtn.className = 'btn small';
    loadMoreBtn.textContent = `â¬†ï¸ ØªØ­Ù…ÙŠÙ„ ${Math.min(20, allDMMessages.length - dmMessagesLimit)} Ø±Ø³Ø§Ù„Ø© Ø£Ù‚Ø¯Ù…`;
    loadMoreBtn.style.cssText = 'width:100%;margin:10px 0;padding:10px';
    loadMoreBtn.onclick = () => loadMoreMessages(convId, withUser);
    messagesEl.appendChild(loadMoreBtn);
  }

  let lastDate = null;
  messagesToShow.forEach(m => {
    const msgDate = new Date(m.timestamp).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
    if (msgDate !== lastDate) {
      const dateDiv = document.createElement('div');
      dateDiv.className = 'dm-message-date';
      dateDiv.textContent = msgDate;
      messagesEl.appendChild(dateDiv);
      lastDate = msgDate;
    }

    const div = buildMessageElement(m, convId, withUser, allDMMessages);
    messagesEl.appendChild(div);
  });
}
function loadMoreMessages(convId, withUser) {
  if (isLoadingMoreMessages) return;

  isLoadingMoreMessages = true;
  const messagesEl = document.querySelector('#dmMessages');
  const currentScrollHeight = messagesEl.scrollHeight;
  const currentScrollTop = messagesEl.scrollTop;

  // Increase limit by 20
  const oldLimit = dmMessagesLimit;
  dmMessagesLimit += 20;

  // Re-render with more messages
  renderDMMessages(convId, withUser);

  // Restore scroll position after a short delay
  setTimeout(() => {
    const newScrollHeight = messagesEl.scrollHeight;
    messagesEl.scrollTop = currentScrollTop + (newScrollHeight - currentScrollHeight);
    isLoadingMoreMessages = false;
  }, 50);
}

function setupDMScrollListener(messagesEl, convId, withUser) {
  let scrollTimeout;

  messagesEl.addEventListener('scroll', () => {
    clearTimeout(scrollTimeout);

    scrollTimeout = setTimeout(() => {
      // If scrolled to top and there are more messages
      if (messagesEl.scrollTop < 100 && dmMessagesLimit < allDMMessages.length && !isLoadingMoreMessages) {
        loadMoreMessages(convId, withUser);
      }
    }, 150);
  });
}

    // Global DM list renderer - will be set when modal opens
    let globalRenderDMList = null;

    function loadDMConversations() {
      if (!currentUser) return;
      const convRef = ref(database, `dm_conversations/${currentUser.id}`);
      onValue(convRef, (snapshot) => {
        dmConversations = snapshot.exists() ? Object.values(snapshot.val()) : [];
        updateDMBadge();

        // If DM modal is open and renderer is available, refresh the list
        const dmModal = document.querySelector('.dm-modal');
        if (dmModal && typeof globalRenderDMList === 'function') {
          globalRenderDMList();
        }
      });
    }

    function updateDMBadge() {
      const badge = document.getElementById('dmBadge');
      const unread = dmConversations.filter(c => c.unreadCount && c.unreadCount > 0).length;
      if (unread > 0) { badge.textContent = unread; badge.style.display = 'flex'; }
      else badge.style.display = 'none';
    }
    // Virtual scrolling for DM messages
const DM_MESSAGE_HEIGHT = 80; // Approximate height
const DM_RENDER_BUFFER = 10; // Extra messages to render above/below viewport

function setupVirtualScrolling(messagesEl, messages, convId, withUser) {
  let visibleStart = 0;
  let visibleEnd = 20;

  const updateVisibleRange = () => {
    const scrollTop = messagesEl.scrollTop;
    const containerHeight = messagesEl.clientHeight;

    visibleStart = Math.max(0, Math.floor(scrollTop / DM_MESSAGE_HEIGHT) - DM_RENDER_BUFFER);
    visibleEnd = Math.min(messages.length, Math.ceil((scrollTop + containerHeight) / DM_MESSAGE_HEIGHT) + DM_RENDER_BUFFER);
  };

  const renderVisible = () => {
    updateVisibleRange();

    // Only render visible messages
    const visibleMessages = messages.slice(visibleStart, visibleEnd);

    // Clear and render
    messagesEl.innerHTML = '';

    // Add spacer for scrolled-past messages
    if (visibleStart > 0) {
      const spacer = document.createElement('div');
      spacer.style.height = (visibleStart * DM_MESSAGE_HEIGHT) + 'px';
      messagesEl.appendChild(spacer);
    }

    visibleMessages.forEach(m => {
      const div = buildMessageElement(m, convId, withUser, messages);
      messagesEl.appendChild(div);
    });

    // Add spacer for not-yet-visible messages
    if (visibleEnd < messages.length) {
      const spacer = document.createElement('div');
      spacer.style.height = ((messages.length - visibleEnd) * DM_MESSAGE_HEIGHT) + 'px';
      messagesEl.appendChild(spacer);
    }
  };

  // Only use virtual scrolling if there are many messages
  if (messages.length > 20) {
    let scrollTimeout;
    messagesEl.addEventListener('scroll', () => {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(renderVisible, 100);
    });

    renderVisible();
  }
}


   async function openDMWindow(targetUserId = null) {
  const modal = document.createElement('div');
  modal.className = 'modal';
  const targetUser = targetUserId ? allUsers.find(u => u.id === targetUserId) : null;

modal.innerHTML = `
    <div class="modal-inner dm-modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0px">
        <h3 style="margin:0"></h3>
        <div style="display:flex;gap:10px;align-items:center">
          <button class="dm-conversations-toggle" id="toggleConversations">

            <span> &nbsp;Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª&nbsp; </span>
            <span id="conversationsCount"></span>
          </button>
          <button class="dm-conversations-toggle" id="closeDM"> &nbsp;âœ˜&nbsp; </button>
        </div>
      </div>
      <div class="dm-layout">
        <div class="dm-sidebar" id="dmSidebar">
          <div style="padding:10px;border-bottom:1px solid var(--border);display:flex;gap:8px">
            <input id="dmSearch" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…..." style="flex:1" />
            <button class="btn small" id="dmStartNew">Ø¨Ø¯Ø¡</button>
          </div>
          <div id="dmConversationsList"></div>
        </div>
        <div class="dm-content">
          <div id="dmHeader" style="padding:5px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;font-size:18px;font-weight:600;">
            <span class="muted">Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span>
          </div>
          <div id="dmMessages" class="dm-messages"></div>
          <div class="dm-typing-indicator" id="dmTypingIndicator">
            <span class="dm-typing-dots">...</span> ÙŠÙƒØªØ¨
          </div>
    <div class="dm-input">
  <div class="dm-image-upload" style="display:none" id="dmImageUploadPreview">
    <div id="dmImagePreview"></div>
    <button class="btn small" id="dmCancelImage">âœ–ï¸</button>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <input type="file" id="dmImageInput" accept="image/*,video/*,audio/*" style="display:none">
    <button class="btn small" id="dmImageBtn" title="Ø¥Ø±ÙØ§Ù‚ ÙˆØ³Ø§Ø¦Ø·">ğŸ“</button>
    <textarea id="dmText" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ... (Ø§Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©)" style="flex:1"></textarea>
    <button class="btn small" id="dmSend">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  const listEl = modal.querySelector('#dmConversationsList');
  const messagesEl = modal.querySelector('#dmMessages');
  const headerEl = modal.querySelector('#dmHeader');
  const sidebar = modal.querySelector('#dmSidebar');
  const toggleBtn = modal.querySelector('#toggleConversations');
  const conversationsCount = modal.querySelector('#conversationsCount');
  let currentConversationId = null;
  let typingTimeout = null;
  let selectedImage = null;

  let isDMOpen = true;

function destroyDM() {
  // Clear typing state for the active conversation
  if (currentConversationId) {
    set(ref(database, `dm_typing/${currentConversationId}/${currentUser.id}`), null).catch(() => {});
    set(ref(database, `dm_conversations/${currentUser.id}/${currentConversationId}/unreadCount`), 0).catch(() => {});
  }

  // Detach messages listener if any
  if (typeof dmMessagesUnsubscribe === 'function') {
    dmMessagesUnsubscribe();
    dmMessagesUnsubscribe = null;
  }

  // Remove global click listener for message actions
  document.removeEventListener('click', closeMessageActions);

  // Remove modal
  if (modal && modal.parentNode) modal.remove();

  isDMOpen = false;
}


  async function ensureConversationMeta(withUserId) {
    const withUser = allUsers.find(u => u.id === withUserId);
    const convId = getConversationId(currentUser.id, withUserId);
    const myMetaRef = ref(database, `dm_conversations/${currentUser.id}/${convId}`);
    const theirMetaRef = ref(database, `dm_conversations/${withUserId}/${convId}`);

    const myMetaSnap = await get(myMetaRef);
    if (!myMetaSnap.exists()) {
      await set(myMetaRef, {
        id: convId, userId: withUserId, username: withUser?.username || '',
        lastMessage: '', updatedAt: null, unreadCount: 0
      });
    }
    const theirMetaSnap = await get(theirMetaRef);
    if (!theirMetaSnap.exists()) {
      await set(theirMetaRef, {
        id: convId, userId: currentUser.id, username: currentUser.username,
        lastMessage: '', updatedAt: null, unreadCount: 0
      });
    }
  }

  function renderDMList() {
  globalRenderDMList = renderDMList;

    listEl.innerHTML = '';
    const sorted = [...dmConversations].sort((a,b)=> new Date(b.updatedAt||0)-new Date(a.updatedAt||0));
    conversationsCount.textContent = sorted.length > 0 ? `(${sorted.length})` : '';

    if (sorted.length === 0) {
      listEl.innerHTML = '<div style="padding:20px;color:var(--muted);text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¨Ø¹Ø¯</div>';
      return;
    }
    sorted.forEach(conv => {
      const user = allUsers.find(u => u.id === conv.userId);
      const avatarUrl = user?.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user?.username||'Ù…Ø³ØªØ®Ø¯Ù…')}&background=8b5e3c&color=fff&size=32`;
      const item = document.createElement('div');
      item.className = 'dm-list-item';
      item.innerHTML = `
        <img src="${avatarUrl}" class="avatar-small" alt="${user?.username||''}">
        <div style="flex:1">
          <div style="font-weight:700;color:var(--accent)">${escapeHtml(user?.username||'Ù…Ø³ØªØ®Ø¯Ù…')}</div>
          <div style="font-size:12px;color:var(--muted)">${escapeHtml(conv.lastMessage||'')}</div>
        </div>
        ${conv.unreadCount ? `<span class="notification-badge" style="display:flex">${conv.unreadCount}</span>` : ''}
      `;
      item.onclick = () => {
        loadConversation(conv.userId);
        sidebar.classList.remove('show');
      };
      listEl.appendChild(item);
    });
  }


async function loadConversation(withUserId) {
  await ensureConversationMeta(withUserId);
  const withUser = allUsers.find(u => u.id === withUserId);
  const convId = getConversationId(currentUser.id, withUserId);
  currentConversationId = convId;

  headerEl.innerHTML = `
    <img src="${withUser?.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(withUser?.username||'Ù…Ø³ØªØ®Ø¯Ù…')}&background=8b5e3c&color=fff&size=32`}" class="avatar-small" style="cursor:pointer" onclick="window.openUserProfile('${withUserId}')" />
    <div style="font-weight:700;color:var(--accent);cursor:pointer" onclick="window.openUserProfile('${withUserId}')">${escapeHtml(withUser?.username || '')}</div>
  `;

  messagesEl.innerHTML = '<div style="padding:10px;color:var(--muted)">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

  const typingRef = ref(database, `dm_typing/${convId}/${withUserId}`);
  onValue(typingRef, (snapshot) => {
    const typingData = snapshot.val();
    const indicator = modal.querySelector('#dmTypingIndicator');
    if (typingData && typingData.typing && (Date.now() - typingData.timestamp < 4000)) {
      indicator.classList.add('show');
    } else {
      indicator.classList.remove('show');
    }
  });

  // Detach previous conversation listener
  if (typeof dmMessagesUnsubscribe === 'function') {
    dmMessagesUnsubscribe();
    dmMessagesUnsubscribe = null;
  }

  // Reset pagination
  dmMessagesLimit = 20;
  allDMMessages = [];
  let renderedMessageIds = new Set();
  let isFirstLoad = true;

  // Attach real-time messages listener
  const messagesRef = ref(database, `dm_messages/${convId}`);

  dmMessagesUnsubscribe = onValue(messagesRef, async (msgsSnap) => {
    if (!msgsSnap.exists()) {
      messagesEl.innerHTML = '<div style="padding:10px;color:var(--muted)">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ„Ù‰.</div>';
      allDMMessages = [];
      renderedMessageIds.clear();
      return;
    }

    allDMMessages = Object.values(msgsSnap.val()).sort((a,b)=> new Date(a.timestamp)-new Date(b.timestamp));

    // Mark unread as read (non-blocking)
    const unread = allDMMessages.filter(m => m.fromId !== currentUser.id && !m.read);
    if (unread.length > 0) {
      Promise.all(unread.map(m => set(ref(database, `dm_messages/${convId}/${m.id}/read`), true)))
        .catch(err => console.error('Error marking messages as read:', err));
    }

    const wasAtBottom = messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight < 100;

    // First load: render initial messages
    if (isFirstLoad) {
      renderDMMessages(convId, withUser);
      isFirstLoad = false;
      setTimeout(() => {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }, 100);
      await set(ref(database, `dm_conversations/${currentUser.id}/${convId}/unreadCount`), 0);
      return;
    }

    // Incremental updates: only update changed messages
    const currentMessageIds = new Set(allDMMessages.map(m => m.id));

    // Remove deleted messages from DOM
    document.querySelectorAll('.dm-message').forEach(msgEl => {
      const msgId = msgEl.dataset.messageId;
      if (msgId && !currentMessageIds.has(msgId)) {
        msgEl.remove();
        renderedMessageIds.delete(msgId);
      }
    });

    // Update or add new messages
    allDMMessages.slice(-dmMessagesLimit).forEach((m) => {
      const existingDiv = document.querySelector(`[data-message-id="${m.id}"]`);

      if (!existingDiv) {
        // New message - add it
        const div = buildMessageElement(m, convId, withUser, allDMMessages);
        messagesEl.appendChild(div);
        renderedMessageIds.add(m.id);
      } else {
        // Update existing message (for reactions, edits, read status)
        updateMessageElement(existingDiv, m, convId, allDMMessages);
      }
    });

    // Auto-scroll only if user was at bottom
    if (wasAtBottom) {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    await set(ref(database, `dm_conversations/${currentUser.id}/${convId}/unreadCount`), 0);
  });

  // Setup scroll listener for loading more messages
  setupDMScrollListener(messagesEl, convId, withUser);

  const dmTextarea = modal.querySelector('#dmText');
  const dmContent = modal.querySelector('.dm-content');
  setupMentionAutocomplete(dmTextarea, dmContent);

  // Auto-resize textarea
  dmTextarea.addEventListener('input', function() {
    this.style.height = '20px';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
  });

  // ... rest of the function (send button, etc.)
}
  toggleBtn.addEventListener('click', () => {
    sidebar.classList.toggle('show');
  });

modal.addEventListener('click', e => {
  // Clicked on overlay (outside inner content)
  if (e.target === modal) {
    destroyDM();
    return;
  }
  // Hide sidebar if clicking outside it
  if (!e.target.closest('#dmSidebar') && !e.target.closest('.dm-conversations-toggle')) {
    sidebar.classList.remove('show');
  }
});


  modal.querySelector('#dmImageBtn').addEventListener('click', () => {
    modal.querySelector('#dmImageInput').click();
  });

modal.querySelector('#dmImageInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const isImage = file.type.startsWith('image/');
  const isVideo = file.type.startsWith('video/');
  const isAudio = file.type.startsWith('audio/');

  if (!isImage && !isVideo && !isAudio) {
    showAlert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©ØŒ ÙÙŠØ¯ÙŠÙˆØŒ Ø£Ùˆ Ù…Ù„Ù ØµÙˆØªÙŠ');
    return;
  }

  const reader = new FileReader();
  reader.onload = function(event) {
    selectedImage = { file, dataUrl: event.target.result, type: file.type };

    const preview = modal.querySelector('#dmImageUploadPreview');
    const previewContainer = modal.querySelector('#dmImagePreview');

    if (isVideo) {
      previewContainer.innerHTML = `<video controls style="max-width:100px;max-height:100px;border-radius:8px"><source src="${event.target.result}" type="${file.type}"></video>`;
    } else if (isAudio) {
      previewContainer.innerHTML = `<div style="display:flex;align-items:center;gap:8px;padding:8px;background:rgba(139,94,60,0.1);border-radius:8px"><span>ğŸµ</span><span style="font-size:12px">${file.name}</span></div>`;
    } else {
      previewContainer.innerHTML = `<img src="${event.target.result}" style="max-width:100px;max-height:100px;border-radius:8px">`;
    }

    preview.style.display = 'flex';
  };
  reader.readAsDataURL(file);
});

// NEW: Auto-detect image/GIF links in textarea and show preview
const dmTextarea = modal.querySelector('#dmText');
let linkPreviewTimeout;

dmTextarea.addEventListener('input', function() {
  clearTimeout(linkPreviewTimeout);

  linkPreviewTimeout = setTimeout(() => {
    const text = this.value.trim();
    const urls = text.match(/(https?:\/\/[^\s]+)/g);

    if (urls && urls.length > 0) {
      const lastUrl = urls[urls.length - 1];

      // Check if it's an image/GIF link
      const isImageLink = lastUrl.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp)$/i) ||
                          lastUrl.includes('giphy.com') ||
                          lastUrl.includes('tenor.com');

      if (isImageLink && !selectedImage) {
        const preview = modal.querySelector('#dmImageUploadPreview');
        const previewContainer = modal.querySelector('#dmImagePreview');

        previewContainer.innerHTML = `<img src="${lastUrl}" style="max-width:100px;max-height:100px;border-radius:8px" onerror="this.parentElement.parentElement.style.display='none'">`;
        preview.style.display = 'flex';

        // Store as link (not file upload)
        selectedImage = { url: lastUrl, type: 'image/link' };
      }
    }
  }, 500); // Wait 500ms after typing stops
});
modal.querySelector('#dmCancelImage').addEventListener('click', () => {
  selectedImage = null;
  modal.querySelector('#dmImageInput').value = '';
  const preview = modal.querySelector('#dmImageUploadPreview');
  preview.style.display = 'none';
  modal.querySelector('#dmImagePreview').innerHTML = '';
});

  modal.querySelector('#dmText').addEventListener('input', async function() {
    if (!currentConversationId) return;

    const convId = currentConversationId;
    await set(ref(database, `dm_typing/${convId}/${currentUser.id}`), {
      typing: true,
      timestamp: Date.now()
    });

    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(async () => {
      await set(ref(database, `dm_typing/${convId}/${currentUser.id}`), null);
    }, 3000);
  });

  modal.querySelector('#dmStartNew').addEventListener('click', () => {
    const q = (modal.querySelector('#dmSearch').value || '').trim().toLowerCase();
    const candidates = allUsers.filter(u => u.id !== currentUser.id && u.username.toLowerCase().includes(q));
    listEl.innerHTML = '';
    if (candidates.length === 0) {
      listEl.innerHTML = '<div style="padding:20px;color:var(--muted);text-align:center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù…</div>';
      return;
    }
    candidates.forEach(user => {
      const item = document.createElement('div');
      item.className = 'dm-list-item';
      item.innerHTML = `
        <img src="${user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=8b5e3c&color=fff&size=32`}" class="avatar-small" />
        <div style="flex:1">
          <div style="font-weight:700;color:var(--accent)">${escapeHtml(user.username)}</div>
          <div class="muted" style="font-size:12px">Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø©</div>
        </div>
      `;
      item.onclick = () => {
        loadConversation(user.id);
        sidebar.classList.remove('show');
      };
      listEl.appendChild(item);
    });
  });

  const closeMessageActions = function(e) {
    if (!e.target.closest('.dm-message')) {
      document.querySelectorAll('.dm-message.active').forEach(msg => {
        msg.classList.remove('active');
      });
    }
  };

  document.addEventListener('click', closeMessageActions);

modal.querySelector('#closeDM').addEventListener('click', () => {
  destroyDM();
});

await loadDMConversations();
  renderDMList();
  if (targetUser) {
    loadConversation(targetUserId);
  } else if (dmConversations.length > 0) {
    // Open the most recent conversation
    const mostRecent = dmConversations.sort((a,b)=> new Date(b.updatedAt||0)-new Date(a.updatedAt||0))[0];
    if (mostRecent && mostRecent.userId) {
      loadConversation(mostRecent.userId);
    }
  }

  modal.addEventListener('click', e => {
  // Clicked on overlay (outside inner content)
  if (e.target === modal) {
    destroyDM();
    return;
  }
  // Hide sidebar if clicking outside it
  if (!e.target.closest('#dmSidebar') && !e.target.closest('.dm-conversations-toggle')) {
    sidebar.classList.remove('show');
  }
});

}
    // UI controls
    function showSyncStatus(message, duration = 2000) {
      const el = document.getElementById('syncStatus');
      const t = document.getElementById('syncText');
      t.textContent = message;
      el.classList.add('show');
      setTimeout(()=> el.classList.remove('show'), duration);
    }
    function showAlert(message) {
      document.getElementById('confirmMessage').textContent = message;
      document.getElementById('confirmButtons').innerHTML = '<button class="btn" onclick="document.getElementById(\'confirmModal\').classList.remove(\'show\')">Ø­Ø³Ù†Ø§Ù‹</button>';
      document.getElementById('confirmModal').classList.add('show');
    }
    function showConfirm(message, onConfirm) {
      document.getElementById('confirmMessage').textContent = message;
      const btns = document.getElementById('confirmButtons');
      btns.innerHTML = '';
      const cancel = document.createElement('button'); cancel.className='btn'; cancel.textContent='Ø¥Ù„ØºØ§Ø¡'; cancel.onclick=()=>document.getElementById('confirmModal').classList.remove('show');
      const ok = document.createElement('button'); ok.className='btn'; ok.textContent='ØªØ£ÙƒÙŠØ¯'; ok.onclick=()=>{document.getElementById('confirmModal').classList.remove('show'); onConfirm();};
      btns.appendChild(cancel); btns.appendChild(ok);
      document.getElementById('confirmModal').classList.add('show');
    }
function escapeHtml(text) { const d=document.createElement('div'); d.textContent = text || ''; return d.innerHTML; }

function setupMentionAutocomplete(inputElement, containerElement) {
  let dropdown = null;
  let currentMentionStart = -1;

  function createDropdown() {
    dropdown = document.createElement('div');
    dropdown.className = 'mention-dropdown';
    containerElement.style.position = 'relative';
    containerElement.appendChild(dropdown);
  }

  function positionDropdown() {
    if (!dropdown) return;
    const rect = inputElement.getBoundingClientRect();
    const containerRect = containerElement.getBoundingClientRect();
    dropdown.style.top = (rect.bottom - containerRect.top + 5) + 'px';
    dropdown.style.left = (rect.left - containerRect.left) + 'px';
    dropdown.style.minWidth = rect.width + 'px';
  }

  function showMentions(query) {
    if (!dropdown) createDropdown();

    const filtered = allUsers.filter(u =>
      u.username.toLowerCase().includes(query.toLowerCase())
    ).slice(0, 10);

    if (filtered.length === 0) {
      dropdown.classList.remove('show');
      return;
    }

    dropdown.innerHTML = '';
    filtered.forEach(user => {
      const item = document.createElement('div');
      item.className = 'mention-item';
      const avatarUrl = user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=8b5e3c&color=fff&size=24`;
      item.innerHTML = `
        <img src="${avatarUrl}" alt="${user.username}">
        <span style="font-weight:600">${escapeHtml(user.username)}</span>
      `;
      item.onclick = () => {
        const text = inputElement.value;
        const before = text.substring(0, currentMentionStart);
        const after = text.substring(inputElement.selectionStart);
        inputElement.value = before + '@' + user.username + ' ' + after;
        const newPos = (before + '@' + user.username + ' ').length;
        inputElement.setSelectionRange(newPos, newPos);
        inputElement.focus();
        dropdown.classList.remove('show');
        currentMentionStart = -1;
      };
      dropdown.appendChild(item);
    });

    positionDropdown();
    dropdown.classList.add('show');
  }

  inputElement.addEventListener('input', function(e) {
    const text = this.value;
    const cursorPos = this.selectionStart;

    let mentionStart = -1;
    for (let i = cursorPos - 1; i >= 0; i--) {
      if (text[i] === '@') {
        mentionStart = i;
        break;
      }
      if (text[i] === ' ' || text[i] === '\n') {
        break;
      }
    }

    if (mentionStart !== -1) {
      const query = text.substring(mentionStart + 1, cursorPos);
      currentMentionStart = mentionStart;
      showMentions(query);
    } else {
      if (dropdown) dropdown.classList.remove('show');
      currentMentionStart = -1;
    }
  });

  inputElement.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && dropdown) {
      dropdown.classList.remove('show');
      currentMentionStart = -1;
    }
  });

  document.addEventListener('click', function(e) {
    if (dropdown && !dropdown.contains(e.target) && e.target !== inputElement) {
      dropdown.classList.remove('show');
    }
  });
}
window.resizeMedia = function(mediaId) {
  const element = document.getElementById(mediaId);
  if (!element) return;

  const container = element.parentElement;
  const btn = container.querySelector('button');

  // Get current width
  const currentWidth = element.style.width;

  // Cycle through: 300px -> 100% -> back to 300px
  if (currentWidth === '300px' || currentWidth === '') {
    // Go to full size
    element.style.width = '100%';
    container.style.width = '100%';
    container.style.maxWidth = '100%';
    container.style.display = 'block';
    if (btn) btn.textContent = 'ğŸ”';
  } else {
    // Go back to small size
    element.style.width = '300px';
    container.style.width = 'auto';
    container.style.maxWidth = '100%';
    container.style.display = 'inline-block';
    if (btn) btn.textContent = 'ğŸ”';
  }
};
    function formatTimeAgo(dateString) {
      const now = new Date(), date = new Date(dateString); const seconds = Math.floor((now - date)/1000);
      if (seconds < 60) return 'Ø§Ù„Ø¢Ù†';
      if (seconds < 3600) return Math.floor(seconds/60) + ' Ø¯';
      if (seconds < 86400) return Math.floor(seconds/3600) + ' Ø³';
      if (seconds < 604800) return Math.floor(seconds/86400) + ' ÙŠÙˆÙ…';
      if (seconds < 2592000) return Math.floor(seconds/604800) + ' Ø£Ø³Ø¨ÙˆØ¹';
      return Math.floor(seconds/2592000) + ' Ø´Ù‡Ø±';
    }

    async function saveUserToFirebase() { try { await set(ref(database, 'users/' + currentUser.id), currentUser); } catch (e) {} }
    async function savePoemsToFirebase() {
      if (isUpdatingFromFirebase) return;
      try { showSyncStatus('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...'); await set(ref(database, 'poems'), poems); showSyncStatus('âœ… ØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­!'); }
      catch (error) { console.error('Sync error:', error); showSyncStatus('âŒ ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©', 3000); }
    }
    async function loadPoemsFromFirebase() {
      try {
        const snapshot = await get(ref(database, 'poems'));
        if (snapshot.exists()) {
          isUpdatingFromFirebase = true;
          const data = snapshot.val();
          poems = Array.isArray(data) ? data : (data ? Object.values(data) : []);
          renderPoems();
          isUpdatingFromFirebase = false;
        }
      } catch (error) { console.error('Load error:', error); }
    }
  function setupFirebaseListener() {
  const poemsRef = ref(database, 'poems');
  onValue(poemsRef, async (snapshot) => {
    if (snapshot.exists() && !isDragging) {
      isUpdatingFromFirebase = true;
      const data = snapshot.val();
      poems = Array.isArray(data) ? data : (data ? Object.values(data) : []);
      renderPoems();
      isUpdatingFromFirebase = false;
    }
  });
}
    async function loadFromGitHub() {
      const urls = [
        'https://raw.githubusercontent.com/abdomedo2033-code/ModyPoetry/main/poems.json',
        'poems.json'
      ];
      for (let i=0;i<urls.length;i++) {
        try {
          const response = await fetch(urls[i] + '?_=' + Date.now(), {cache:'no-store'});
          if (!response.ok) throw new Error('fetch failed: ' + response.status);
          const data = await response.json();
          if (!Array.isArray(data)) throw new Error('poems.json must be an array');
          return data.map(p => {
            const poem = {...p};
            if (poem.audio && !poem.audios) {
              poem.audios = Array.isArray(poem.audio) ? poem.audio : [poem.audio];
              delete poem.audio;
            } else if (!poem.audios) poem.audios = [];
            else if (!Array.isArray(poem.audios)) poem.audios = [poem.audios];
            if (!poem.images) poem.images = [];
            if (!poem.likes) poem.likes = 0;
            return poem;
          });
        } catch (error) { console.warn('Failed to load from:', urls[i], error); }
      }
      return null;
    }

    async function uploadFileToStorage(file) {
      return new Promise((resolve, reject) => {
        const timestamp = Date.now();
        const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
        const path = `media/${currentUser.id}/${timestamp}_${safeName}`;
        const fileRef = storageRef(storage, path);
        const uploadTask = uploadBytesResumable(fileRef, file);
        document.getElementById('uploadProgress').classList.add('show');
        document.getElementById('uploadText').textContent = `Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
        uploadTask.on('state_changed',
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            const fill = document.getElementById('progressFill');
            fill.style.width = progress + '%';
            fill.textContent = Math.round(progress) + '%';
          },
          (error) => {
            document.getElementById('uploadProgress').classList.remove('show');
            showAlert('âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: ' + error.message);
            reject(error);
          },
          async () => {
            try {
              const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
              document.getElementById('uploadProgress').classList.remove('show');
              document.getElementById('progressFill').style.width = '0%';
              showSyncStatus('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­!', 2000);
              resolve({
                url: downloadURL, path, name: file.name, size: file.size, type: file.type,
                uploadedBy: currentUser.username, uploadedAt: new Date().toISOString()
              });
            } catch (error) { reject(error); }
          }
        );
      });
    }

    document.getElementById('inputImages').addEventListener('change', async function(e) {
      const files = e.target.files;
      for (const file of Array.from(files)) {
        if (!file.type.startsWith('image/')) { showAlert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª ØµÙˆØ± ÙÙ‚Ø·'); continue; }
        try { const uploadedFile = await uploadFileToStorage(file); currentImages.push(uploadedFile); renderImagesPreview(); }
        catch (error) { console.error('Upload failed:', error); }
      }
      e.target.value = '';
    });
    document.getElementById('inputAudioFile').addEventListener('change', async function(e) {
      const files = e.target.files;
      for (const file of Array.from(files)) {
        try { const uploadedFile = await uploadFileToStorage(file); currentAudios.push(uploadedFile); renderAudiosInForm(); }
        catch (error) { console.error('Upload failed:', error); }
      }
      e.target.value = '';
    });
    document.getElementById('btnAddAudioLink').addEventListener('click', function() {
      const link = document.getElementById('inputAudioLink').value.trim();
      if (!link) { showAlert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø·'); return; }
      try {
        new URL(link);
        currentAudios.push({ type: 'link', url: link, addedBy: currentUser.username, addedAt: new Date().toISOString() });
        renderAudiosInForm();
        document.getElementById('inputAudioLink').value = '';
        showSyncStatus('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø§Ø¨Ø·', 1500);
      } catch { showAlert('âš ï¸ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­'); }
    });

    function renderImagesPreview() {
      const preview = document.getElementById('imagesPreview');
      preview.innerHTML = '';
      currentImages.forEach((img, index) => {
        const div = document.createElement('div');
        div.className = 'image-preview-item';
        div.innerHTML = `
          <img src="${img.url}" alt="ØµÙˆØ±Ø© ${index+1}">
          <button class="image-preview-remove" type="button" onclick="window.removeImage(${index})">Ã—</button>
        `;
        preview.appendChild(div);
      });
    }
    window.removeImage = function(index) { currentImages.splice(index, 1); renderImagesPreview(); };

    function renderTagsInForm() {
      const display = document.getElementById('tagsDisplay');
      display.innerHTML = '';
      currentTags.forEach((tag, index) => {
        const badge = document.createElement('span');
        badge.className = 'tag-badge';
        badge.innerHTML = escapeHtml(tag) + ' <button type="button" onclick="window.removeTag(' + index + ')">Ã—</button>';
        display.appendChild(badge);
      });
    }
    function addTag() {
      const tag = document.getElementById('inputTagField').value.trim();
      if (tag && !currentTags.includes(tag)) { currentTags.push(tag); renderTagsInForm(); document.getElementById('inputTagField').value = ''; }
    }
    window.removeTag = function(index) { currentTags.splice(index, 1); renderTagsInForm(); };
    document.getElementById('inputTagField').addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); addTag(); } });

    function renderAudiosInForm() {
      const display = document.getElementById('audioDisplay');
      display.innerHTML = '';
      currentAudios.forEach((audio, index) => {
        const sizeMB = audio.size ? (audio.size/1024/1024).toFixed(2) : '';
        const isFile = audio.url && audio.type && audio.name && audio.type !== 'link';
        const isLink = audio.type === 'link';
        const badge = isFile ? '<span style="background:#28a745;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:6px">Firebase</span>' :
                      isLink ? '<span style="background:#4a90e2;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:6px">Link</span>' : '';
        const text = isFile ? `ğŸ“¦ ${escapeHtml(audio.name)} ${sizeMB ? '('+sizeMB+' MB)' : ''}` :
                      isLink ? 'ğŸ”— ' + escapeHtml(audio.url.substring(0,50) + (audio.url.length>50?'...':'')) : '';
        const item = document.createElement('div');
        item.className = 'audio-item';
        item.innerHTML = `<div>${badge} ${text}</div><button type="button" onclick="window.removeAudio(${index})">Ø­Ø°Ù</button>`;
        display.appendChild(item);
      });
    }
    window.removeAudio = function(index) { currentAudios.splice(index, 1); renderAudiosInForm(); };

    document.getElementById('menuToggle').addEventListener('click', function(e) {
      e.stopPropagation();
      document.getElementById('dropdownMenu').classList.toggle('show');
    });
    document.getElementById('btnNotifications').addEventListener('click', function(e) {
      e.stopPropagation();
      document.getElementById('notificationsMenu').classList.toggle('show');
      document.getElementById('dropdownMenu').classList.remove('show');
    });
    document.getElementById('btnDM').addEventListener('click', function(e) {
      e.stopPropagation();
      openDMWindow();
      document.getElementById('notificationsMenu').classList.remove('show');
      document.getElementById('dropdownMenu').classList.remove('show');
    });
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.menu-container')) {
        document.getElementById('dropdownMenu').classList.remove('show');
        document.getElementById('notificationsMenu').classList.remove('show');
      }
    });
    document.querySelectorAll('.menu-item').forEach(item => item.addEventListener('click', () => { document.getElementById('dropdownMenu').classList.remove('show'); }));

    function renderTags() {
      const tagSet = new Set();
      poems.forEach(p => { if (!isPoemHidden(p.id)) (p.tags || []).forEach(t => tagSet.add(t)); });
      const tagsWrapper = document.getElementById('tagsWrapper');
      tagsWrapper.innerHTML = '';
      const allBtn = document.createElement('button');
      allBtn.className = 'tag';
      allBtn.textContent = 'Ø§Ù„ÙƒÙ„';
      if (activeSearchTags.length === 0) allBtn.classList.add('active');
      allBtn.addEventListener('click', () => { activeSearchTags = []; document.getElementById('searchInput').value=''; renderActiveSearchTags(); renderPoems(); });
      tagsWrapper.appendChild(allBtn);
      Array.from(tagSet).sort().forEach(tag => {
        const btn = document.createElement('button');
        btn.className = 'tag';
        btn.textContent = tag;
        if (activeSearchTags.includes(tag)) btn.classList.add('active');
        btn.addEventListener('click', () => {
          if (!activeSearchTags.includes(tag)) {
            activeSearchTags.push(tag);
          }
          document.getElementById('searchInput').value='';
          renderActiveSearchTags();
          renderPoems();
        });
        tagsWrapper.appendChild(btn);
      });
    }

    function renderActiveSearchTags() {
      const container = document.getElementById('activeSearchTags');
      container.innerHTML = '';
      activeSearchTags.forEach((tag, index) => {
        const badge = document.createElement('span');
        badge.className = 'tag-badge';
        badge.innerHTML = `${escapeHtml(tag)} <button type="button" onclick="window.removeSearchTag(${index})">Ã—</button>`;
        container.appendChild(badge);
      });
    }
    window.removeSearchTag = function(index) {
      activeSearchTags.splice(index, 1);
      renderActiveSearchTags();
      renderPoems();
    };

document.getElementById('searchInput').addEventListener('input', () => { renderPoems(); });
setupMentionAutocomplete(
  document.getElementById('searchInput'),
  document.querySelector('.hero')
);
document.getElementById('searchInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const query = document.getElementById('searchInput').value.trim();
        if (query.startsWith('@')) {
          const authorTag = query;
          if (!activeSearchTags.includes(authorTag)) { activeSearchTags.push(authorTag); }
          document.getElementById('searchInput').value = '';
          renderActiveSearchTags();
          renderPoems();
        }
      }
    });

    async function renderPoems() {
      if (isRendering) return;
      isRendering = true;

      const poemGrid = document.getElementById('poemGrid');
      const emptyState = document.getElementById('emptyState');
      poemGrid.innerHTML = '';

      const searchQuery = document.getElementById('searchInput').value.toLowerCase();

      let filtered = poems.filter(p => {
        if (isPoemHidden(p.id)) return false;

        if (activeSearchTags.length > 0) {
          const authorTags = activeSearchTags.filter(t => t.startsWith('@'));
          const regularTags = activeSearchTags.filter(t => !t.startsWith('@'));

          if (authorTags.length > 0) {
            let authorMatches = false;
            for (const tag of authorTags) {
              const authorQuery = tag.substring(1).trim().toLowerCase();
              const poemAuthor = (p.author && p.author.trim()) || (p.createdBy && p.createdBy.trim()) || '';
              if (poemAuthor.toLowerCase() === authorQuery) { authorMatches = true; break; }
            }
            if (!authorMatches) return false;
          }

          if (regularTags.length > 0) {
            let allRegularTagsMatch = true;
            for (const tag of regularTags) {
              if (!p.tags || !p.tags.includes(tag)) { allRegularTagsMatch = false; break; }
            }
            if (!allRegularTagsMatch) return false;
          }
        }

        if (searchQuery) {
          if (searchQuery.startsWith('@')) {
            const authorQuery = searchQuery.substring(1).trim().toLowerCase();
            if (!authorQuery) return true;
            const poemAuthor = (p.author && p.author.trim()) || (p.createdBy && p.createdBy.trim()) || '';
            return poemAuthor.toLowerCase() === authorQuery;
          }
          const titleMatch = (p.title || '').toLowerCase().includes(searchQuery);
          const textMatch = (p.text || '').toLowerCase().includes(searchQuery);
          const authorMatch = (p.author || '').toLowerCase().includes(searchQuery);
          const createdByMatch = (p.createdBy || '').toLowerCase().includes(searchQuery);
          if (!titleMatch && !textMatch && !authorMatch && !createdByMatch) return false;
        }
        return true;
      });

// Sort: manually ordered poems keep their position, new poems (no manualOrder) go to top

filtered.sort((a, b) => {
  const aHasOrder = a.manualOrder !== undefined;
  const bHasOrder = b.manualOrder !== undefined;

  // If both have manual order, respect it
  if (aHasOrder && bHasOrder) {
    return a.manualOrder - b.manualOrder;
  }

  // If only one has manual order, the one WITHOUT manual order (newer) comes first
  if (aHasOrder && !bHasOrder) return 1;  // b (new) before a (old)
  if (!aHasOrder && bHasOrder) return -1; // a (new) before b (old)

  // If neither has manual order, sort by date - newest first
  return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
});
      if (filtered.length === 0) {
        poemGrid.style.display = 'none';
        emptyState.style.display = 'block';
      } else {
        poemGrid.style.display = 'grid';
        emptyState.style.display = 'none';

        for (const poem of filtered) {
          const card = document.createElement('div');
          card.className = 'card';
          card.dataset.id = poem.id;

          // drag handle
          const drag = document.createElement('div');
          drag.className = 'drag-handle';
          drag.title = 'Ø§Ø³Ø­Ø¨ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨';
          drag.textContent = 'â˜°';
          card.appendChild(drag);

          const hasAudio = poem.audios && poem.audios.length > 0;
          const hasImages = poem.images && poem.images.length > 0;
          const indicators = [];
          if (hasAudio) indicators.push('<span>ğŸµ ØµÙˆØª</span>');
          if (hasImages) indicators.push('<span>ğŸ–¼ï¸ ØµÙˆØ±</span>');
          const indicatorsHtml = indicators.length > 0 ? `<div class="card-indicators">${indicators.join('')}</div>` : '';

          const tagsHtml = (poem.tags && poem.tags.length > 0)
            ? `<div class="card-tags" style="margin-top:10px">${poem.tags.map(t => '<span class="card-tag">' + escapeHtml(t) + '</span>').join('')}</div>`
            : '';

          const title = poem.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';
          const excerpt = poem.excerpt || (poem.text ? poem.text.slice(0, 120) + (poem.text.length > 120 ? '...' : '') : '');

          const contentWrap = document.createElement('div');
          contentWrap.style.cursor = 'pointer';
          contentWrap.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px">
              <h3>${escapeHtml(title)}</h3>
            </div>
            <div class="excerpt">${escapeHtml(excerpt)}</div>
            ${tagsHtml}
            <div class="card-footer">
              ${indicatorsHtml}
            </div>
          `;
          contentWrap.addEventListener('click', () => openModal(poem));
          card.appendChild(contentWrap);
          poemGrid.appendChild(card);
        }
      }

      isRendering = false;
      renderTags();
      renderActiveSearchTags();
    }

    async function getCommentsCount(poemId) {
      try {
        const snapshot = await get(ref(database, `comments/${poemId}`));
        if (snapshot.exists()) return Object.keys(snapshot.val()).length;
        return 0;
      } catch { return 0; }
    }

   function getYouTubeEmbedUrl(url) {
  try {
    const urlObj = new URL(url);
    let videoId = null;
    if (urlObj.hostname.includes('youtube.com')) {
      videoId = urlObj.searchParams.get('v');
    } else if (urlObj.hostname.includes('youtu.be')) {
      videoId = urlObj.pathname.slice(1).split('?')[0];
    }

    if (videoId) {
      // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ù† videoId
      videoId = videoId.split('&')[0];
      return `https://www.youtube.com/embed/${videoId}?enablejsapi=1&origin=${window.location.origin}`;
    }
  } catch {}
  return null;
}
    function getSoundCloudEmbedUrl(url) {
      if (url.includes('soundcloud.com')) return `https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true`;
      return null;
    }

    function getGifEmbedUrl(url) {
      // Giphy links
      if (url.includes('giphy.com')) {
        const giphyMatch = url.match(/giphy\.com\/gifs\/.*?-([a-zA-Z0-9]+)$/);
        if (giphyMatch) {
          return `https://media.giphy.com/media/${giphyMatch[1]}/giphy.gif`;
        }
      }

      // Tenor links
      if (url.includes('tenor.com')) {
        const tenorMatch = url.match(/tenor\.com\/view\/.*?-(\d+)$/);
        if (tenorMatch) {
          return url; // Tenor links work directly
        }
      }

      // Direct GIF links
      if (url.toLowerCase().endsWith('.gif')) {
        return url;
      }

      return null;
    }
 function getAudioHtml(audio) {
  if (!audio) return '';
  let audioUrl = '';
  if (typeof audio === 'string') audioUrl = audio;
  else if (audio.url) audioUrl = audio.url;
  else return '';

  const youtubeEmbed = getYouTubeEmbedUrl(audioUrl);
  if (youtubeEmbed) {
    return `<div class="media-item"><iframe src="${youtubeEmbed}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`;
  }

  // GIF with resize controls
  const gifEmbed = getGifEmbedUrl(audioUrl);
  if (gifEmbed) {
    const imgId = 'gif-' + Math.random().toString(36).substr(2, 9);
    return `<div class="media-item" style="display:inline-block;position:relative;border:2px solid var(--border);border-radius:8px;overflow:hidden;margin-top:8px">
      <div style="position:absolute;top:8px;right:8px;z-index:10">
        <button onclick="window.resizeMedia('${imgId}')" class="media-size-btn">ğŸ”</button>
      </div>
      <img id="${imgId}" src="${gifEmbed}" onclick="window.open('${audioUrl}','_blank')" style="cursor:pointer;width:300px;height:auto;max-width:100%;border-radius:8px;display:block">
    </div>`;
  }

  const soundcloudEmbed = getSoundCloudEmbedUrl(audioUrl);
  if (soundcloudEmbed) {
    return `<div class="media-item"><iframe height="166" scrolling="no" frameborder="no" allow="autoplay" src="${soundcloudEmbed}"></iframe></div>`;
  }

  const audioExtensions = ['.mp3', '.wav', '.ogg', '.m4a', '.aac', '.flac'];
  const videoExtensions = ['.mp4', '.webm', '.mov', '.avi', '.mkv'];
  const lowerUrl = audioUrl.toLowerCase();
  const isDirectAudio = audioExtensions.some(ext => lowerUrl.includes(ext));
  const isDirectVideo = videoExtensions.some(ext => lowerUrl.includes(ext));

  if (isDirectAudio) {
    return `<div class="media-item"><audio controls><source src="${audioUrl}">Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØªÙŠØ©</audio></div>`;
  }
  if (isDirectVideo) {
    const videoId = 'video-' + Math.random().toString(36).substr(2, 9);
    return `<div class="media-item" style="display:inline-block;position:relative;border:2px solid var(--border);border-radius:8px;overflow:hidden;margin-top:8px">
      <div style="position:absolute;top:8px;right:8px;z-index:10">
        <button onclick="window.resizeMedia('${videoId}')" class="media-size-btn">ğŸ”</button>
      </div>
      <video id="${videoId}" controls style="width:300px;height:auto;max-width:100%;display:block;border-radius:8px">
        <source src="${audioUrl}">Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
      </video>
    </div>`;
  }

  if (audio.url && audio.type && audio.name) {
    const isVideo = audio.type.startsWith('video/');
    if (isVideo) {
      const videoId = 'video-' + Math.random().toString(36).substr(2, 9);
      return `<div class="media-item" style="display:inline-block;position:relative;border:2px solid var(--border);border-radius:8px;overflow:hidden;margin-top:8px">
        <div style="position:absolute;top:8px;right:8px;z-index:10">
          <button onclick="window.resizeMedia('${videoId}')" class="media-size-btn">ğŸ”</button>
        </div>
        <video id="${videoId}" controls style="width:300px;height:auto;max-width:100%;display:block;border-radius:8px">
          <source src="${audio.url}" type="${audio.type}">
        </video>
      </div>`;
    } else {
      return `<div class="media-item"><audio controls><source src="${audio.url}" type="${audio.type}">Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØªÙŠØ©</audio></div>`;
    }
  }

  return '';
}
    // Link preview functions
function isYouTubeLink(url) {
  return url.includes('youtube.com') || url.includes('youtu.be');
}

function isSpotifyLink(url) {
  return url.includes('spotify.com');
}

function isSoundCloudLink(url) {
  return url.includes('soundcloud.com');
}

function isGiphyLink(url) {
  return url.includes('giphy.com') || url.includes('tenor.com');
}

function getYouTubeEmbedId(url) {
  const urlObj = new URL(url);
  if (urlObj.hostname.includes('youtube.com')) {
    return urlObj.searchParams.get('v');
  } else if (urlObj.hostname.includes('youtu.be')) {
    return urlObj.pathname.slice(1);
  }
  return null;
}

function getSpotifyEmbedUrl(url) {
      try {
        const urlObj = new URL(url);
        const pathMatch = urlObj.pathname.match(/\/(track|album|playlist|episode)\/([a-zA-Z0-9]+)/);
        if (pathMatch) {
          return `https://open.spotify.com/embed/${pathMatch[1]}/${pathMatch[2]}`;
        }
      } catch {}
      return null;
    }
function extractLinks(text) {
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  return text.match(urlRegex) || [];
}

function renderLinkPreview(url) {

  try {
    // GIF preview
    if (url.toLowerCase().endsWith('.gif') || url.includes('giphy.com') || url.includes('tenor.com')) {
      const imgId = 'gif-' + Math.random().toString(36).substr(2, 9);
      return `
        <div class="media-item" style="display:inline-block;position:relative;border:2px solid var(--border);border-radius:8px;overflow:hidden;margin-top:8px">
          <div style="position:absolute;top:8px;right:8px;z-index:10">
            <button onclick="window.resizeMedia('${imgId}')" class="media-size-btn">ğŸ”</button>
          </div>
          <img id="${imgId}" src="${url}" onclick="window.open('${url}','_blank')" style="cursor:pointer;width:300px;height:auto;max-width:100%;border-radius:8px;display:block" onerror="this.parentElement.style.display='none'">
        </div>
      `;
    }
    if (isYouTubeLink(url)) {
      const videoId = getYouTubeEmbedId(url);
      if (videoId) {
        const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
        return `
          <div style="position:relative;margin-top:8px;max-width:90%;border-radius:12px;overflow:hidden;box-shadow:0 4px 12px var(--shadow);transition:transform 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
            <a href="${url}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();window.open(this.href,'_blank');return false;" style="display:block;position:relative;text-decoration:none">
              <img src="${thumbnailUrl}" onerror="this.src='https://img.youtube.com/vi/${videoId}/hqdefault.jpg'" style="width:100%;display:block">
              <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:80px;height:56px;background:rgba(255,0,0,0.9);border-radius:14px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,0.3);transition:all 0.2s" onmouseover="this.style.background='rgba(255,0,0,1)';this.style.transform='translate(-50%,-50%) scale(1.1)'" onmouseout="this.style.background='rgba(255,0,0,0.9)';this.style.transform='translate(-50%,-50%) scale(1)'">
                <div style="width:0;height:0;border-top:14px solid transparent;border-bottom:14px solid transparent;border-left:24px solid #fff;margin-left:6px"></div>
              </div>
              <div style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(to top, rgba(0,0,0,0.8), transparent);padding:12px;color:#fff">
                <div style="font-size:14px;font-weight:600;display:flex;align-items:center;gap:6px">
                  <span style="font-size:20px">â–¶ï¸</span>
                  <span>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¹Ù„Ù‰ YouTube</span>
                </div>
              </div>
            </a>
          </div>
        `;
      }
    } else if (isSpotifyLink(url)) {
      const embedUrl = getSpotifyEmbedUrl(url);
      if (embedUrl) {
        return `
         <div style="position:relative;margin-top:8px;max-width:90%;max-height:70%;border-radius:12px;overflow:hidden;box-shadow:0 4px 12px var(--shadow);transition:transform 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
          <iframe src="${embedUrl}" width="100%" height="152" frameborder="0" allowtransparency="true" allow="encrypted-media" style="border-radius:12px;display:block"></iframe>
        </div>
      `;
      }
    } else if (isSoundCloudLink(url)) {
      return `<div style="margin-top:8px;max-width:400px"><iframe width="100%" height="166" scrolling="no" frameborder="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true" style="border-radius:8px"></iframe></div>`;
    }

    // Regular clickable link
    return `<a href="${url}" target="_blank" onclick="event.stopPropagation();" style="color:var(--brown);text-decoration:underline;word-break:break-all">${url}</a>`;
  } catch (e) {
    return `<a href="${url}" target="_blank" onclick="event.stopPropagation();" style="color:var(--brown);text-decoration:underline;word-break:break-all">${url}</a>`;
  }
}
    async function loadCommentsFromFirebase(poemId) {
      try { const snapshot = await get(ref(database, `comments/${poemId}`)); if (snapshot.exists()) return Object.values(snapshot.val()); return []; }
      catch (error) { console.error('Error loading comments:', error); return []; }
    }
    async function saveCommentToFirebase(poemId, comment)  {
  try {
    const commentId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    const commentWithId = { ...comment, id: commentId };
    await set(ref(database, `comments/${poemId}/${commentId}`), commentWithId);
    const poem = poems.find(p => p.id === poemId);
    if (poem && poem.userId && poem.userId !== currentUser.id) {
      await addNotification(poem.userId, { type: 'comment', from: currentUser.username, fromId: currentUser.id, poemId, poemTitle: poem.title, timestamp: new Date().toISOString() });
    }
    const mentions = comment.text.match(/@(\w+)/g);
    if (mentions) {
      for (const mention of mentions) {
        const username = mention.substring(1);
        const mentionedUser = allUsers.find(u => u.username.toLowerCase() === username.toLowerCase());
        if (mentionedUser && mentionedUser.id !== currentUser.id) {
          await addNotification(mentionedUser.id, { type: 'mention', from: currentUser.username, fromId: currentUser.id, poemId, poemTitle: poem.title, timestamp: new Date().toISOString() });
        }
      }
    }
    return true;
  } catch (error) { console.error('Error saving comment:', error); return false; }
}

    async function renderComments(poemId, commentsContainer) {
      const comments = await loadCommentsFromFirebase(poemId);
      const commentsList = commentsContainer.querySelector('.comments-list');
      commentsList.innerHTML = '';
      if (comments.length === 0) {
        commentsList.innerHTML = '<div class="no-comments">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø¹Ø¯. ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ¹Ù„Ù‚! ğŸ’¬</div>';
        return;
      }
      comments.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
      comments.forEach(comment => {
        const commentDiv = document.createElement('div');
        commentDiv.className = 'comment';
        const canDelete = comment.userId === currentUser.id;
        const deleteButton = canDelete ? `<button class="comment-action-btn" onclick="window.deleteComment('${poemId}', '${comment.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>` : '';
        const commentUser = allUsers.find(u => u.id === comment.userId);
        const avatarHtml = commentUser && commentUser.avatar
          ? `<img src="${commentUser.avatar}" class="avatar-small" alt="${comment.username}">`
          : `<div class="avatar-small" style="background:var(--brown);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">${(comment.username||'?').charAt(0)}</div>`;
        commentDiv.innerHTML = `
          <div class="comment-header">
            <div class="comment-author" onclick="window.openUserProfile('${comment.userId}')">
              ${avatarHtml}
              <span class="comment-author-name">${escapeHtml(comment.username)}</span>
            </div>
            <span class="comment-time">${formatTimeAgo(comment.createdAt)}</span>
          </div>
          <div class="comment-text">${escapeHtml(comment.text)}</div>
          ${deleteButton ? '<div class="comment-actions">' + deleteButton + '</div>' : ''}
        `;
        commentsList.appendChild(commentDiv);
      });
    }
    // Implement deleteComment
window.deleteComment = async function(poemId, commentId) {
  showConfirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ØŸ', async () => {
    try {
      await set(ref(database, `comments/${poemId}/${commentId}`), null);
      const commentsSection = document.querySelector('.modal .comments-section');
      if (commentsSection) {
        await renderComments(poemId, commentsSection);
        const updatedCount = await getCommentsCount(poemId);
        const countEl = document.querySelector('.modal #commentsCount');
        if (countEl) countEl.textContent = updatedCount;
      }
      showSyncStatus('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚', 1500);
    } catch (error) {
      showAlert('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚: ' + error.message);
    }
  });
};
window.deleteMessage = async function(convId, messageId) {
  showConfirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ', async () => {
    try {
      // Delete the message from Firebase
      await set(ref(database, `dm_messages/${convId}/${messageId}`), null);

      // Update last message in conversation meta
      const msgsSnap = await get(ref(database, `dm_messages/${convId}`));
      if (msgsSnap.exists()) {
        const messages = Object.values(msgsSnap.val()).sort((a,b)=> new Date(b.timestamp)-new Date(a.timestamp));
        const lastMsg = messages[0];

        if (lastMsg) {
          const [userId1, userId2] = convId.split('_');

          await set(ref(database, `dm_conversations/${userId1}/${convId}/lastMessage`), lastMsg.text || 'ğŸ“· ØµÙˆØ±Ø©');
          await set(ref(database, `dm_conversations/${userId1}/${convId}/updatedAt`), lastMsg.timestamp);

          await set(ref(database, `dm_conversations/${userId2}/${convId}/lastMessage`), lastMsg.text || 'ğŸ“· ØµÙˆØ±Ø©');
          await set(ref(database, `dm_conversations/${userId2}/${convId}/updatedAt`), lastMsg.timestamp);
        }
      }

      // Remove the message element from DOM
      const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
      if (messageEl) {
        messageEl.style.transition = 'opacity 0.3s, transform 0.3s';
        messageEl.style.opacity = '0';
        messageEl.style.transform = 'translateX(-20px)';
        setTimeout(() => messageEl.remove(), 300);
      }

      showSyncStatus('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 2000);

    } catch (error) {
      console.error('Error deleting message:', error);
      showAlert('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ' + error.message);
    }
  });
};

window.editMessage = function(messageId) {
  const modal = document.querySelector('.dm-modal');
  if (!modal) return;

  const messageEl = modal.querySelector(`[data-message-id="${messageId}"]`);
  if (!messageEl) return;

  const bubble = messageEl.querySelector('.bubble');
  if (!bubble) return;

  const messageText = bubble.textContent.trim().replace('(Ù…Ø¹Ø¯Ù‘Ù„)', '').trim();

  const textarea = modal.querySelector('#dmText');
  const dmInput = modal.querySelector('.dm-input');

  if (textarea && dmInput) {
    textarea.value = messageText;
    textarea.focus();

    editingMessageId = messageId;

    // Show editing indicator
    let indicator = modal.querySelector('#dmEditingIndicator');
    if (!indicator) {
      indicator = document.createElement('div');
      indicator.id = 'dmEditingIndicator';
      indicator.className = 'dm-editing-indicator';
      dmInput.insertBefore(indicator, dmInput.firstChild);
    }

    indicator.innerHTML = `
      <span>âœï¸  </span>
      <button type="button" onclick="cancelEditing()" style="background:none;border:none;cursor:pointer;color:var(--brown)">âœ–ï¸</button>
    `;
  }

  // Close message actions
  document.querySelectorAll('.dm-message.active').forEach(msg => {
    msg.classList.remove('active');
  });
};

window.cancelEditing = function() {
  editingMessageId = null;
  const modal = document.querySelector('.dm-modal');
  if (modal) {
    const textarea = modal.querySelector('#dmText');
    if (textarea) textarea.value = '';

    const indicator = modal.querySelector('#dmEditingIndicator');
    if (indicator) indicator.remove();
  }
};

window.replyToMessage = function(messageId) {
  const modal = document.querySelector('.dm-modal');
  if (!modal) return;

  const messageEl = modal.querySelector(`[data-message-id="${messageId}"]`);
  if (!messageEl) return;

  const bubble = messageEl.querySelector('.bubble');
  if (!bubble) return;

  const messageText = bubble.textContent.trim().replace('(Ù…Ø¹Ø¯Ù‘Ù„)', '').trim();
  const isMyMessage = messageEl.classList.contains('me');

  const textarea = modal.querySelector('#dmText');
  const dmInput = modal.querySelector('.dm-input');

  if (textarea && dmInput) {
    textarea.focus();

    replyingToMessage = { id: messageId, text: messageText, isMyMessage };

    // Show replying indicator
    let indicator = modal.querySelector('#dmReplyingIndicator');
    if (!indicator) {
      indicator = document.createElement('div');
      indicator.id = 'dmReplyingIndicator';
      indicator.className = 'dm-replying-indicator';
      dmInput.insertBefore(indicator, dmInput.firstChild);
    }

    // Get username from the message element or header
    let author;
    if (isMyMessage) {
      author = 'Ù†ÙØ³Ùƒ';
    } else {
      // Try to get username from the DM header
      const headerEl = modal.querySelector('#dmHeader');
      const headerText = headerEl ? headerEl.textContent.trim() : '';
      author = headerText || 'Ù…Ø³ØªØ®Ø¯Ù…';
    }

    const preview = messageText.substring(0, 25) + (messageText.length > 25 ? '...' : '');

    indicator.innerHTML = `
      <span>â†©ï¸ Ø±Ø¯ Ø¹Ù„Ù‰ ${author}:<br> ${escapeHtml(preview)}</span>
      <button type="button" onclick="cancelReplying()" style="background:none;border:none;cursor:pointer;color:var(--brown)">âœ–ï¸</button>
    `;
  }

  // Close message actions
  document.querySelectorAll('.dm-message.active').forEach(msg => {
    msg.classList.remove('active');
  });
};

window.cancelReplying = function() {
  replyingToMessage = null;
  const modal = document.querySelector('.dm-modal');
  if (modal) {
    const indicator = modal.querySelector('#dmReplyingIndicator');
    if (indicator) indicator.remove();
  }
};

window.dmReact = function(messageId) {
  const emojis = ['ğŸ¤', 'ğŸ‘', 'ğŸ˜‚', 'ğŸ˜®', 'ğŸ˜­', 'ğŸ’©', 'ğŸ’€'];
  const modal = document.querySelector('.dm-modal');
  if (!modal) return;

  // Get conversation ID from message element
  const messageEl = modal.querySelector(`[data-message-id="${messageId}"]`);
  const convId = messageEl?.dataset.conversationId;

  if (!convId) {
    console.error('Conversation ID not found');
    return;
  }

  const emojiPicker = document.createElement('div');
  emojiPicker.style.cssText = 'position:fixed;background:var(--card);border:2px solid var(--brown);border-radius:8px;padding:8px;display:flex;gap:8px;z-index:10000;box-shadow:0 4px 12px var(--shadow-lg)';

  emojis.forEach(emoji => {
    const btn = document.createElement('button');
    btn.textContent = emoji;
    btn.style.cssText = 'background:none;border:none;font-size:24px;cursor:pointer;padding:4px;transition:transform 0.2s';
    btn.onmouseover = () => btn.style.transform = 'scale(1.2)';
    btn.onmouseout = () => btn.style.transform = 'scale(1)';
    btn.onclick = async () => {
      await window.toggleReaction(convId, messageId, emoji);
      emojiPicker.remove();

      // Close message actions and refresh
      document.querySelectorAll('.dm-message.active').forEach(msg => {
        msg.classList.remove('active');
      });
    };
    emojiPicker.appendChild(btn);
  });

  if (messageEl) {
    const rect = messageEl.getBoundingClientRect();
    emojiPicker.style.top = (rect.bottom + 5) + 'px';
    emojiPicker.style.left = rect.left + 'px';
  }

  document.body.appendChild(emojiPicker);

  setTimeout(() => {
    const closeOnClick = (e) => {
      if (!emojiPicker.contains(e.target)) {
        emojiPicker.remove();
        document.removeEventListener('click', closeOnClick);
      }
    };
    document.addEventListener('click', closeOnClick);
  }, 100);

  // Close message actions
  document.querySelectorAll('.dm-message.active').forEach(msg => {
    msg.classList.remove('active');
  });
};

window.toggleReaction = async function(convId, messageId, emoji) {
  try {
    const reactionRef = ref(database, `dm_messages/${convId}/${messageId}/reactions/${currentUser.id}`);
    const snapshot = await get(reactionRef);

    if (snapshot.exists() && snapshot.val().emoji === emoji) {
      await set(reactionRef, null);
    } else {
      await set(reactionRef, {
        emoji: emoji,
        username: currentUser.username,
        timestamp: new Date().toISOString()
      });
    }
    // Real-time listener will handle UI update
  } catch (error) {
    console.error('Error toggling reaction:', error);
  }
};

    async function openModal(poem) {
      const modal = document.createElement('div'); modal.className = 'modal';
      const tagsHtml = (poem.tags || []).map(t => '<span class="card-tag">' + escapeHtml(t) + '</span>').join('');
      const audiosHtml = (poem.audios || []).length > 0
        ? '<div class="media-container"><h4 style="margin-bottom:10px">ğŸµ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</h4>' + (poem.audios || []).map(audio => getAudioHtml(audio)).join('') + '</div>' : '';
const imagesHtml = (poem.images || []).length > 0
  ? '<div class="media-container"><h4 style="margin-bottom:10px">ğŸ–¼ï¸ Ø§Ù„ØµÙˆØ±</h4><div style="display:flex;gap:12px;flex-wrap:wrap">' +
    (poem.images || []).map((img, idx) => {
      const imgId = 'poem-img-' + poem.id + '-' + idx;
      return `
        <div style="display:inline-block;position:relative;border:2px solid var(--border);border-radius:8px;overflow:hidden">
          <div style="position:absolute;top:10px;right:10px;z-index:10">
            <button onclick="window.resizeMedia('${imgId}')" class="media-size-btn">ğŸ”</button>
          </div>
          <img id="${imgId}" src="${img.url}" onclick="window.open('${img.url}','_blank')" style="cursor:pointer;width:300px;height:auto;max-width:100%;display:block;border-radius:8px">
        </div>
      `;
    }).join('') + '</div></div>' : '';

      let userInfoDisplay = '';
      if (poem.userId) {
        const user = allUsers.find(u => u.id === poem.userId);
        if (user) {
          const avatarUrl = user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=8b5e3c&color=fff&size=32`;
          userInfoDisplay = `
            <div class="card-author" onclick="window.openUserProfile('${poem.userId}')" style="margin-top:8px;cursor:pointer">
              <img src="${avatarUrl}" class="avatar-small" alt="${user.username}">
              <span style="font-weight:600;color:var(--brown)">Ø£Ø¶ÙŠÙØª Ø¨ÙˆØ§Ø³Ø·Ø©: ${escapeHtml(user.username)}</span>
            </div>
          `;
        }
      } else if (poem.createdBy) {
        const userIcon = poem.createdBy.toLowerCase().includes('mody') ? 'âœ’ï¸' : 'ğŸ‘¤';
        userInfoDisplay = '<div class="muted" style="margin-top:4px">' + userIcon + ' Ø£Ø¶ÙŠÙØª Ø¨ÙˆØ§Ø³Ø·Ø©: ' + escapeHtml(poem.createdBy) + '</div>';
      }
// ... Ù‡Ù†Ø§ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…ØªØºÙŠØ±Ø§Øª userInfoDisplay Ùˆ tagsHtml Ù…Ø¹Ø±Ù‘ÙØ© ...

      // FIX 1: ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ø­Ù„ ReferenceError
      const canEdit = isOwnPoem(poem);
      const canDelete = isOwnPoem(poem);
      const isFav = isFavorite(poem.id);

      let authorDisplay = '';
      if (poem.author) authorDisplay = '<div class="muted" style="margin-top:6px">âœ’ï¸ ' + escapeHtml(poem.author) + '</div>';

      const likesCount = await getLikesCount(poem.id);
      const userLiked = await isLiked(poem.id);

      // FIX 2: ÙƒØªÙ„Ø© HTML Ù…ØµØ­Ø­Ø© ÙˆØ®Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
   modal.innerHTML = `
        <div class="modal-inner">

          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
            <div style="flex:1">
              <div class="modal-title">${escapeHtml(poem.title)}</div>
              ${authorDisplay}
              ${userInfoDisplay}
              ${tagsHtml ?
'<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">' + tagsHtml + '</div>' : ''}
            </div>

            <div style="display:flex; gap:8px; align-items:center;">

            <button class="icon-btn like-btn-with-count" id="modalLikeBtn" title="${userLiked ? 'Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨' : 'Ø£Ø¹Ø¬Ø¨Ù†ÙŠ'}">
  <span class="like-icon">${userLiked ? 'â¤ï¸' : 'ğŸ’”'}</span>
  <span class="like-count">${likesCount > 0 ? likesCount : ''}</span>
</button>
<div class="actions-menu-container">
  <button class="actions-trigger icon-btn" id="actionsTrigger" title="Ø®ÙŠØ§Ø±Ø§Øª">
    â˜°
  </button>
  <div class="actions-dropdown" id="actionsDropdown">

                  <button class="action-item" id="favoritePoem">${isFav ?
'â­ Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©' : 'â˜† Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©'}</button>
                  ${(poem.userId && poem.userId !== currentUser?.id) ?
'<button class="action-item" id="dmPoet">ğŸ’Œ Ø±Ø³Ø§Ù„Ø© Ù„Ù„ÙƒØ§ØªØ¨</button>' : ''}
                  ${canEdit ?
'<button class="action-item" id="editPoem">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚ØµÙŠØ¯Ø©</button>' : ''}
                  ${canDelete ?
'<button class="action-item" id="deletePoem">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù‚ØµÙŠØ¯Ø©</button>' : ''}
                  ${!canEdit ?
'<button class="action-item" id="hidePoem">ğŸ™ˆ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚ØµÙŠØ¯Ø©</button>' : ''}
                </div>
              </div>

              <button class="icon-btn" id="closeModal" title="Ø¥ØºÙ„Ø§Ù‚">âœ–ï¸</button>
            </div>
          </div>

          <div class="poem-text">${escapeHtml(poem.text)}</div>
          ${imagesHtml}
          ${audiosHtml}

          <div class="comments-section">
            <div class="comments-header">
              ğŸ’¬ ØªØ¹Ù„ÙŠÙ‚Ø§Øª <span id="commentsCount"></span>
            </div>
            <div class="comment-form">
              <textarea class="comment-input" id="commentInput" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ..."></textarea>
              <button class="comment-submit" id="submitComment">Ø¥Ø±Ø³Ø§Ù„</button>

            </div>
            <div class="comments-list"></div>
          </div>
        </div>
      `;
      // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯Ø§Ù„Ø© (Ù…Ø«Ù„ document.body.appendChild(modal);) ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ£ØªÙŠ Ù‡Ù†Ø§.
document.body.appendChild(modal);

      // Actions menu toggle with smart positioning
      const trigger = modal.querySelector('#actionsTrigger');
      const dropdown = modal.querySelector('#actionsDropdown');
      trigger.addEventListener('click', (e) => {
        e.stopPropagation();

        // Calculate position
        const rect = trigger.getBoundingClientRect();
        const dropdownWidth = 180;
        const dropdownHeight = 280;

        // Position below button, aligned to right
        let top = rect.bottom + 5;
        let left = rect.right - dropdownWidth;

        // Check if it goes off screen on right
        if (left < 10) left = 10;
        if (left + dropdownWidth > window.innerWidth - 10) {
          left = window.innerWidth - dropdownWidth - 10;
        }

        // Check if it goes off screen on bottom
        if (top + dropdownHeight > window.innerHeight - 10) {
          top = rect.top - dropdownHeight - 5;
        }

        dropdown.style.top = top + 'px';
        dropdown.style.left = left + 'px';
        dropdown.classList.toggle('show');
      });

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.actions-menu-container')) dropdown.classList.remove('show');
      });

     modal.querySelector('#modalLikeBtn').addEventListener('click', async function() {
  const newCount = await toggleLike(poem.id);
  const newLiked = await isLiked(poem.id);

  // ğŸŸ¢ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ø¹Ø¯Ø¯ ÙÙŠ Ø¹Ù†Ø§ØµØ±Ù‡Ù… Ø§Ù„Ù…Ø®ØµØµØ©
  const iconSpan = this.querySelector('.like-icon');
  const countSpan = this.querySelector('.like-count');

  if (iconSpan) {
    iconSpan.innerHTML = newLiked ? 'â¤ï¸' : 'ğŸ’”';
  }

  if (countSpan) {
    countSpan.textContent = newCount > 0 ? newCount : '';
  }
this.title = newLiked ? 'Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨' : 'Ø£Ø¹Ø¬Ø¨Ù†ÙŠ';
  showSyncStatus(newLiked ? 'â¤ï¸ ØªÙ… Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨' : 'ğŸ’” ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨', 1500);
  dropdown.classList.remove('show');
});

      const commentsContainer = modal.querySelector('.comments-section');
      await renderComments(poem.id, commentsContainer);
      const count = await getCommentsCount(poem.id);
      modal.querySelector('#commentsCount').textContent = count;

const commentInput = modal.querySelector('#commentInput');
const commentsSection = modal.querySelector('.comments-section');
setupMentionAutocomplete(commentInput, commentsSection);

      modal.querySelector('#submitComment').addEventListener('click', async function() {
        const commentText = modal.querySelector('#commentInput').value.trim();
        if (!commentText) { showAlert('âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªØ¹Ù„ÙŠÙ‚'); return; }
        const comment = {
          id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
          text: commentText, username: currentUser.username, userId: currentUser.id,
          createdAt: new Date().toISOString()
        };
        const success = await saveCommentToFirebase(poem.id, comment);
        if (success) {
          modal.querySelector('#commentInput').value = '';
          await renderComments(poem.id, commentsContainer);
          const updatedCount = await getCommentsCount(poem.id);
          modal.querySelector('#commentsCount').textContent = updatedCount;
          showSyncStatus('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚', 2000);
        } else { showAlert('âŒ ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚'); }
      });
      modal.querySelector('#commentInput').addEventListener('keypress', function(e) { if (e.key === 'Enter' && e.ctrlKey) modal.querySelector('#submitComment').click(); });


    // Favorites
   // Favorites
      modal.querySelector('#favoritePoem').addEventListener('click', () => {
        toggleFavorite(poem.id);
        modal.querySelector('#favoritePoem').textContent = isFavorite(poem.id) ? 'â­ Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©' : 'â˜† Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©';
        dropdown.classList.remove('show');
      });
      // DM writer
      if (poem.userId && poem.userId !== currentUser?.id && modal.querySelector('#dmPoet')) {
        modal.querySelector('#dmPoet').addEventListener('click', () => {
          modal.remove();
          openDMWindow(poem.userId);
        });
      }

      // Edit
      if (canEdit) {
        modal.querySelector('#editPoem').addEventListener('click', () => {
          editingPoem = poem;
          document.getElementById('inputTitle').value = poem.title || '';
          document.getElementById('inputAuthor').value = poem.author || '';
          document.getElementById('inputText').value = poem.text || '';
          document.getElementById('inputExcerpt').value = poem.excerpt || '';
          currentTags = poem.tags || []; renderTagsInForm();
          currentAudios = poem.audios || []; renderAudiosInForm();
          currentImages = poem.images || []; renderImagesPreview();
          document.getElementById('modalFormTitle').textContent = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚ØµÙŠØ¯Ø©';
          document.getElementById('addModal').style.display = 'flex';
          modal.remove();
        });
      }

      // Delete
      if (canDelete) {
        modal.querySelector('#deletePoem').addEventListener('click', () => {
          showConfirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù‚ØµÙŠØ¯Ø©ØŸ\n\nâš ï¸ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§ ÙˆØ§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†!', async () => {
            try {
              showSyncStatus('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...', 5000);
              if (poem.audios && poem.audios.length > 0) {
                for (const audio of poem.audios) {
                  if (audio.url && audio.url.includes('firebasestorage.googleapis.com')) {
                    try { if (audio.path) { const fileRef = storageRef(storage, audio.path); await deleteObject(fileRef); } }
                    catch (error) { console.error('Error deleting audio file:', error); }
                  }
                }
              }
              if (poem.images && poem.images.length > 0) {
                for (const img of poem.images) {
                  if (img.url && img.url.includes('firebasestorage.googleapis.com')) {
                    try { if (img.path) { const fileRef = storageRef(storage, img.path); await deleteObject(fileRef); } }
                    catch (error) { console.error('Error deleting image file:', error); }
                  }
                }
              }
              try { await set(ref(database, `comments/${poem.id}`), null); } catch {}
              try { await set(ref(database, `likes/${poem.id}`), null); } catch {}
              poems = poems.filter(p => p.id !== poem.id);
              await savePoemsToFirebase();
              modal.remove();
              showSyncStatus('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚ØµÙŠØ¯Ø© ÙˆØ§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©', 2500);
            } catch (error) { showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: ' + error.message); }
          });
        });
      }

      // Hide
      if (!canEdit && modal.querySelector('#hidePoem')) {
        modal.querySelector('#hidePoem').addEventListener('click', () => {
          toggleHidePoem(poem.id);
          renderPoems();
          modal.remove();
          showSyncStatus('âœ… ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚ØµÙŠØ¯Ø© Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ', 2000);
        });
      }

      // Close
      modal.querySelector('#closeModal').addEventListener('click', () => modal.remove());
      modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
      document.addEventListener('keydown', function esc(e){ if (e.key === 'Escape') { modal.remove(); document.removeEventListener('keydown', esc); } });
    }

    // Sortable with handle only
    let sortableInstance = null;
    function initSortable() {
      const poemGrid = document.getElementById('poemGrid');
      if (!poemGrid) return;
      if (sortableInstance && typeof sortableInstance.destroy === 'function') { try { sortableInstance.destroy(); } catch(e){} }
    sortableInstance = new Sortable(poemGrid, {
  animation: 200,
  handle: '.drag-handle',
  draggable: '.card',
  dataIdAttr: 'data-id',
  onStart: () => {
    isDragging = true;
  },
  onEnd: async () => {
  const ids = Array.from(poemGrid.children).map(c => c.dataset.id).filter(Boolean);
  const newOrder = [];
  ids.forEach((id, index) => {
    const found = poems.find(p => p.id === id);
    if (found) {
      found.manualOrder = index; // Add order property
      newOrder.push(found);
    }
  });
  const missing = poems.filter(p => !ids.includes(p.id));
  poems = newOrder.concat(missing);
  await savePoemsToFirebase();
  setTimeout(() => {
    isDragging = false;
  }, 300);
}
});
    }

    document.getElementById('btnDownload').addEventListener('click', () => {
      const a = document.createElement('a');
      const blob = new Blob([JSON.stringify(poems, null, 2)], {type: 'application/json'});
      a.href = URL.createObjectURL(blob);
      a.download = 'mody_poems_' + Date.now() + '.json';
      document.body.appendChild(a); a.click(); a.remove();
    });

    document.getElementById('btnReloadAndSort').addEventListener('click', async () => {
      showConfirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ù‚ØµØ§Ø¦Ø¯ Ù…ÙˆØ¯ÙŠ Ù…Ù† GitHubØŸ', async () => {
        showSyncStatus('ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚ØµØ§Ø¦Ø¯ Ù…ÙˆØ¯ÙŠ...', 3000);
        const githubPoems = await loadFromGitHub();
        if (!githubPoems) { showAlert('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ GitHub.'); return; }
        const currentMap = new Map(); poems.forEach(p => currentMap.set(p.id, p));
        let added = 0, updated = 0, restored = 0;
        githubPoems.forEach(orig => {
          if (isPoemHidden(orig.id)) { toggleHidePoem(orig.id); restored++; }
          if (!currentMap.has(orig.id)) { poems.push({...orig}); added++; }
          else {
            const existing = currentMap.get(orig.id);
            if (isOriginalModyPoem(existing)) {
              Object.assign(existing, {
                title: orig.title, author: orig.author, text: orig.text, excerpt: orig.excerpt,
                tags: orig.tags || [], audios: orig.audios || [], images: orig.images || []
              });
              updated++;
            }
          }
        });
        await savePoemsToFirebase();
        showAlert(`âœ… ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ‰ Ø£ÙØ¶ÙŠÙ: ${added} Ù‚ØµÙŠØ¯Ø© Ø¬Ø¯ÙŠØ¯Ø©\nğŸ”„ Ø­ÙØ¯ÙÙ‘Ø«: ${updated} Ù‚ØµÙŠØ¯Ø©\nğŸ”“ Ø§Ø³ØªÙØ¹ÙŠØ¯: ${restored} Ù‚ØµÙŠØ¯Ø© Ù…Ø®ÙÙŠØ©\nğŸ“‹ Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ØµØ§Ø¦Ø¯ Ø§Ù„ÙƒÙ„ÙŠ: ${poems.length}`);
      });
    });

    document.getElementById('btnImportJSON').addEventListener('click', () => {
      const input = document.createElement('input'); input.type='file'; input.accept='.json';
      input.onchange = function(e) {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = async function(evt) {
          try {
            const data = JSON.parse(evt.target.result);
            if (!Array.isArray(data)) throw new Error('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù Ù…ØµÙÙˆÙØ©');
            const currentMap = new Map(); poems.forEach(p => currentMap.set(p.id, p));
            let added = 0, skipped = 0, updated = 0;
            data.forEach((p, index) => {
              if (!p.id) p.id = 'imported_' + Date.now() + '_' + index + '_' + Math.random().toString(36).substr(2,9);
              if (!p.audios) p.audios = []; if (!p.images) p.images = []; if (!p.tags) p.tags = [];
              if (!currentMap.has(p.id)) {
                if (!p.createdBy) { p.createdBy = currentUser.username + ' (Ù…Ø³ØªÙˆØ±Ø¯)'; p.userId = currentUser.id; p.importedAt = new Date().toISOString(); }
                poems.push({...p}); currentMap.set(p.id, p); added++;
              } else {
                const existing = currentMap.get(p.id);
                if (isOriginalModyPoem(existing)) {
                  Object.assign(existing, { title: p.title, author: p.author, text: p.text, excerpt: p.excerpt, tags: p.tags||[], audios: p.audios||[], images: p.images||[] });
                  updated++;
                } else skipped++;
              }
            });
            if (added > 0 || updated > 0) { await savePoemsToFirebase(); }
            showAlert(`âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯!\n\nğŸ“ Ø£ÙØ¶ÙŠÙ: ${added} Ù‚ØµÙŠØ¯Ø© Ø¬Ø¯ÙŠØ¯Ø©\nğŸ”„ Ø­ÙØ¯ÙÙ‘Ø«: ${updated} Ù‚ØµÙŠØ¯Ø© Ø£ØµÙ„ÙŠØ©\nâ­ï¸ ØªÙ… ØªØ¬Ø§Ù‡Ù„: ${skipped} Ù‚ØµÙŠØ¯Ø© (Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹)\nğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ØµØ§Ø¦Ø¯: ${poems.length}`);
          } catch (err) { showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ' + err.message); }
        };
        reader.readAsText(file);
      };
      input.click();
    });
document.getElementById('btnMyProfile').addEventListener('click', async () => { openUserProfile(currentUser.id); });

    // Enable browser notifications
    document.getElementById('btnEnableNotifications').addEventListener('click', async () => {
      const granted = await requestNotificationPermission();
      if (granted) {
        showAlert('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª!\n\nØ³ÙˆÙ ØªØªÙ„Ù‚Ù‰ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯:\nâ€¢ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ Ø¨Ù‚ØµØ§Ø¦Ø¯Ùƒ\nâ€¢ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¹Ù„Ù‰ Ù‚ØµØ§Ø¦Ø¯Ùƒ\nâ€¢ Ù…ØªØ§Ø¨Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©\nâ€¢ Ø°ÙƒØ±Ùƒ ÙÙŠ ØªØ¹Ù„ÙŠÙ‚\nâ€¢ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©\nâ€¢ Ù‚ØµÙŠØ¯Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ù…ØªØ§Ø¨ÙØ¹');
        showBrowserNotification('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 'Ø³ÙˆÙ ØªØªÙ„Ù‚Ù‰ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙˆØ±ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©');
      } else {
        showAlert('âš ï¸ Ù„Ù… ÙŠØªÙ… Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª\n\nÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­');
      }
    });

    async function openUserProfile(userId) {
      const user = allUsers.find(u => u.id === userId);
      if (!user) return;

      const modal = document.createElement('div');
      modal.className = 'modal';

      const isOwnProfile = user.id === currentUser.id;
      const isFollowingUser = isFollowing(user.id);

      const avatarUrl = user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=8b5e3c&color=fff&size=120`;

      const followBtn = !isOwnProfile ? `
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="follow-btn ${isFollowingUser ? 'following' : 'not-following'}" id="followBtn" style="flex:1">
            ${isFollowingUser ? 'âœ“ Ù…ØªØ§Ø¨ÙØ¹' : '+ Ù…ØªØ§Ø¨Ø¹Ø©'}
          </button>
          <button class="btn" id="chatBtn" style="padding:8px 20px">ğŸ’¬ Ù…Ø­Ø§Ø¯Ø«Ø©</button>
        </div>` : '';

      modal.innerHTML = `
        <div class="modal-inner user-profile-modal">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <h3 style="margin:0">ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
            <button class="btn small" id="closeProfileModal">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
          </div>

          <div class="profile-header" style="display:flex;gap:20px;align-items:flex-start;margin-bottom:20px;padding:20px;background:rgba(139,94,60,0.05);border-radius:12px">
            <div class="profile-avatar-container">
              <label for="avatarInput" style="cursor:pointer">
                <img src="${avatarUrl}" class="profile-avatar" alt="${user.username}" style="width:120px;height:120px;border-radius:50%;object-fit:cover;border:4px solid var(--brown)">
              </label>
              ${isOwnProfile ? '<input type="file" id="avatarInput" accept="image/*" style="display:none">' : ''}
            </div>
            <div class="profile-info" style="flex:1">
              <div class="profile-name" style="font-size:24px;font-weight:700;color:var(--accent);margin-bottom:5px">${escapeHtml(user.username)}</div>
              ${user.email ? '<div class="profile-username" style="font-size:14px;color:var(--muted);margin-bottom:10px">ğŸ“§ ' + escapeHtml(user.email) + '</div>' : ''}
<div style="position:relative">
  ${isOwnProfile ? '<button class="btn small" id="editBioBtn" style="position:absolute;top:0;left:0;padding:4px 8px;font-size:12px">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>' : ''}
  <div id="bioDisplay" class="profile-bio" style="font-size:14px;line-height:1.6;color:var(--text);margin-bottom:15px;padding:10px;background:rgba(139,94,60,0.03);border-radius:6px;${isOwnProfile ? 'padding-top:35px' : ''}">${user.bio ? escapeHtml(user.bio) : '<span class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø¨Ø°Ø©</span>'}</div>
  <div id="bioEdit" style="display:none">
    <textarea id="bioInput" style="width:100%;min-height:100px;margin-bottom:10px;font-size:14px;padding:10px;border-radius:6px;border:1.5px solid var(--border)">${escapeHtml(user.bio || '')}</textarea>
    <div style="display:flex;gap:8px">
      <button class="btn small" id="saveBioBtn">ğŸ’¾ Ø­ÙØ¸</button>
      <button class="btn small" id="cancelBioBtn">âŒ Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>
${followBtn}


            </div>
          </div>


      <div style="margin-top:20px">
  <h4 style="margin-bottom:15px;color:var(--accent);font-size:20px">ğŸª¶ Ø§Ù„Ù‚ØµØ§Ø¦Ø¯</h4>
  <div class="grid" style="margin-top:0"></div>
</div>
        </div>
      `;

      document.body.appendChild(modal);


      if (!isOwnProfile) {
        modal.querySelector('#followBtn').addEventListener('click', function() {
          toggleFollow(user.id);
          if (isFollowing(user.id)) {
            addNotification(user.id, { type: 'follow', from: currentUser.username, fromId: currentUser.id, timestamp: new Date().toISOString() });
          }
          const btn = this;
          const nowFollowing = isFollowing(user.id);
          btn.textContent = nowFollowing ? 'âœ“ Ù…ØªØ§Ø¨ÙØ¹' : '+ Ù…ØªØ§Ø¨Ø¹Ø©';
          btn.className = 'follow-btn ' + (nowFollowing ? 'following' : 'not-following');
        });
        modal.querySelector('#chatBtn').addEventListener('click', () => { modal.remove(); openDMWindow(user.id); });
      }

      if (isOwnProfile) {
        const avatarInput = modal.querySelector('#avatarInput');
        if (avatarInput) {
          avatarInput.addEventListener('change', async function(e) {
            const file = e.target.files[0]; if (!file) return;
            if (!file.type.startsWith('image/')) { showAlert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©'); return; }
            try {
              const uploaded = await uploadFileToStorage(file);
              currentUser.avatar = uploaded.url;
              const userIndex = allUsers.findIndex(u => u.id === currentUser.id);
              if (userIndex > -1) { allUsers[userIndex].avatar = uploaded.url; }
              saveAllUsers();
              localStorage.setItem(USER_KEY, JSON.stringify(currentUser));
              await saveUserToFirebase();
              modal.querySelector('.profile-avatar').src = uploaded.url;
              showSyncStatus('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­', 2000);
            } catch (error) {
              showAlert('âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: ' + error.message);
            }
          });

        }
        const editBioBtn = modal.querySelector('#editBioBtn');
  const bioDisplay = modal.querySelector('#bioDisplay');
  const bioEdit = modal.querySelector('#bioEdit');
  const bioInput = modal.querySelector('#bioInput');
  const saveBioBtn = modal.querySelector('#saveBioBtn');
  const cancelBioBtn = modal.querySelector('#cancelBioBtn');

  if (editBioBtn) {
    editBioBtn.addEventListener('click', () => {
      bioDisplay.style.display = 'none';
      bioEdit.style.display = 'block';
      bioInput.focus();
    });

    cancelBioBtn.addEventListener('click', () => {
      bioEdit.style.display = 'none';
      bioDisplay.style.display = 'block';
      bioInput.value = user.bio || '';
    });

    saveBioBtn.addEventListener('click', async () => {
      const newBio = bioInput.value.trim();
      try {
        currentUser.bio = newBio;
        user.bio = newBio;

        const userIndex = allUsers.findIndex(u => u.id === currentUser.id);
        if (userIndex > -1) {
          allUsers[userIndex].bio = newBio;
        }

        saveAllUsers();
        localStorage.setItem(USER_KEY, JSON.stringify(currentUser));
        await saveUserToFirebase();

        bioDisplay.innerHTML = newBio ? escapeHtml(newBio) : '<span class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø¨Ø°Ø©</span>';
        bioEdit.style.display = 'none';
        bioDisplay.style.display = 'block';

        showSyncStatus('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¨Ø°Ø© Ø¨Ù†Ø¬Ø§Ø­', 2000);
      } catch (error) {
        showAlert('âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¨Ø°Ø©: ' + error.message);
      }
    });
  }
}
      modal.querySelector('#closeProfileModal').addEventListener('click', () => modal.remove());
      modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });

      get(ref(database, 'poems')).then(snapshot => {
        const allPoems = Object.values(snapshot.val() || {});
        const userPoems = allPoems.filter(p => p.userId === userId);
        const poemsGrid = modal.querySelector('.grid');
        if (userPoems.length === 0) {
          poemsGrid.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“œ</div><div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ØµØ§Ø¦Ø¯</div></div>';
        } else {
          userPoems.forEach(poem => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
              <h3>${escapeHtml(poem.title)}</h3>
              <div class="excerpt">${escapeHtml(poem.excerpt || poem.text.substring(0, 100) + '...')}</div>
            `;
            card.onclick = () => { modal.remove(); openModal(poem); };
            poemsGrid.appendChild(card);
          });
        }
      });


    }
    window.openUserProfile = openUserProfile;

    document.getElementById('btnFavorites').addEventListener('click', async () => {
      const modal = document.createElement('div'); modal.className = 'modal';
      const favoritePoems = poems.filter(p => favorites.includes(p.id));
      modal.innerHTML = `
        <div class="modal-inner">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <h3 style="margin:0">â­ Ø§Ù„Ù‚ØµØ§Ø¦Ø¯ Ø§Ù„Ù…ÙØ¶Ù„Ø© (${favoritePoems.length})</h3>
            <button class="btn small" id="closeFavModal">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
          </div>
          <div class="favorites-grid"></div>
        </div>`;
      document.body.appendChild(modal);
      const grid = modal.querySelector('.favorites-grid');
      if (favoritePoems.length === 0) {
        grid.innerHTML = '<div class="empty-state"><div class="empty-icon">â­</div><div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ØµØ§Ø¦Ø¯ Ù…ÙØ¶Ù„Ø©</div></div>';
      } else {
        for (const poem of favoritePoems) {
          const item = document.createElement('div'); item.className='favorite-item';
          const likesCount = await getLikesCount(poem.id);
          item.innerHTML = `
            <h4 style="margin:0 0 8px 0;color:var(--accent)">${escapeHtml(poem.title)}</h4>
            <div style="font-size:13px;color:var(--muted);margin-bottom:8px">${poem.author ? 'âœ’ï¸ ' + escapeHtml(poem.author) : ''}</div>
            <div style="font-size:12px;color:var(--muted)">â¤ï¸ ${likesCount}</div>`;
          item.onclick = () => { modal.remove(); openModal(poem); };
          grid.appendChild(item);
        }
      }
      modal.querySelector('#closeFavModal').addEventListener('click', () => modal.remove());
      modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
    });

    document.getElementById('btnFollowing').addEventListener('click', () => {
      const modal = document.createElement('div'); modal.className='modal';
      const followingUsers = allUsers.filter(u => following.includes(u.id));
      modal.innerHTML = `
        <div class="modal-inner">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <h3 style="margin:0">ğŸ‘¥ Ø§Ù„Ù…ØªØ§Ø¨ÙØ¹ÙˆÙ† (${followingUsers.length})</h3>
            <button class="btn small" id="closeFollowingModal">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
          </div>
          <div class="profile-list"></div>
        </div>`;
      document.body.appendChild(modal);
      const list = modal.querySelector('.profile-list');
      if (followingUsers.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><div>Ù„Ø§ ØªØªØ§Ø¨Ø¹ Ø£Ø­Ø¯Ø§Ù‹ Ø¨Ø¹Ø¯</div></div>';
      } else {
        followingUsers.forEach(user => {
          const item = document.createElement('div'); item.className='profile-item';
          const avatarUrl = user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=8b5e3c&color=fff&size=32`;
          item.innerHTML = `
            <div style="display:flex;align-items:center;gap:10px">
              <img src="${avatarUrl}" class="avatar-small" alt="${user.username}">
              <div>
                <div class="profile-item-name">${escapeHtml(user.username)}</div>
                ${user.email ? '<div class="profile-item-email">' + escapeHtml(user.email) + '</div>' : ''}
              </div>
            </div>`;
          item.onclick = () => { modal.remove(); openUserProfile(user.id); };
          list.appendChild(item);
        });
      }
      modal.querySelector('#closeFollowingModal').addEventListener('click', () => modal.remove());
      modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
    });

    document.getElementById('btnDeleteProfile').addEventListener('click', () => {
      showConfirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠØŸ\n\nğŸ”´ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ù‚ØµØ§Ø¦Ø¯Ùƒ ÙˆØ§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ÙˆØ­Ø°Ù Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ.\n\nâš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!', async () => {
        try {
          showSyncStatus('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù...', 5000);
          try {
            const userMediaPath = `media/${currentUser.id}/`;
            const userFolderRef = storageRef(storage, userMediaPath);
            const filesList = await listAll(userFolderRef);
            for (const fileRef of filesList.items) { try { await deleteObject(fileRef); } catch (error) { console.error('Error deleting file:', fileRef.fullPath, error); } }
          } catch (error) { console.error('Error deleting user files:', error); }

          poems = poems.filter(p => p.userId !== currentUser.id);
          await savePoemsToFirebase();

          try { await set(ref(database, 'users/' + currentUser.id), null); } catch (error) { console.error('Error deleting user from Firebase:', error); }

          try {
            const commentsSnapshot = await get(ref(database, 'comments'));
            if (commentsSnapshot.exists()) {
              const allComments = commentsSnapshot.val();
              for (const poemId in allComments) {
                for (const commentId in allComments[poemId]) {
                  if (allComments[poemId][commentId].userId === currentUser.id) {
                    await set(ref(database, `comments/${poemId}/${commentId}`), null);
                  }
                }
              }
            }
          } catch (error) { console.error('Error deleting user comments:', error); }

          allUsers = allUsers.filter(u => u.id !== currentUser.id);
          saveAllUsers();

          localStorage.removeItem(USER_KEY);
          localStorage.removeItem(HIDDEN_KEY_PREFIX + '_' + currentUser.id);
          localStorage.removeItem(FAVORITES_KEY + '_' + currentUser.id);
          localStorage.removeItem(FOLLOWING_KEY + '_' + currentUser.id);

          currentUser = null; hiddenPoems = []; favorites = []; following = [];
          showSyncStatus('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­', 2000);
          setTimeout(() => location.reload(), 2000);
        } catch (error) { showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù: ' + error.message); }
      });
    });

    function displayLoginProfiles() {
      const list = document.getElementById('loginProfilesList');
      list.innerHTML = '';
      if (allUsers.length === 0) {
        list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©<br/>Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</div>';
        return;
      }
      allUsers.forEach(user => {
        const item = document.createElement('div'); item.className = 'profile-item';
        const avatarUrl = user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=8b5e3c&color=fff&size=32`;
        item.innerHTML = `
          <div style="display:flex;align-items:center;gap:10px">
            <img src="${avatarUrl}" class="avatar-small" alt="${user.username}">
            <div>
              <div class="profile-item-name">${escapeHtml(user.username)}</div>
              ${user.email ? '<div class="profile-item-email">' + escapeHtml(user.email) + '</div>' : ''}
            </div>
          </div>`;
        item.onclick = () => {
          selectedUserForLogin = user;
          document.getElementById('loginUserName').textContent = user.username;
          document.getElementById('loginForm').style.display = 'none';
          document.getElementById('passwordForm').style.display = 'block';
          document.getElementById('loginPassword').focus();
          document.getElementById('loginPasswordError').classList.remove('show');
        };
        list.appendChild(item);
      });
    }

    document.getElementById('signupUsername').addEventListener('input', function() {
      const username = this.value.trim();
      const errorDiv = document.getElementById('usernameError');
      if (username && checkUserNameExists(username)) errorDiv.classList.add('show'); else errorDiv.classList.remove('show');
    });
    document.getElementById('signupPassword').addEventListener('input', function() {
      const password = this.value.trim();
      const errorDiv = document.getElementById('passwordError');
      if (password && password.length < 4) errorDiv.classList.add('show'); else errorDiv.classList.remove('show');
    });
    document.getElementById('tabLogin').addEventListener('click', () => {
      document.getElementById('tabLogin').classList.add('active');
      document.getElementById('tabSignup').classList.remove('active');
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('signupForm').style.display = 'none';
      document.getElementById('passwordForm').style.display = 'none';
      displayLoginProfiles();
    });
    document.getElementById('tabSignup').addEventListener('click', () => {
      document.getElementById('tabSignup').classList.add('active');
      document.getElementById('tabLogin').classList.remove('active');
      document.getElementById('signupForm').style.display = 'block';
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('passwordForm').style.display = 'none';
      document.getElementById('usernameError').classList.remove('show');
      document.getElementById('passwordError').classList.remove('show');
    });
    document.getElementById('btnBackToProfiles').addEventListener('click', () => {
      document.getElementById('passwordForm').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
      selectedUserForLogin = null;
      document.getElementById('loginPassword').value = '';
      document.getElementById('loginPasswordError').classList.remove('show');
    });

    document.getElementById('btnSignup').addEventListener('click', async () => {
      const username = document.getElementById('signupUsername').value.trim();
      const password = document.getElementById('signupPassword').value.trim();
      const email = document.getElementById('signupEmail').value.trim();
      const bio = document.getElementById('signupBio').value.trim();
      document.getElementById('usernameError').classList.remove('show');
      document.getElementById('passwordError').classList.remove('show');
      if (!username) { showAlert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'); return; }
      if (!password || password.length < 4) { document.getElementById('passwordError').classList.add('show'); return; }
      if (checkUserNameExists(username)) { document.getElementById('usernameError').classList.add('show'); return; }
      currentUser = { id: Date.now() + '_' + Math.random().toString(36).substr(2, 9), username, passwordHash: hashPassword(password), email, bio, createdAt: new Date().toISOString() };
      allUsers.push(currentUser); saveAllUsers(); localStorage.setItem(USER_KEY, JSON.stringify(currentUser));
      await saveUserToFirebase();
      document.getElementById('authModal').style.display = 'none';
      showUserInfo(); init(); showSyncStatus('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!', 2000);
    });
    document.getElementById('btnLoginSubmit').addEventListener('click', () => {
      const password = document.getElementById('loginPassword').value.trim();
      document.getElementById('loginPasswordError').classList.remove('show');
      if (!password) { showAlert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'); return; }
      if (hashPassword(password) !== selectedUserForLogin.passwordHash) { document.getElementById('loginPasswordError').classList.add('show'); return; }
      currentUser = selectedUserForLogin; localStorage.setItem(USER_KEY, JSON.stringify(currentUser));
      document.getElementById('authModal').style.display = 'none';
      showUserInfo(); init(); showSyncStatus('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 2000);
    });
    document.getElementById('loginPassword').addEventListener('keypress', (e) => { if (e.key === 'Enter') document.getElementById('btnLoginSubmit').click(); });

    function checkAuth() {
      const stored = localStorage.getItem(USER_KEY);
      if (stored) { try { currentUser = JSON.parse(stored); showUserInfo(); return true; } catch { localStorage.removeItem(USER_KEY); } }
      displayLoginProfiles();
      document.getElementById('authModal').style.display = 'flex';
      return false;
    }
    function showUserInfo() {
      document.getElementById('currentUserName').textContent = currentUser.username;
      document.getElementById('userInfoDisplay').style.display = 'block';
    }
    document.getElementById('btnLogout').addEventListener('click', () => {
      showConfirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ', () => { localStorage.removeItem(USER_KEY); location.reload(); });
    });

    // Fix: Add button should require auth
    document.getElementById('btnAdd').addEventListener('click', () => {
      if (!currentUser) {
        showAlert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¥Ø¶Ø§ÙØ© Ù‚ØµÙŠØ¯Ø©');
        document.getElementById('authModal').style.display = 'flex';
        return;
      }
      editingPoem = null;
      document.getElementById('poemForm').reset();
      currentTags = []; currentAudios = []; currentImages = [];
      renderTagsInForm(); renderAudiosInForm(); renderImagesPreview();
      document.getElementById('modalFormTitle').textContent = 'âœï¸ Ø£Ø¶Ù Ù‚ØµÙŠØ¯Ø©';
      document.getElementById('addModal').style.display = 'flex';
    });

    document.getElementById('btnCancelAdd').addEventListener('click', () => {
      editingPoem = null;
      document.getElementById('addModal').style.display = 'none';
      document.getElementById('poemForm').reset();
      currentTags = []; currentAudios = []; currentImages = [];
      renderTagsInForm(); renderAudiosInForm(); renderImagesPreview();
    });

    document.getElementById('poemForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const poemData = {
        title: document.getElementById('inputTitle').value.trim() || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†',
        author: document.getElementById('inputAuthor').value.trim(),
        text: document.getElementById('inputText').value.trim(),
        excerpt: document.getElementById('inputExcerpt').value.trim(),
        tags: currentTags,
        audios: currentAudios,
        images: currentImages,
        createdBy: currentUser.username,
        userId: currentUser.id,
        createdAt: new Date().toISOString()
      };

      if (editingPoem) {
        const index = poems.findIndex(p => p.id === editingPoem.id);
        if (index !== -1) poems[index] = { ...poemData, id: editingPoem.id };
        editingPoem = null;
        showSyncStatus('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ØµÙŠØ¯Ø©', 2000);
    } else {
  poemData.id = 'p-' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  poems.push(poemData);

        showSyncStatus('âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù‚ØµÙŠØ¯Ø©', 2000);

        allUsers.forEach(user => {
          if (user.id !== currentUser.id) {
            const userFollowing = localStorage.getItem(FOLLOWING_KEY + '_' + user.id);
            if (userFollowing) {
              try {
                const followingList = JSON.parse(userFollowing);
                if (followingList.includes(currentUser.id)) {
                  addNotification(user.id, {
                    type: 'new_poem',
                    from: currentUser.username,
                    fromId: currentUser.id,
                    poemId: poemData.id,
                    poemTitle: poemData.title,
                    timestamp: new Date().toISOString()
                  });
                }
              } catch {}
            }
          }
        });
      }

      await savePoemsToFirebase();
      document.getElementById('addModal').style.display = 'none';
      this.reset();
      currentTags = []; currentAudios = []; currentImages = [];
      renderTagsInForm(); renderAudiosInForm(); renderImagesPreview();
    });

async function init() {
      loadAllUsers();
      await loadAllUsersFromFirebase();
      if (!checkAuth()) return;

      // Request notification permission on first login
      const hasPermission = await requestNotificationPermission();
      if (hasPermission) {
        console.log('âœ… Notification permission granted');
      } else {
        console.log('âš ï¸ Notification permission denied or not supported');
      }

       loadHiddenPoems();
      loadFavorites();
      loadFollowing();
      await loadPoemsFromFirebase();
      await loadNotifications();
      await loadDMConversations();
      setupFirebaseListener();

      // Listen for new notifications in real-time
      const notifRef = ref(database, `notifications/${currentUser.id}`);
      onValue(notifRef, (snapshot) => {
        if (snapshot.exists()) {
          const newNotifications = Object.values(snapshot.val());

          // Find new notifications that aren't in our current list
          newNotifications.forEach(notif => {
            const existing = notifications.find(n => n.id === notif.id);
            if (!existing && !notif.read) {
              // This is a brand new notification - show browser notification
              let title = 'Mody Poetry';
              let body = '';

              if (notif.type === 'like') {
                title = 'Ø¥Ø¹Ø¬Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ â¤ï¸';
                body = `${notif.from} Ø£Ø¹Ø¬Ø¨ Ø¨Ù‚ØµÙŠØ¯ØªÙƒ "${notif.poemTitle}"`;
              } else if (notif.type === 'comment') {
                title = 'ØªØ¹Ù„ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯ ğŸ’¬';
                body = `${notif.from} Ø¹Ù„Ù‚ Ø¹Ù„Ù‰ Ù‚ØµÙŠØ¯ØªÙƒ "${notif.poemTitle}"`;
              } else if (notif.type === 'follow') {
                title = 'Ù…ØªØ§Ø¨Ø¹ Ø¬Ø¯ÙŠØ¯ ğŸ‘¥';
                body = `${notif.from} Ø¨Ø¯Ø£ Ø¨Ù…ØªØ§Ø¨Ø¹ØªÙƒ`;
              } else if (notif.type === 'mention') {
                title = 'Ø°ÙƒØ±Ùƒ ÙÙŠ ØªØ¹Ù„ÙŠÙ‚ ğŸ“¢';
                body = `${notif.from} Ø°ÙƒØ±Ùƒ ÙÙŠ ØªØ¹Ù„ÙŠÙ‚`;
              } else if (notif.type === 'message') {
                title = 'Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸ’Œ';
                body = `${notif.from}: ${notif.messagePreview}`;
              } else if (notif.type === 'new_poem') {
                title = 'Ù‚ØµÙŠØ¯Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸª¶';
                body = `${notif.from} Ù†Ø´Ø± Ù‚ØµÙŠØ¯Ø© Ø¬Ø¯ÙŠØ¯Ø© "${notif.poemTitle}"`;
              }

              showBrowserNotification(title, body, notif);
            }
          });

          notifications = newNotifications;
          renderNotifications();
          updateNotificationBadge();
        }
      });

      renderPoems();
      initSortable();
      showSyncStatus('âœ…Ù…ØªØµÙ„ ', 2000);
    }
    init();
document.querySelectorAll('.dm-message').forEach(msg => {
  msg.addEventListener('click', () => {
    // remove active from others
    document.querySelectorAll('.dm-message.active')
      .forEach(m => m.classList.remove('active'));

    // activate clicked one
    msg.classList.add('active');
  });
});


  </script>
</body>
</html>
