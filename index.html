<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸª¶ Mody Poetry</title>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg-gradient-1:#fff8f0;--bg-gradient-2:#fef3e8;--card:#ffffff;--muted:#8b7355;--accent:#3a1f0b;--brown:#8b5e3c;--brown-hover:#a67c52;--text:#2e1a0f;--shadow:rgba(58,31,11,0.08);--shadow-lg:rgba(58,31,11,0.12);--border:#e8dcc8;--header-dark:#e8d2bf;--header-dark-2:#d9c0a6}
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow-x:hidden}
    body{font-family:'Cairo',system-ui,sans-serif;background:linear-gradient(135deg,var(--bg-gradient-1) 0%,var(--bg-gradient-2) 100%);background-attachment:fixed;color:var(--text);line-height:1.7;padding:0}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    header{background:linear-gradient(180deg,var(--header-dark) 0%, var(--header-dark-2) 100%);border-bottom:1px solid rgba(0,0,0,0.06);position:sticky;top:0;z-index:100;box-shadow:0 6px 28px rgba(0,0,0,0.08)}
    .header-content{max-width:1100px;margin:0 auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px;background:rgba(58,31,11,0.06);color:var(--brown);box-shadow:0 4px 12px rgba(0,0,0,0.06)}
    .brand h1{font-size:20px;font-weight:700;color:var(--accent)}
    .brand p{font-size:13px;color:rgba(0,0,0,0.45);margin-top:2px}
    nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:8px 12px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;border:1.4px solid var(--brown);background:#fff;color:#5a3f2a;transition:all .18s ease}
    .btn:hover{background:#f5ebe0;border-color:var(--brown-hover)}
    .small{padding:6px 10px;font-size:13px}
    .menu-container{position:relative}
    .dropdown-menu{position:absolute;top:calc(100% + 8px);left:0;background:#fff;border-radius:10px;box-shadow:0 12px 32px rgba(0,0,0,0.15);border:1px solid var(--border);min-width:240px;display:none;z-index:200;padding:6px}
    .dropdown-menu.show{display:block}
    .menu-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;font-size:14px;font-weight:600;color:#5a3f2a;cursor:pointer;transition:all .15s ease;border:none;background:transparent;width:100%;text-align:right}
    .menu-item:hover{background:#f5ebe0}
    .menu-divider{height:1px;background:var(--border);margin:6px 0}
    .hero{background:linear-gradient(135deg,rgba(255,255,255,0.92) 0%,rgba(255,251,245,0.92) 100%);border-radius:14px;padding:16px;margin:18px 0;box-shadow:0 8px 32px var(--shadow-lg);border:1px solid var(--border)}
    input[type="search"],input[type="text"],input[type="email"],input[type="url"],input[type="password"],textarea{padding:10px 12px;border-radius:8px;border:1.5px solid #e8dcc8;font-size:15px;background:#fff;width:100%}
    .tags-wrapper{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .tag{padding:7px 12px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;border:1.2px solid #d4c4b0;background:#fff;color:#5a3f2a;transition:all .18s ease}
    .tag:hover{background:#f5ebe0;border-color:var(--brown)}
    .tag.active{background:#f5ebe0;border-color:var(--brown)}
    .tag-badge{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;background:#f5ebe0;border:1px solid var(--brown);border-radius:8px;font-size:13px;color:var(--brown);font-weight:600}
    .tag-badge button{background:none;border:none;color:var(--brown);cursor:pointer;font-size:16px;padding:0;line-height:1}
    .audio-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .audio-item{display:flex;align-items:center;gap:8px;padding:8px;background:#f9f9f9;border-radius:8px;border:1px solid var(--border);font-size:13px}
    .audio-item button{background:#d9534f;color:#fff;border:none;padding:4px 8px;border-radius:6px;cursor:pointer;font-size:12px}
    .upload-progress{margin-top:10px;padding:10px;background:#f0f8ff;border-radius:8px;border:1px solid #4a90e2;display:none}
    .upload-progress.show{display:block}
    .progress-bar{width:100%;height:20px;background:#e0e0e0;border-radius:10px;overflow:hidden;margin-top:8px}
    .progress-fill{height:100%;background:#4a90e2;transition:width 0.3s ease;display:flex;align-items:center;justify-content:center;color:#fff;font-size:12px;font-weight:600}
    .sync-status{position:fixed;bottom:20px;right:20px;padding:10px 16px;background:rgba(139,94,60,0.95);color:#fff;border-radius:8px;font-size:13px;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:1000;display:none}
    .sync-status.show{display:flex}
    .profile-list{display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto;margin-bottom:15px}
    .profile-item{padding:12px;background:#f5ebe0;border-radius:8px;cursor:pointer;transition:all .2s ease;border:2px solid transparent}
    .profile-item:hover{border-color:var(--brown);background:#ffe8d6}
    .profile-item-name{font-weight:700;color:var(--accent);font-size:15px}
    .profile-item-email{font-size:12px;color:var(--muted);margin-top:2px}
    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-top:18px}
    .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 8px 20px rgba(0,0,0,0.04);border:1px solid var(--border);transition:all .22s;display:flex;gap:10px;position:relative}
    .card:hover{transform:translateY(-4px);box-shadow:0 12px 28px rgba(0,0,0,0.08)}
    .card .drag-handle{flex:0 0 36px;display:flex;align-items:center;justify-content:center;border-radius:8px;cursor:grab;font-size:17px;color:var(--brown)}
    .card .content{flex:1}
    .card h3{font-family:'Amiri',serif;margin:0 0 6px 0;color:var(--accent);font-size:19px;font-weight:700}
    .excerpt{font-family:'Amiri',serif;color:var(--muted);line-height:1.9;font-size:16px;min-height:56px}
    .card-footer{margin-top:8px;display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap}
    .card-tags{display:flex;gap:6px;flex-wrap:wrap}
    .card-tag{padding:4px 8px;border-radius:12px;font-size:12px;background:rgba(139,94,60,0.12);color:var(--brown);font-weight:700}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;padding:18px;z-index:1200;overflow-y:auto}
    .modal-inner{background:var(--card);max-width:820px;width:100%;border-radius:12px;padding:20px;max-height:90vh;overflow-y:auto;box-shadow:0 30px 60px rgba(0,0,0,.25);border:1px solid var(--border)}
    .modal-title{font-family:'Amiri',serif;font-size:22px;margin-bottom:6px;color:var(--accent)}
    .poem-text{font-family:'Amiri',serif;white-space:pre-line;font-size:18px;line-height:2;margin-top:12px;color:var(--text)}
    .media-container{margin-top:16px;border-top:1px solid var(--border);padding-top:16px}
    .media-item{margin-bottom:12px;background:#f9f9f9;padding:10px;border-radius:8px;border:1px solid var(--border)}
    .media-item audio, .media-item video, .media-item iframe{width:100%;border-radius:6px;max-height:400px}
    .comments-section{margin-top:20px;border-top:2px solid var(--border);padding-top:20px}
    .comments-header{display:flex;align-items:center;gap:8px;margin-bottom:16px;font-size:16px;font-weight:700;color:var(--accent)}
    .comment-form{display:flex;flex-direction:column;gap:8px;margin-bottom:20px;padding:12px;background:#f9f9f9;border-radius:8px;border:1px solid var(--border)}
    .comment-input{padding:10px;border-radius:6px;border:1.5px solid var(--border);font-size:14px;resize:vertical;min-height:60px;font-family:'Cairo',sans-serif}
    .comment-submit{align-self:flex-end;padding:8px 16px;background:var(--brown);color:#fff;border:none;border-radius:6px;font-weight:600;cursor:pointer;transition:all .2s}
    .comment-submit:hover{background:var(--brown-hover)}
    .comments-list{display:flex;flex-direction:column;gap:12px}
    .comment{background:#fff;padding:12px;border-radius:8px;border:1px solid var(--border)}
    .comment-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .comment-author{font-weight:700;color:var(--accent);font-size:14px}
    .comment-time{font-size:12px;color:var(--muted)}
    .comment-text{font-size:14px;line-height:1.6;color:var(--text)}
    .comment-actions{margin-top:8px;display:flex;gap:8px}
    .comment-action-btn{background:none;border:none;color:var(--brown);font-size:12px;cursor:pointer;padding:4px 8px;border-radius:4px;transition:all .2s}
    .comment-action-btn:hover{background:#f5ebe0}
    .no-comments{text-align:center;padding:20px;color:var(--muted);font-size:14px}
    .confirm-modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;padding:18px;z-index:1400}
    .confirm-modal.show{display:flex}
    .confirm-box{background:var(--card);border-radius:12px;padding:24px;max-width:450px;width:100%;box-shadow:0 20px 50px rgba(0,0,0,.3);border:1px solid var(--border)}
    .confirm-message{font-size:16px;margin-bottom:20px;line-height:1.6;white-space:pre-line}
    .confirm-buttons{display:flex;gap:10px;justify-content:flex-end}
    .tab-buttons{display:flex;gap:8px;margin-bottom:15px;border-bottom:2px solid var(--border);padding-bottom:8px}
    .tab-btn{padding:8px 16px;border:none;background:transparent;color:var(--muted);font-weight:600;cursor:pointer;border-radius:6px 6px 0 0;transition:all .2s}
    .tab-btn.active{background:var(--brown);color:#fff}
    .error-message{color:#d9534f;font-size:13px;margin-top:4px;display:none}
    .error-message.show{display:block}
    footer{text-align:center;color:var(--muted);margin-top:36px;padding:20px;font-size:13px}
    @media (max-width:768px){.grid{grid-template-columns:1fr}.dropdown-menu{right:0;left:auto}}
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="brand">
        <div class="brand-icon">â˜•</div>
        <div>
          <h1>Mody Poetry</h1>
          <p class="muted">Ø´Ø§Ø±Ùƒ Ù‚ØµØ§Ø¦Ø¯Ùƒ Ù…Ø¹ Ø§Ù„Ø£ØºØ§Ù†ÙŠ ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</p>
        </div>
      </div>
      <nav>
        <button class="btn small" id="btnAdd">âœï¸ Ø£Ø¶Ù</button>
        <div class="menu-container">
          <button class="btn small" id="menuToggle">â˜° Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
          <div class="dropdown-menu" id="dropdownMenu">
<button class="menu-item" id="btnReloadAndSort">ğŸ¥³ Ø¬Ø¯ÙŠØ¯ Ù…ÙˆØ¯ÙŠ</button>
            <div class="menu-divider"></div>
            <button class="menu-item" id="btnDownload">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ØµØ§Ø¦Ø¯</button>
            <div class="menu-divider"></div>
            <button class="menu-item" id="btnImportJSON">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
            <div class="menu-divider"></div>
            <button class="menu-item" id="btnDeleteProfile">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù</button>
            <div class="menu-divider"></div>
            <button class="menu-item" id="btnLogout">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <div id="syncStatus" class="sync-status"><span id="syncText">ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...</span></div>

  <div id="userInfoDisplay" style="display:none;padding:10px 20px;background:rgba(139,94,60,0.1);border-bottom:1px solid var(--border)">
    <div style="max-width:1100px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
      <div><span style="font-weight:600">ğŸ‘¤ Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ </span><span id="currentUserName" style="color:var(--brown)">---</span></div>
    </div>
  </div>

  <div class="container">
    <section class="hero">
      <input id="searchInput" type="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„Ù†Øµ..." />
      <div id="tagsWrapper" class="tags-wrapper"></div>
    </section>

    <section>
      <div id="poemGrid" class="grid"></div>
      <div id="emptyState" style="display:none;margin-top:18px;padding:18px;border-radius:12px;border:2px dashed var(--border);text-align:center">
        <div style="font-size:28px">ğŸ“œ</div>
        <div style="font-weight:700;margin-top:8px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ØµØ§Ø¦Ø¯</div>
        <div class="muted" style="margin-top:6px">Ø§Ø¶ØºØ· "Ø£Ø¶Ù" Ù„Ø¥Ø¶Ø§ÙØ© Ù‚ØµÙŠØ¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
      </div>
    </section>

    <div id="authModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:1500;align-items:center;justify-content:center;padding:18px">
      <div style="background:var(--card);border-radius:12px;padding:20px;max-width:450px;width:100%;box-shadow:0 20px 50px rgba(0,0,0,.25);border:1px solid var(--border)">
        <h3 style="margin:0 0 15px 0">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h3>
        
        <div class="tab-buttons">
          <button class="tab-btn active" id="tabLogin">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
          <button class="tab-btn" id="tabSignup">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        </div>

        <div id="loginForm">
          <div id="loginProfilesList" class="profile-list" style="max-height:250px"></div>
          <div style="margin-top:15px;text-align:center;color:var(--muted);font-size:13px">
            Ø§Ø®ØªØ± Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¹Ù„Ø§Ù‡
          </div>
        </div>

        <div id="signupForm" style="display:none">
          <div style="display:flex;flex-direction:column;gap:10px">
            <input id="signupUsername" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… * (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ±ÙŠØ¯Ø§Ù‹)" required />
            <div id="usernameError" class="error-message">âš ï¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„! ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø¢Ø®Ø±.</div>
            <input id="signupPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *" required />
            <div id="passwordError" class="error-message">âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)</div>
            <input id="signupEmail" type="email" placeholder="Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
            <textarea id="signupBio" placeholder="Ù†Ø¨Ø°Ø© Ø¹Ù†Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="min-height:80px"></textarea>
            <button class="btn" id="btnSignup">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
          </div>
        </div>

        <div id="passwordForm" style="display:none">
          <div style="margin-bottom:15px">
            <button class="btn small" id="btnBackToProfiles">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
          </div>
          <div style="display:flex;flex-direction:column;gap:10px">
            <div style="font-weight:600;color:var(--accent)">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ€: <span id="loginUserName"></span></div>
            <input id="loginPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *" required />
            <div id="loginPasswordError" class="error-message">âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!</div>
            <button class="btn" id="btnLoginSubmit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
          </div>
        </div>
      </div>
    </div>

    <div id="addModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:1300;align-items:center;justify-content:center;padding:18px">
      <div style="background:var(--card);border-radius:12px;padding:16px;max-width:720px;width:100%;box-shadow:0 20px 50px rgba(0,0,0,.25);border:1px solid var(--border);max-height:90vh;overflow-y:auto">
        <h3 style="margin:0 0 10px 0" id="modalFormTitle">âœï¸ Ø£Ø¶Ù Ù‚ØµÙŠØ¯Ø©</h3>
        <form id="poemForm">
          <div style="display:flex;flex-direction:column;gap:8px">
            <input id="inputTitle" type="text" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚ØµÙŠØ¯Ø© *" required />
            <input id="inputAuthor" type="text" placeholder="Ø§Ù„Ù…Ø¤Ù„Ù / Ø§Ù„Ø±Ø§ÙˆÙŠ" />
            <textarea id="inputText" placeholder="Ù†Øµ Ø§Ù„Ù‚ØµÙŠØ¯Ø© *" required style="min-height:140px;font-family:Amiri,serif"></textarea>
            <input id="inputExcerpt" type="text" placeholder="Ù…Ù‚ØªØ·Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
            <div>
              <label style="display:block;margin-bottom:6px;font-size:14px;font-weight:600">Ø§Ù„ÙˆØ³ÙˆÙ… (Ø§Ø¶ØºØ· Enter)</label>
              <div id="tagsDisplay" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px"></div>
              <input id="inputTagField" type="text" placeholder="Ø§ÙƒØªØ¨ ÙˆØ³Ù… ÙˆØ§Ø¶ØºØ· Enter" />
            </div>
            <div>
              <label style="display:block;margin-bottom:6px;font-size:14px;font-weight:600">ğŸ“¤ Ø§Ù„ÙˆØ³Ø§Ø¦Ø· (Ø£ØºØ§Ù†ÙŠ / ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª)</label>
              <div id="audioDisplay" class="audio-list"></div>
              <div style="margin-top:8px"><input type="file" id="inputAudioFile" accept="audio/*,video/*" multiple style="font-size:13px" /></div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <input id="inputAudioLink" type="url" placeholder="Ø£Ùˆ Ø§Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· (YouTube, SoundCloud, Ø¥Ù„Ø®)" style="flex:1" />
                <button type="button" id="btnAddAudioLink" class="btn small">â• Ø¥Ø¶Ø§ÙØ©</button>
              </div>
              <div id="uploadProgress" class="upload-progress">
                <div id="uploadText" style="font-size:13px;font-weight:600;color:#4a90e2">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...</div>
                <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width:0%">0%</div></div>
              </div>
              <div style="margin-top:6px;font-size:12px;color:var(--muted)">ğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ø±ÙˆØ§Ø¨Ø·</div>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button type="button" class="btn" id="btnCancelAdd">Ø¥Ù„ØºØ§Ø¡</button>
              <button type="submit" class="btn">Ù†Ø´Ø± Ø§Ù„Ù‚ØµÙŠØ¯Ø© ğŸ“¤</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div id="confirmModal" class="confirm-modal">
      <div class="confirm-box">
        <div id="confirmMessage" class="confirm-message"></div>
        <div class="confirm-buttons" id="confirmButtons"></div>
      </div>
    </div>
  </div>

  <footer>Â© <span id="year"></span> Ù…Ø¬Ù†ÙˆÙ† Ø§Ù„Ø´ÙØ¹Ø± â€” Powered by Firebase ğŸ”¥</footer>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL, deleteObject, listAll } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
    const app = initializeApp({
      apiKey: "AIzaSyANYJJ3gTxEgeaj731npdx37OHd4Xf3t70",
      authDomain: "modypoems.firebaseapp.com",
      databaseURL: "https://modypoems-default-rtdb.firebaseio.com",
      projectId: "modypoems",
      storageBucket: "modypoems.firebasestorage.app",
      messagingSenderId: "805060440847",
      appId: "1:805060440847:web:bc4f89cd351c9c244f447a"
    });

    const database = getDatabase(app);
    const storage = getStorage(app);

    const USER_KEY = 'mody_current_user';
    const HIDDEN_KEY_PREFIX = 'mody_hidden_poems';
    const ALL_USERS_KEY = 'mody_all_users';
    let poems = [], originalPoems = null, hiddenPoems = [], allUsers = [];
    let isDragging = false, activeTag = null, editingPoem = null;
    let currentTags = [], currentAudios = [], currentUser = null, isUpdatingFromFirebase = false;
    let selectedUserForLogin = null;

    const year = document.getElementById('year');
    year.textContent = new Date().getFullYear();

    function hashPassword(password) {
      let hash = 0;
      for (let i = 0; i < password.length; i++) {
        const char = password.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return Math.abs(hash).toString(36);
    }

    async function loadAllUsersFromFirebase() {
      try {
        const snapshot = await get(ref(database, 'users'));
        if (snapshot.exists()) {
          const users = snapshot.val();
          allUsers = Object.values(users);
          saveAllUsers();
        }
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    function loadAllUsers() {
      const stored = localStorage.getItem(ALL_USERS_KEY);
      if (stored) try { allUsers = JSON.parse(stored); } catch (e) { allUsers = []; }
    }

    function saveAllUsers() {
      localStorage.setItem(ALL_USERS_KEY, JSON.stringify(allUsers));
    }

    function checkUserNameExists(username, excludeId = null) {
      return allUsers.some(u => u.username.toLowerCase().trim() === username.toLowerCase().trim() && u.id !== excludeId);
    }

    function loadHiddenPoems() {
      if (!currentUser) return;
      const key = HIDDEN_KEY_PREFIX + '_' + currentUser.id;
      const stored = localStorage.getItem(key);
      if (stored) try { hiddenPoems = JSON.parse(stored); } catch (e) { hiddenPoems = []; }
    }

    function saveHiddenPoems() {
      if (!currentUser) return;
      const key = HIDDEN_KEY_PREFIX + '_' + currentUser.id;
      localStorage.setItem(key, JSON.stringify(hiddenPoems));
    }

    function isPoemHidden(poemId) {
      return hiddenPoems.includes(poemId);
    }

    function toggleHidePoem(poemId) {
      const index = hiddenPoems.indexOf(poemId);
      if (index > -1) hiddenPoems.splice(index, 1);
      else hiddenPoems.push(poemId);
      saveHiddenPoems();
    }

    function isOwnPoem(poem) {
      return poem.userId === currentUser.id;
    }

    function isOriginalModyPoem(poem) {
      return !poem.userId && !poem.createdBy;
    }

    function showSyncStatus(message, duration = 2000) {
      const syncStatus = document.getElementById('syncStatus');
      const syncText = document.getElementById('syncText');
      syncText.textContent = message;
      syncStatus.classList.add('show');
      setTimeout(() => syncStatus.classList.remove('show'), duration);
    }

    function showAlert(message) {
      document.getElementById('confirmMessage').textContent = message;
      document.getElementById('confirmButtons').innerHTML = '<button class="btn" onclick="document.getElementById(\'confirmModal\').classList.remove(\'show\')">Ø­Ø³Ù†Ø§Ù‹</button>';
      document.getElementById('confirmModal').classList.add('show');
    }
    
    function showConfirm(message, onConfirm) {
      document.getElementById('confirmMessage').textContent = message;
      const btns = document.getElementById('confirmButtons');
      btns.innerHTML = '';
      const btnCancel = document.createElement('button');
      btnCancel.className = 'btn';
      btnCancel.textContent = 'Ø¥Ù„ØºØ§Ø¡';
      btnCancel.onclick = () => document.getElementById('confirmModal').classList.remove('show');
      const btnOk = document.createElement('button');
      btnOk.className = 'btn';
      btnOk.textContent = 'ØªØ£ÙƒÙŠØ¯';
      btnOk.onclick = () => {
        document.getElementById('confirmModal').classList.remove('show');
        onConfirm();
      };
      btns.appendChild(btnCancel);
      btns.appendChild(btnOk);
      document.getElementById('confirmModal').classList.add('show');
    }

    function escapeHtml(text) {
      const d = document.createElement('div');
      d.textContent = text || '';
      return d.innerHTML;
    }

    function displayLoginProfiles() {
      const loginProfilesList = document.getElementById('loginProfilesList');
      loginProfilesList.innerHTML = '';
      
      if (allUsers.length === 0) {
        loginProfilesList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©<br/>Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</div>';
        return;
      }
      
      allUsers.forEach(user => {
        const item = document.createElement('div');
        item.className = 'profile-item';
        item.innerHTML = `
          <div class="profile-item-name">${escapeHtml(user.username)}</div>
          ${user.email ? '<div class="profile-item-email">' + escapeHtml(user.email) + '</div>' : ''}
        `;
        item.onclick = () => {
          selectedUserForLogin = user;
          document.getElementById('loginUserName').textContent = user.username;
          document.getElementById('loginForm').style.display = 'none';
          document.getElementById('passwordForm').style.display = 'block';
          document.getElementById('loginPassword').focus();
          document.getElementById('loginPasswordError').classList.remove('show');
        };
        loginProfilesList.appendChild(item);
      });
    }

    document.getElementById('signupUsername').addEventListener('input', function() {
      const username = this.value.trim();
      const errorDiv = document.getElementById('usernameError');
      
      if (username && checkUserNameExists(username)) {
        errorDiv.classList.add('show');
      } else {
        errorDiv.classList.remove('show');
      }
    });

    document.getElementById('signupPassword').addEventListener('input', function() {
      const password = this.value.trim();
      const errorDiv = document.getElementById('passwordError');
      
      if (password && password.length < 4) {
        errorDiv.classList.add('show');
      } else {
        errorDiv.classList.remove('show');
      }
    });

    document.getElementById('tabLogin').addEventListener('click', () => {
      document.getElementById('tabLogin').classList.add('active');
      document.getElementById('tabSignup').classList.remove('active');
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('signupForm').style.display = 'none';
      document.getElementById('passwordForm').style.display = 'none';
      displayLoginProfiles();
    });

    document.getElementById('tabSignup').addEventListener('click', () => {
      document.getElementById('tabSignup').classList.add('active');
      document.getElementById('tabLogin').classList.remove('active');
      document.getElementById('signupForm').style.display = 'block';
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('passwordForm').style.display = 'none';
      document.getElementById('usernameError').classList.remove('show');
      document.getElementById('passwordError').classList.remove('show');
    });

    document.getElementById('btnBackToProfiles').addEventListener('click', () => {
      document.getElementById('passwordForm').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
      selectedUserForLogin = null;
      document.getElementById('loginPassword').value = '';
      document.getElementById('loginPasswordError').classList.remove('show');
    });

    document.getElementById('btnSignup').addEventListener('click', async () => {
      const username = document.getElementById('signupUsername').value.trim();
      const password = document.getElementById('signupPassword').value.trim();
      const email = document.getElementById('signupEmail').value.trim();
      const bio = document.getElementById('signupBio').value.trim();

      document.getElementById('usernameError').classList.remove('show');
      document.getElementById('passwordError').classList.remove('show');

      if (!username) {
        showAlert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
        return;
      }

      if (!password) {
        document.getElementById('passwordError').classList.add('show');
        return;
      }

      if (password.length < 4) {
        document.getElementById('passwordError').classList.add('show');
        return;
      }

      if (checkUserNameExists(username)) {
        document.getElementById('usernameError').classList.add('show');
        return;
      }

      currentUser = {
        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        username: username,
        passwordHash: hashPassword(password),
        email: email,
        bio: bio,
        createdAt: new Date().toISOString()
      };

      allUsers.push(currentUser);
      saveAllUsers();
      localStorage.setItem(USER_KEY, JSON.stringify(currentUser));

      await saveUserToFirebase();

      document.getElementById('authModal').style.display = 'none';
      showUserInfo();
      init();
      showSyncStatus('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!', 2000);
    });

    document.getElementById('btnLoginSubmit').addEventListener('click', () => {
      const password = document.getElementById('loginPassword').value.trim();

      document.getElementById('loginPasswordError').classList.remove('show');

      if (!password) {
        showAlert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
        return;
      }

      if (hashPassword(password) !== selectedUserForLogin.passwordHash) {
        document.getElementById('loginPasswordError').classList.add('show');
        return;
      }

      currentUser = selectedUserForLogin;
      localStorage.setItem(USER_KEY, JSON.stringify(currentUser));

      document.getElementById('authModal').style.display = 'none';
      showUserInfo();
      init();
      showSyncStatus('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 2000);
    });

    document.getElementById('loginPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('btnLoginSubmit').click();
      }
    });

    function checkAuth() {
      const stored = localStorage.getItem(USER_KEY);
      if (stored) {
        try {
          currentUser = JSON.parse(stored);
          showUserInfo();
          return true;
        } catch (e) {
          localStorage.removeItem(USER_KEY);
        }
      }
      
      displayLoginProfiles();
      document.getElementById('authModal').style.display = 'flex';
      return false;
    }

    function showUserInfo() {
      document.getElementById('currentUserName').textContent = currentUser.username;
      document.getElementById('userInfoDisplay').style.display = 'block';
    }

    document.getElementById('btnLogout').addEventListener('click', () => {
      showConfirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ', () => {
        localStorage.removeItem(USER_KEY);
        location.reload();
      });
    });

   document.getElementById('btnDeleteProfile').addEventListener('click', () => {
      showConfirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠØŸ\n\nğŸ”´ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ù‚ØµØ§Ø¦Ø¯Ùƒ ÙˆØ§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ÙˆØ­Ø°Ù Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ.\n\nâš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!', async () => {
        try {
          showSyncStatus('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù...', 5000);
          
          // Delete all uploaded files from Firebase Storage
          try {
            const userMediaPath = `media/${currentUser.id}/`;
            const userFolderRef = storageRef(storage, userMediaPath);
            const filesList = await listAll(userFolderRef);
            
            let deletedCount = 0;
            for (const fileRef of filesList.items) {
              try {
                await deleteObject(fileRef);
                deletedCount++;
              } catch (error) {
                console.error('Error deleting file:', fileRef.fullPath, error);
              }
            }
            
            if (deletedCount > 0) {
              showSyncStatus(`ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù ${deletedCount} Ù…Ù„Ù...`, 3000);
            }
          } catch (error) {
            console.error('Error deleting user files from storage:', error);
          }
          
          // Delete poems from database
          poems = poems.filter(p => p.userId !== currentUser.id);
          await savePoemsToFirebase();
          
          // Delete user from database
          try {
            await set(ref(database, 'users/' + currentUser.id), null);
          } catch (error) {
            console.error('Error deleting user from Firebase:', error);
          }
          
          // Delete comments by this user
          try {
            const commentsSnapshot = await get(ref(database, 'comments'));
            if (commentsSnapshot.exists()) {
              const allComments = commentsSnapshot.val();
              for (const poemId in allComments) {
                for (const commentId in allComments[poemId]) {
                  if (allComments[poemId][commentId].userId === currentUser.id) {
                    await set(ref(database, `comments/${poemId}/${commentId}`), null);
                  }
                }
              }
            }
          } catch (error) {
            console.error('Error deleting user comments:', error);
          }
          
          // Remove from local storage
          allUsers = allUsers.filter(u => u.id !== currentUser.id);
          saveAllUsers();
          
          localStorage.removeItem(USER_KEY);
          const hiddenKey = HIDDEN_KEY_PREFIX + '_' + currentUser.id;
          localStorage.removeItem(hiddenKey);
          
          currentUser = null;
          hiddenPoems = [];
          
          showSyncStatus('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­', 2000);
          
          setTimeout(() => location.reload(), 2000);
        } catch (error) {
          console.error('Error deleting profile:', error);
          showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù: ' + error.message);
        }
      });
    });
    async function saveUserToFirebase() {
      try {
        await set(ref(database, 'users/' + currentUser.id), currentUser);
        console.log('âœ… User saved to Firebase');
      } catch (error) {
        console.error('User save error:', error);
      }
    }

    async function savePoemsToFirebase() {
      if (isUpdatingFromFirebase) return;
      try {
        showSyncStatus('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...');
        await set(ref(database, 'poems'), poems);
        showSyncStatus('âœ… ØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­!');
        console.log('âœ… Poems synced');
      } catch (error) {
        console.error('Sync error:', error);
        showSyncStatus('âŒ ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©', 3000);
      }
    }

    async function loadPoemsFromFirebase() {
      try {
        const snapshot = await get(ref(database, 'poems'));
        if (snapshot.exists()) {
          isUpdatingFromFirebase = true;
          poems = snapshot.val() || [];
          renderPoems();
          isUpdatingFromFirebase = false;
          console.log('âœ… Poems loaded:', poems.length);
        }
      } catch (error) {
        console.error('Load error:', error);
      }
    }

    function setupFirebaseListener() {
      const poemsRef = ref(database, 'poems');
      onValue(poemsRef, (snapshot) => {
        if (snapshot.exists() && !isUpdatingFromFirebase) {
          isUpdatingFromFirebase = true;
          poems = snapshot.val() || [];
          renderPoems();
          showSyncStatus('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù…Ù† Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø±!', 2000);
          isUpdatingFromFirebase = false;
        }
      });
    }

async function loadFromGitHub() {
      const urls = [
        'https://raw.githubusercontent.com/abdomedo2033-code/ModyPoetry/main/poems.json',
        'poems.json'
      ];

      for (let i = 0; i < urls.length; i++) {
        try {
          const response = await fetch(urls[i] + '?_=' + Date.now(), {cache: 'no-store'});
          if (!response.ok) throw new Error('fetch failed: ' + response.status);
          const data = await response.json();
          if (!Array.isArray(data)) throw new Error('poems.json must be an array');
          
          // Convert "audio" to "audios" array for consistency
          originalPoems = data.map(p => {
            const poem = {...p};
            
            // Handle both "audio" (singular) and "audios" (plural)
            if (poem.audio && !poem.audios) {
              poem.audios = Array.isArray(poem.audio) ? poem.audio : [poem.audio];
              delete poem.audio;
            } else if (!poem.audios) {
              poem.audios = [];
            } else if (!Array.isArray(poem.audios)) {
              poem.audios = [poem.audios];
            }
            
            return poem;
          });
          
          console.log('âœ… GitHub poems loaded:', originalPoems.length);
          return originalPoems;
        } catch (error) {
          console.warn('Failed to load from:', urls[i], error);
        }
      }
      return null;
    }
    async function uploadFileToStorage(file) {
      return new Promise((resolve, reject) => {
        const timestamp = Date.now();
        const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
        const path = `media/${currentUser.id}/${timestamp}_${safeName}`;
        
        const fileRef = storageRef(storage, path);
        const uploadTask = uploadBytesResumable(fileRef, file);

        document.getElementById('uploadProgress').classList.add('show');
        document.getElementById('uploadText').textContent = `Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;

        uploadTask.on('state_changed',
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            const fill = document.getElementById('progressFill');
            fill.style.width = progress + '%';
            fill.textContent = Math.round(progress) + '%';
          },
          (error) => {
            console.error('Upload error:', error);
            document.getElementById('uploadProgress').classList.remove('show');
            showAlert('âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: ' + error.message);
            reject(error);
          },
          async () => {
            try {
              const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
              document.getElementById('uploadProgress').classList.remove('show');
              document.getElementById('progressFill').style.width = '0%';
              showSyncStatus('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­!', 2000);
             resolve({
                url: downloadURL,
                path: path,  // â† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø£ØµÙ„ÙŠ
                name: file.name,
                size: file.size,
                type: file.type,
                uploadedBy: currentUser.username,
                uploadedAt: new Date().toISOString()
              });
            } catch (error) {
              reject(error);
            }
          }
        );
      });
    }

    document.getElementById('inputAudioFile').addEventListener('change', async function(e) {
      const files = e.target.files;
      for (const file of Array.from(files)) {
        try {
          const uploadedFile = await uploadFileToStorage(file);
          currentAudios.push(uploadedFile);
          renderAudiosInForm();
        } catch (error) {
          console.error('Upload failed:', error);
        }
      }
      e.target.value = '';
    });

    document.getElementById('btnAddAudioLink').addEventListener('click', function() {
      const link = document.getElementById('inputAudioLink').value.trim();
      if (!link) {
        showAlert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø·');
        return;
      }
      
      try {
        new URL(link);
        currentAudios.push({
          type: 'link',
          url: link,
          addedBy: currentUser.username,
          addedAt: new Date().toISOString()
        });
        renderAudiosInForm();
        document.getElementById('inputAudioLink').value = '';
        showSyncStatus('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø§Ø¨Ø·', 1500);
      } catch (e) {
        showAlert('âš ï¸ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­');
      }
    });

    function renderTagsInForm() {
      const display = document.getElementById('tagsDisplay');
      display.innerHTML = '';
      currentTags.forEach((tag, index) => {
        const badge = document.createElement('span');
        badge.className = 'tag-badge';
        badge.innerHTML = escapeHtml(tag) + ' <button type="button" onclick="window.removeTag(' + index + ')">Ã—</button>';
        display.appendChild(badge);
      });
    }

    function addTag() {
      const tag = document.getElementById('inputTagField').value.trim();
      if (tag && !currentTags.includes(tag)) {
        currentTags.push(tag);
        renderTagsInForm();
        document.getElementById('inputTagField').value = '';
      }
    }

    window.removeTag = function(index) {
      currentTags.splice(index, 1);
      renderTagsInForm();
    };

    document.getElementById('inputTagField').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        addTag();
      }
    });

    function renderAudiosInForm() {
      const display = document.getElementById('audioDisplay');
      display.innerHTML = '';
      currentAudios.forEach((audio, index) => {
        const item = document.createElement('div');
        item.className = 'audio-item';
        
        let displayText = '';
        let badge = '';
        
        if (audio.url && audio.type !== 'link') {
          const sizeMB = audio.size ? (audio.size / 1024 / 1024).toFixed(2) : '?';
          displayText = `ğŸ“¦ ${escapeHtml(audio.name)} (${sizeMB} MB)`;
          badge = '<span style="background:#28a745;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:6px">Firebase</span>';
        } else if (audio.type === 'link') {
          displayText = 'ğŸ”— ' + escapeHtml(audio.url.substring(0, 50) + (audio.url.length > 50 ? '...' : ''));
          badge = '<span style="background:#4a90e2;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:6px">Link</span>';
        }
        
        item.innerHTML = badge + displayText + ' <button type="button" onclick="window.removeAudio(' + index + ')">Ø­Ø°Ù</button>';
        display.appendChild(item);
      });
    }

    window.removeAudio = function(index) {
      currentAudios.splice(index, 1);
      renderAudiosInForm();
    };

    document.getElementById('menuToggle').addEventListener('click', function(e) {
      e.stopPropagation();
      document.getElementById('dropdownMenu').classList.toggle('show');
    });

    document.addEventListener('click', function(e) {
      if (!e.target.closest('.menu-container')) {
        document.getElementById('dropdownMenu').classList.remove('show');
      }
    });

    document.querySelectorAll('.menu-item').forEach(item => {
      item.addEventListener('click', () => {
        document.getElementById('dropdownMenu').classList.remove('show');
      });
    });

    function renderTags() {
      const tagSet = new Set();
      poems.forEach(p => {
        if (!isPoemHidden(p.id)) {
          (p.tags || []).forEach(t => tagSet.add(t));
        }
      });
      const tagsWrapper = document.getElementById('tagsWrapper');
      tagsWrapper.innerHTML = '';
      const allBtn = document.createElement('button');
      allBtn.className = 'tag';
      allBtn.textContent = 'Ø§Ù„ÙƒÙ„';
      if (!activeTag) allBtn.classList.add('active');
      allBtn.addEventListener('click', () => {
        activeTag = null;
        document.getElementById('searchInput').value = '';
        renderPoems();
      });
      tagsWrapper.appendChild(allBtn);
      Array.from(tagSet).sort().forEach(tag => {
        const btn = document.createElement('button');
        btn.className = 'tag';
        btn.textContent = tag;
        if (activeTag === tag) btn.classList.add('active');
        btn.addEventListener('click', () => {
          activeTag = tag;
          document.getElementById('searchInput').value = '';
          renderPoems();
        });
        tagsWrapper.appendChild(btn);
      });
    }

    function renderPoems() {
      const poemGrid = document.getElementById('poemGrid');
      const emptyState = document.getElementById('emptyState');
      const searchInput = document.getElementById('searchInput');
      const q = (searchInput.value || '').trim().toLowerCase();
      poemGrid.innerHTML = '';

      let filtered;
      if (activeTag) {
        filtered = poems.filter(p => (p.tags || []).includes(activeTag) && !isPoemHidden(p.id));
      } else {
        filtered = poems.filter(p => {
          if (isPoemHidden(p.id)) return false;
          if (!q) return true;
          const s = (p.title + ' ' + p.text + ' ' + (p.excerpt || '') + ' ' + (p.tags||[]).join(' ')).toLowerCase();
          return s.includes(q);
        });
      }

      if (filtered.length === 0) {
        emptyState.style.display = 'block';
        renderTags();
        return;
      } else {
        emptyState.style.display = 'none';
      }

      filtered.forEach(poem => {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.id = poem.id || ('p-' + (Math.random()*1e9|0));

        const tagsHtml = (poem.tags || []).slice(0,3).map(t => '<span class="card-tag">' + escapeHtml(t) + '</span>').join('');
const userIcon = poem.createdBy && poem.createdBy.toLowerCase().includes('mody') ? 'âœ’ï¸' : 'ğŸ‘¤';
const userBadge = poem.createdBy ? '<span class="muted" style="font-size:11px">' + userIcon + ' ' + escapeHtml(poem.createdBy) + '</span>' : '';    
        const audioCount = (poem.audios || []).length;
        const mediaBadge = audioCount > 0 ? '<span class="card-tag" style="background:#4a90e2;color:#fff">ğŸµ ' + audioCount + '</span>' : '';

        let authorDisplay = '';
        if (poem.author) {
          authorDisplay = '<span class="muted">âœ’ï¸ ' + escapeHtml(poem.author) + '</span>';
        }

        card.innerHTML = `
          <div class="drag-handle">â˜°</div>
          <div class="content">
            <h3>${escapeHtml(poem.title)}</h3>
            <div class="excerpt">${escapeHtml(poem.excerpt || poem.text.slice(0,120) + (poem.text.length>120?'...':''))}</div>
            <div class="card-footer">
              <div>${authorDisplay} ${userBadge}</div>
              <div class="card-tags">${tagsHtml} ${mediaBadge}</div>
            </div>
          </div>
        `;

        card.addEventListener('click', function(e) {
          if (isDragging) return;
          openModal(poem);
        });

        poemGrid.appendChild(card);
      });

      renderTags();
    }

    function getYouTubeEmbedUrl(url) {
      try {
        const urlObj = new URL(url);
        let videoId = null;
        
        if (urlObj.hostname.includes('youtube.com')) {
          videoId = urlObj.searchParams.get('v');
        } else if (urlObj.hostname.includes('youtu.be')) {
          videoId = urlObj.pathname.slice(1);
        }
        
        if (videoId) {
          return `https://www.youtube.com/embed/${videoId}`;
        }
      } catch (e) {
        console.error('Invalid YouTube URL:', e);
      }
      return null;
    }

    function getSoundCloudEmbedUrl(url) {
      if (url.includes('soundcloud.com')) {
        return `https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true`;
      }
      return null;
    }
function getAudioHtml(audio) {
      if (!audio) return '';
      
      // Handle string URLs (common in poems.json)
      let audioUrl = '';
      if (typeof audio === 'string') {
        audioUrl = audio;
      } else if (audio.url) {
        audioUrl = audio.url;
      } else {
        return '';
      }
      
      // Check for YouTube
      const youtubeEmbed = getYouTubeEmbedUrl(audioUrl);
      if (youtubeEmbed) {
        return `
          <div class="media-item">
            <iframe src="${youtubeEmbed}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
          </div>
        `;
      }
      
      // Check for SoundCloud
      const soundcloudEmbed = getSoundCloudEmbedUrl(audioUrl);
      if (soundcloudEmbed) {
        return `
          <div class="media-item">
            <iframe height="166" scrolling="no" frameborder="no" allow="autoplay" src="${soundcloudEmbed}"></iframe>
          </div>
        `;
      }
      
      // Check if it's a direct audio/video file
      const audioExtensions = ['.mp3', '.wav', '.ogg', '.m4a', '.aac', '.flac'];
      const videoExtensions = ['.mp4', '.webm', '.mov', '.avi', '.mkv'];
      const lowerUrl = audioUrl.toLowerCase();
      
      const isDirectAudio = audioExtensions.some(ext => lowerUrl.includes(ext));
      const isDirectVideo = videoExtensions.some(ext => lowerUrl.includes(ext));
      
      if (isDirectAudio) {
        return `
          <div class="media-item">
            <audio controls>
              <source src="${audioUrl}">
              Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØªÙŠØ©
            </audio>
          </div>
        `;
      }
      
      if (isDirectVideo) {
        return `
          <div class="media-item">
            <video controls>
              <source src="${audioUrl}">
              Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            </video>
          </div>
        `;
      }
      
      // For uploaded files from Firebase
      if (audio.url && audio.type && audio.name) {
        const isVideo = audio.type.startsWith('video/');
        
        if (isVideo) {
          return `
            <div class="media-item">
              <video controls>
                <source src="${audio.url}" type="${audio.type}">
              </video>
            </div>
          `;
        } else {
          return `
            <div class="media-item">
              <audio controls>
                <source src="${audio.url}" type="${audio.type}">
              </audio>
            </div>
          `;
        }
      }
      
      // Default: show as clickable link
      return `
        <div class="media-item">
          <div style="font-size:13px;color:var(--brown)">
            ğŸ”— <a href="${audioUrl}" target="_blank" style="color:var(--brown);text-decoration:underline">ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·</a>
          </div>
        </div>
      `;
    }
    async function loadCommentsFromFirebase(poemId) {
      try {
        const snapshot = await get(ref(database, `comments/${poemId}`));
        if (snapshot.exists()) {
          return Object.values(snapshot.val());
        }
        return [];
      } catch (error) {
        console.error('Error loading comments:', error);
        return [];
      }
    }

    async function saveCommentToFirebase(poemId, comment) {
      try {
        const commentId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        await set(ref(database, `comments/${poemId}/${commentId}`), comment);
        return true;
      } catch (error) {
        console.error('Error saving comment:', error);
        return false;
      }
    }

    async function deleteCommentFromFirebase(poemId, commentId) {
      try {
        await set(ref(database, `comments/${poemId}/${commentId}`), null);
        return true;
      } catch (error) {
        console.error('Error deleting comment:', error);
        return false;
      }
    }

    function formatTimeAgo(dateString) {
      const now = new Date();
      const date = new Date(dateString);
      const seconds = Math.floor((now - date) / 1000);
      
      if (seconds < 60) return 'Ø§Ù„Ø¢Ù†';
      if (seconds < 3600) return Math.floor(seconds / 60) + ' Ø¯Ù‚ÙŠÙ‚Ø©';
      if (seconds < 86400) return Math.floor(seconds / 3600) + ' Ø³Ø§Ø¹Ø©';
      if (seconds < 604800) return Math.floor(seconds / 86400) + ' ÙŠÙˆÙ…';
      if (seconds < 2592000) return Math.floor(seconds / 604800) + ' Ø£Ø³Ø¨ÙˆØ¹';
      return Math.floor(seconds / 2592000) + ' Ø´Ù‡Ø±';
    }

    async function renderComments(poemId, commentsContainer) {
      const comments = await loadCommentsFromFirebase(poemId);
      const commentsList = commentsContainer.querySelector('.comments-list');
      commentsList.innerHTML = '';
      
      if (comments.length === 0) {
        commentsList.innerHTML = '<div class="no-comments">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø¹Ø¯. ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ¹Ù„Ù‚! ğŸ’¬</div>';
        return;
      }
      
      comments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      comments.forEach(comment => {
        const commentDiv = document.createElement('div');
        commentDiv.className = 'comment';
        
        const canDelete = comment.userId === currentUser.id;
        const deleteButton = canDelete ? `<button class="comment-action-btn" onclick="window.deleteComment('${poemId}', '${comment.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>` : '';
        
        commentDiv.innerHTML = `
          <div class="comment-header">
            <span class="comment-author">${escapeHtml(comment.username)}</span>
            <span class="comment-time">${formatTimeAgo(comment.createdAt)}</span>
          </div>
          <div class="comment-text">${escapeHtml(comment.text)}</div>
          ${deleteButton ? '<div class="comment-actions">' + deleteButton + '</div>' : ''}
        `;
        
        commentsList.appendChild(commentDiv);
      });
    }

    window.deleteComment = async function(poemId, commentId) {
      showConfirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ØŸ', async () => {
        const success = await deleteCommentFromFirebase(poemId, commentId);
        if (success) {
          const modal = document.querySelector('.modal');
          const commentsContainer = modal.querySelector('.comments-section');
          await renderComments(poemId, commentsContainer);
          showSyncStatus('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚', 2000);
        } else {
          showAlert('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚');
        }
      });
    };

    async function openModal(poem) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      
      const tagsHtml = (poem.tags || []).map(t => '<span class="card-tag">' + escapeHtml(t) + '</span>').join('');

      const audiosHtml = (poem.audios || []).length > 0 
        ? '<div class="media-container">' + (poem.audios || []).map(audio => getAudioHtml(audio)).join('') + '</div>'
        : '';

const userIcon = poem.createdBy && poem.createdBy.toLowerCase().includes('mody') ? 'âœ’ï¸' : 'ğŸ‘¤';
const userInfo = poem.createdBy ? '<div class="muted" style="margin-top:4px">' + userIcon + ' Ø£Ø¶ÙŠÙØª Ø¨ÙˆØ§Ø³Ø·Ø©: ' + escapeHtml(poem.createdBy) + '</div>' : '';
      const canEdit = isOwnPoem(poem);
      const canDelete = isOwnPoem(poem);

      const editButton = canEdit ? '<button class="btn small" id="editPoem">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>' : '';
      const deleteButton = canDelete ? '<button class="btn small" id="deletePoem">ğŸ—‘ï¸ Ø­Ø°Ù</button>' : '';
      const hideButton = !canEdit ? '<button class="btn small" id="hidePoem">ğŸ™ˆ Ø¥Ø®ÙØ§Ø¡</button>' : '';

      let authorDisplay = '';
      if (poem.author) {
        authorDisplay = '<div class="muted" style="margin-top:6px">âœ’ï¸ ' + escapeHtml(poem.author) + '</div>';
      }

      modal.innerHTML = `
        <div class="modal-inner">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
            <div style="flex:1">
              <div class="modal-title">${escapeHtml(poem.title)}</div>
              ${authorDisplay}
              ${userInfo}
              ${tagsHtml ? '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">' + tagsHtml + '</div>' : ''}
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              ${editButton}
              ${deleteButton}
              ${hideButton}
              <button class="btn small" id="closeModal">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
          </div>
          <div class="poem-text">${escapeHtml(poem.text)}</div>
          ${audiosHtml}
          
          <div class="comments-section">
            <div class="comments-header">
              ğŸ’¬ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª (<span id="commentsCount">0</span>)
            </div>
            <div class="comment-form">
              <textarea class="comment-input" id="commentInput" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ Ù‡Ù†Ø§..."></textarea>
              <button class="comment-submit" id="submitComment">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</button>
            </div>
            <div class="comments-list"></div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      const commentsContainer = modal.querySelector('.comments-section');
      await renderComments(poem.id, commentsContainer);
      
      const comments = await loadCommentsFromFirebase(poem.id);
      modal.querySelector('#commentsCount').textContent = comments.length;

      modal.querySelector('#submitComment').addEventListener('click', async function() {
        const commentText = modal.querySelector('#commentInput').value.trim();
        
        if (!commentText) {
          showAlert('âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªØ¹Ù„ÙŠÙ‚');
          return;
        }
        
        const comment = {
          id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
          text: commentText,
          username: currentUser.username,
          userId: currentUser.id,
          createdAt: new Date().toISOString()
        };
        
        const success = await saveCommentToFirebase(poem.id, comment);
        
        if (success) {
          modal.querySelector('#commentInput').value = '';
          await renderComments(poem.id, commentsContainer);
          const updatedComments = await loadCommentsFromFirebase(poem.id);
          modal.querySelector('#commentsCount').textContent = updatedComments.length;
          showSyncStatus('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚', 2000);
        } else {
          showAlert('âŒ ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚');
        }
      });

      modal.querySelector('#commentInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && e.ctrlKey) {
          modal.querySelector('#submitComment').click();
        }
      });

      modal.querySelector('#closeModal').addEventListener('click', () => modal.remove());
      modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
      
      if (canEdit) {
        modal.querySelector('#editPoem').addEventListener('click', () => {
          editingPoem = poem;
          document.getElementById('inputTitle').value = poem.title || '';
          document.getElementById('inputAuthor').value = poem.author || '';
          document.getElementById('inputText').value = poem.text || '';
          document.getElementById('inputExcerpt').value = poem.excerpt || '';
          currentTags = poem.tags || [];
          renderTagsInForm();
          currentAudios = poem.audios || [];
          renderAudiosInForm();
          document.getElementById('modalFormTitle').textContent = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚ØµÙŠØ¯Ø©';
          document.getElementById('addModal').style.display = 'flex';
          modal.remove();
        });
      }
if (canDelete) {
        modal.querySelector('#deletePoem').addEventListener('click', () => {
          showConfirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù‚ØµÙŠØ¯Ø©ØŸ\n\nâš ï¸ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§ ÙˆØ§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†!', async () => {
            try {
              showSyncStatus('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...', 5000);
              
              // Delete uploaded files from Storage
              if (poem.audios && poem.audios.length > 0) {
                let deletedFiles = 0;
                let failedFiles = 0;
                
                for (const audio of poem.audios) {
                  // Only delete files uploaded to Firebase Storage (not external links)
                  if (audio.url && audio.url.includes('firebasestorage.googleapis.com')) {
                    try {
                      // Method 1: Extract path from URL
                      const url = new URL(audio.url);
                      let filePath = null;
                      
                      // Try to extract from pathname: /v0/b/bucket/o/path%2Fto%2Ffile
                      const pathMatch = url.pathname.match(/\/o\/(.+?)(?:\?|$)/);
                      if (pathMatch) {
                        filePath = decodeURIComponent(pathMatch[1]);
                      }
                      
                      // Alternative: if we have the original upload path stored
                      if (!filePath && audio.path) {
                        filePath = audio.path;
                      }
                      
                      // Alternative: reconstruct path from known structure
                      if (!filePath && audio.name && poem.userId) {
                        // Try to find the file in user's media folder
                        const userMediaPath = `media/${poem.userId}/`;
                        const userFolderRef = storageRef(storage, userMediaPath);
                        const filesList = await listAll(userFolderRef);
                        
                        // Find file by matching URL
                        for (const fileRef of filesList.items) {
                          const fileUrl = await getDownloadURL(fileRef);
                          if (fileUrl === audio.url) {
                            filePath = fileRef.fullPath;
                            break;
                          }
                        }
                      }
                      
                      if (filePath) {
                        console.log('ğŸ” Attempting to delete file:', filePath);
                        const fileRef = storageRef(storage, filePath);
                        await deleteObject(fileRef);
                        deletedFiles++;
                        console.log('âœ… Successfully deleted file:', filePath);
                      } else {
                        console.warn('âš ï¸ Could not extract file path from URL:', audio.url);
                        failedFiles++;
                      }
                      
                    } catch (error) {
                      console.error('âŒ Error deleting file:', audio.url, error);
                      failedFiles++;
                    }
                  }
                }
                
                if (deletedFiles > 0) {
                  showSyncStatus(`ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù ${deletedFiles} Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©`, 2000);
                }
                
                if (failedFiles > 0) {
                  console.warn(`âš ï¸ ÙØ´Ù„ Ø­Ø°Ù ${failedFiles} Ù…Ù„Ù`);
                }
              }
              
              // Delete comments for this poem
              try {
                await set(ref(database, `comments/${poem.id}`), null);
                console.log('âœ… Deleted comments for poem:', poem.id);
              } catch (error) {
                console.error('Error deleting comments:', error);
              }
              
              // Delete poem from local array
              poems = poems.filter(p => p.id !== poem.id);
              
              // Save updated poems array to Firebase (this will remove the poem from database)
              await savePoemsToFirebase();
              
              renderPoems();
              modal.remove();
              showSyncStatus('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚ØµÙŠØ¯Ø© ÙˆØ§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©', 2500);
            } catch (error) {
              console.error('Error deleting poem:', error);
              showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: ' + error.message);
            }
          });
        });
      }
      
      if (!canEdit && modal.querySelector('#hidePoem')) {
        modal.querySelector('#hidePoem').addEventListener('click', () => {
          toggleHidePoem(poem.id);
          renderPoems();
          modal.remove();
          showSyncStatus('âœ… ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚ØµÙŠØ¯Ø© Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ', 2000);
        });
      }
      
      document.addEventListener('keydown', function esc(e){ 
        if (e.key === 'Escape') { 
          modal.remove(); 
          document.removeEventListener('keydown', esc); 
        }
      });
    }

    let sortableInstance = null;
    function initSortable() {
      const poemGrid = document.getElementById('poemGrid');
      if (!poemGrid) return;
      if (sortableInstance && typeof sortableInstance.destroy === 'function') {
        try { sortableInstance.destroy(); } catch(e){}
      }
      sortableInstance = new Sortable(poemGrid, {
        animation: 200,
        handle: '.drag-handle',
        dataIdAttr: 'data-id',
        onStart: () => { isDragging = true; },
        onEnd: () => {
          const ids = Array.from(poemGrid.children).map(c => c.dataset.id).filter(Boolean);
          const newOrder = [];
          ids.forEach(id => {
            const found = poems.find(p => p.id === id);
            if (found) newOrder.push(found);
          });
          const missing = poems.filter(p => !ids.includes(p.id));
          poems = newOrder.concat(missing);
          savePoemsToFirebase();
          setTimeout(() => isDragging = false, 80);
        }
      });
    }

    document.getElementById('searchInput').addEventListener('input', () => {
      activeTag = null;
      renderPoems();
    });

    document.getElementById('btnDownload').addEventListener('click', () => {
      const a = document.createElement('a');
      const blob = new Blob([JSON.stringify(poems, null, 2)], {type: 'application/json'});
      a.href = URL.createObjectURL(blob);
      a.download = 'mody_poems_' + Date.now() + '.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
    });
document.getElementById('btnReloadAndSort').addEventListener('click', async () => {
      showConfirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ù‚ØµØ§Ø¦Ø¯ Ù…ÙˆØ¯ÙŠ Ù…Ù† GitHubØŸ', async () => {
        showSyncStatus('ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚ØµØ§Ø¦Ø¯ Ù…ÙˆØ¯ÙŠ...', 3000);
        
        const githubPoems = await loadFromGitHub();
        
        if (!githubPoems) {
          showAlert('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ GitHub.');
          return;
        }
        const currentMap = new Map(poems.map(p => [p.id, p]));
        let added = 0;
        let updated = 0;
        let restored = 0;
        
        githubPoems.forEach(orig => {
          // Restore hidden original poems
          if (isPoemHidden(orig.id)) {
            toggleHidePoem(orig.id);
            restored++;
          }
          
          if (!currentMap.has(orig.id)) {
            // Add new poem from GitHub
            poems.push({...orig});
            added++;
          } else {
            // Update existing original Mody poems only
            const existing = currentMap.get(orig.id);
            if (isOriginalModyPoem(existing)) {
              existing.title = orig.title;
              existing.author = orig.author;
              existing.text = orig.text;
              existing.excerpt = orig.excerpt;
              existing.tags = orig.tags || [];
              existing.audios = orig.audios || [];
              updated++;
            }
          }
        });
        
        await savePoemsToFirebase();
        renderPoems();
        showAlert(`âœ… ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ‰ Ø£ÙØ¶ÙŠÙ: ${added} Ù‚ØµÙŠØ¯Ø© Ø¬Ø¯ÙŠØ¯Ø©\nğŸ”„ Ø­ÙØ¯Ù‘Ø«: ${updated} Ù‚ØµÙŠØ¯Ø©\nğŸ”“ Ø§Ø³ØªÙØ¹ÙŠØ¯: ${restored} Ù‚ØµÙŠØ¯Ø© Ù…Ø®ÙÙŠØ©\nğŸ“‹ Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ØµØ§Ø¦Ø¯ Ø§Ù„ÙƒÙ„ÙŠ: ${poems.length}`);
      });
    });
    document.getElementById('btnImportJSON').addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
          try {
            const data = JSON.parse(evt.target.result);
            if (!Array.isArray(data)) throw new Error('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù Ù…ØµÙÙˆÙØ©');
            const currentIds = new Set(poems.map(p => p.id));
            let added = 0;
            data.forEach(p => {
              if (!p.id) p.id = 'p-' + Date.now() + Math.random();
              if (!currentIds.has(p.id)) {
                if (!p.createdBy) {
                  p.createdBy = currentUser.username + ' (Ù…Ø³ØªÙˆØ±Ø¯)';
                  p.userId = currentUser.id;
                  p.importedAt = new Date().toISOString();
                }
                poems.push({...p});
                added++;
              }
            });
            if (added > 0) {
              savePoemsToFirebase();
              renderPoems();
            }
            showAlert(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${added} Ù‚ØµÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ù…Ù„Ù\n\nğŸ“ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ØµØ§Ø¦Ø¯ Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© ØªØ­Ù…Ù„ Ø§Ø³Ù…Ùƒ: "${currentUser.username} (Ù…Ø³ØªÙˆØ±Ø¯)"`);
          } catch (err) {
            showAlert('Ø®Ø·Ø£: ' + err.message);
          }
        };
        reader.readAsText(file);
      };
      input.click();
    });

    document.getElementById('btnAdd').addEventListener('click', () => {
      editingPoem = null;
      document.getElementById('poemForm').reset();
      currentTags = [];
      currentAudios = [];
      renderTagsInForm();
      renderAudiosInForm();
      document.getElementById('modalFormTitle').textContent = 'âœï¸ Ø£Ø¶Ù Ù‚ØµÙŠØ¯Ø©';
      document.getElementById('addModal').style.display = 'flex';
    });
    
    document.getElementById('btnCancelAdd').addEventListener('click', () => {
      editingPoem = null;
      document.getElementById('addModal').style.display = 'none';
      document.getElementById('poemForm').reset();
      currentTags = [];
      currentAudios = [];
      renderTagsInForm();
      renderAudiosInForm();
    });
    
    document.getElementById('poemForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const poemData = {
        title: document.getElementById('inputTitle').value.trim() || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†',
        author: document.getElementById('inputAuthor').value.trim(),
        text: document.getElementById('inputText').value.trim(),
        excerpt: document.getElementById('inputExcerpt').value.trim(),
        tags: currentTags,
        audios: currentAudios,
        createdBy: currentUser.username,
        userId: currentUser.id,
        createdAt: new Date().toISOString()
      };
      
      if (editingPoem) {
        const index = poems.findIndex(p => p.id === editingPoem.id);
        if (index !== -1) {
          poems[index] = { ...poemData, id: editingPoem.id };
        }
        editingPoem = null;
      } else {
        poemData.id = 'p-' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        poems.unshift(poemData);
      }
      
      savePoemsToFirebase();
      renderPoems();
      document.getElementById('addModal').style.display = 'none';
      this.reset();
      currentTags = [];
      currentAudios = [];
      renderTagsInForm();
      renderAudiosInForm();
    });

    async function init() {
      loadAllUsers();
      await loadAllUsersFromFirebase();
      
      if (!checkAuth()) {
        return;
      }
      
      loadHiddenPoems();
      await loadPoemsFromFirebase();
      setupFirebaseListener();
      renderPoems();
      initSortable();
      showSyncStatus('âœ… Ù…ØªØµÙ„ Ù…Ø¹ Firebase!', 2000);
    }

    init();
  </script>
</body>
</html>
