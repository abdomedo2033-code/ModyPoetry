async function loadConversation(withUserId) {
  await ensureConversationMeta(withUserId);
  const withUser = allUsers.find(u => u.id === withUserId);
  const convId = getConversationId(currentUser.id, withUserId);
  currentConversationId = convId;

  headerEl.innerHTML = `
    <img src="${withUser?.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(withUser?.username||'مستخدم')}&background=8b5e3c&color=fff&size=32`}" class="avatar-small" style="cursor:pointer" onclick="window.openUserProfile('${withUserId}')" />
    <div style="font-weight:700;color:var(--accent);cursor:pointer" onclick="window.openUserProfile('${withUserId}')">${escapeHtml(withUser?.username || '')}</div>
  `;

  messagesEl.innerHTML = '<div style="padding:10px;color:var(--muted)">جارِ التحميل...</div>';

  const typingRef = ref(database, `dm_typing/${convId}/${withUserId}`);
  onValue(typingRef, (snapshot) => {
    const typingData = snapshot.val();
    const indicator = modal.querySelector('#dmTypingIndicator');
    if (typingData && typingData.typing && (Date.now() - typingData.timestamp < 4000)) {
      indicator.classList.add('show');
    } else {
      indicator.classList.remove('show');
    }
  });

  // Detach previous conversation listener
  if (typeof dmMessagesUnsubscribe === 'function') {
    dmMessagesUnsubscribe();
    dmMessagesUnsubscribe = null;
  }

  // Reset pagination
  dmMessagesLimit = 20;
  allDMMessages = [];
  let renderedMessageIds = new Set();
  let isFirstLoad = true;

  // Attach real-time messages listener
  const messagesRef = ref(database, `dm_messages/${convId}`);

  dmMessagesUnsubscribe = onValue(messagesRef, async (msgsSnap) => {
    if (!msgsSnap.exists()) {
      messagesEl.innerHTML = '<div style="padding:10px;color:var(--muted)">ابدأ المحادثة برسالة أولى.</div>';
      allDMMessages = [];
      renderedMessageIds.clear();
      return;
    }

    allDMMessages = Object.values(msgsSnap.val()).sort((a,b)=> new Date(a.timestamp)-new Date(b.timestamp));
    
    // Mark unread as read (non-blocking)
    const unread = allDMMessages.filter(m => m.fromId !== currentUser.id && !m.read);
    if (unread.length > 0) {
      Promise.all(unread.map(m => set(ref(database, `dm_messages/${convId}/${m.id}/read`), true)))
        .catch(err => console.error('Error marking messages as read:', err));
    }

    const wasAtBottom = messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight < 100;

    // First load: render initial messages
    if (isFirstLoad) {
      renderDMMessages(convId, withUser);
      isFirstLoad = false;
      setTimeout(() => {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }, 100);
      await set(ref(database, `dm_conversations/${currentUser.id}/${convId}/unreadCount`), 0);
      return;
    }

    // Incremental updates: only update changed messages
    const currentMessageIds = new Set(allDMMessages.map(m => m.id));
    
    // Remove deleted messages from DOM
    document.querySelectorAll('.dm-message').forEach(msgEl => {
      const msgId = msgEl.dataset.messageId;
      if (msgId && !currentMessageIds.has(msgId)) {
        msgEl.remove();
        renderedMessageIds.delete(msgId);
      }
    });

    // Update or add new messages
    allDMMessages.slice(-dmMessagesLimit).forEach((m) => {
      const existingDiv = document.querySelector(`[data-message-id="${m.id}"]`);
      
      if (!existingDiv) {
        // New message - add it
        const div = buildMessageElement(m, convId, withUser, allDMMessages);
        messagesEl.appendChild(div);
        renderedMessageIds.add(m.id);
      } else {
        // Update existing message (for reactions, edits, read status)
        updateMessageElement(existingDiv, m, convId, allDMMessages);
      }
    });

    // Auto-scroll only if user was at bottom
    if (wasAtBottom) {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    await set(ref(database, `dm_conversations/${currentUser.id}/${convId}/unreadCount`), 0);
  });

  // Setup scroll listener for loading more messages
  setupDMScrollListener(messagesEl, convId, withUser);

  const dmTextarea = modal.querySelector('#dmText');
  const dmContent = modal.querySelector('.dm-content');
  setupMentionAutocomplete(dmTextarea, dmContent);

  // Auto-resize textarea
  dmTextarea.addEventListener('input', function() {
    this.style.height = '20px';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
  });

  // ... rest of the function (send button, etc.)
}
