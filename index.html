<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mody Poetry</title>
  <meta name="description" content="مجموعة الشعر الذهبية" />
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-gradient-1:#fff8f0;
      --bg-gradient-2:#fef3e8;
      --card:#ffffff;
      --card-hover:#fffbf5;
      --muted:#8b7355;
      --accent:#3a1f0b;
      --brown:#8b5e3c;
      --brown-hover:#a67c52;
      --text:#2e1a0f;
      --shadow:rgba(58,31,11,0.08);
      --shadow-lg:rgba(58,31,11,0.12);
      --border:#e8dcc8;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow-x:hidden}
    body{
      font-family:'Cairo',system-ui,sans-serif;
      background:linear-gradient(135deg,var(--bg-gradient-1) 0%,var(--bg-gradient-2) 100%);
      background-attachment:fixed;
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.7;
      padding:0;
    }
    .container{max-width:1100px;margin:0 auto;padding:20px}
    
    /* Header */
    header{
      background:var(--card);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--border);
      position:sticky;
      top:0;
      z-index:100;
      box-shadow:0 4px 20px var(--shadow);
      animation:slideDown 0.5s ease;
    }
    @keyframes slideDown{from{transform:translateY(-100%)}to{transform:translateY(0)}}
    .header-content{
      max-width:1100px;
      margin:0 auto;
      padding:18px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .brand-icon{
      width:48px;
      height:48px;
      background:transparent;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:32px;
      box-shadow:none;
    }
    .brand h1{font-size:22px;font-weight:700;color:var(--accent);letter-spacing:0.3px}
    .brand p{font-size:13px;color:var(--muted);margin-top:2px}
    nav{display:flex;gap:10px}
    
    /* Buttons - Brownish Style */
    .btn{
      padding:10px 18px;
      border-radius:8px;
      text-decoration:none;
      font-size:14px;
      font-weight:500;
      cursor:pointer;
      border:1.5px solid var(--brown);
      transition:all 0.3s ease;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:#fff;
      color:#5a3f2a;
    }
    .btn-primary{
      background:#fff;
      color:#5a3f2a;
      border:1.5px solid var(--brown);
    }
    .btn-primary:hover{
      background:#f5ebe0;
      border-color:var(--brown-hover);
    }
    .btn-secondary{
      background:#fff;
      color:#5a3f2a;
      border:1.5px solid var(--brown);
    }
    .btn-secondary:hover{
      background:#f5ebe0;
      border-color:var(--brown-hover);
    }
    
    /* Hero Search */
    .hero{
      background:linear-gradient(135deg,rgba(255,255,255,0.9) 0%,rgba(255,251,245,0.9) 100%);
      backdrop-filter:blur(10px);
      border-radius:20px;
      padding:28px;
      margin:24px 0;
      box-shadow:0 8px 32px var(--shadow-lg);
      border:1px solid var(--border);
      animation:fadeIn 0.6s ease;
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .search-wrapper{
      display:flex;
      gap:10px;
      margin-bottom:18px;
      flex-wrap:wrap;
    }
    input[type="search"]{
      flex:1;
      min-width:250px;
      padding:10px 16px;
      border-radius:8px;
      border:1.5px solid #e8dcc8;
      font-size:15px;
      font-family:'Cairo',sans-serif;
      transition:all 0.3s ease;
      background:#fff;
    }
    input[type="search"]:focus{
      outline:none;
      border-color:var(--brown);
      box-shadow:0 0 0 3px rgba(139,94,60,0.1);
    }
    .tags-wrapper{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tags-label{
      font-size:14px;
      color:var(--muted);
      font-weight:600;
    }
    .tag{
      padding:8px 16px;
      border-radius:8px;
      font-size:13px;
      font-weight:500;
      cursor:pointer;
      transition:all 0.3s ease;
      border:1.5px solid #d4c4b0;
      background:#fff;
      color:#5a3f2a;
    }
    .tag:hover,.tag.active{
      background:#f5ebe0;
      border-color:var(--brown);
    }
    
    /* Grid */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
      gap:20px;
      margin-top:24px;
      animation:fadeIn 0.8s ease;
    }
    .card{
      background:var(--card);
      border-radius:16px;
      padding:20px;
      box-shadow:0 4px 20px var(--shadow);
      border:1px solid var(--border);
      transition:all 0.3s ease;
      cursor:pointer;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:'';
      position:absolute;
      top:0;
      right:0;
      width:100%;
      height:4px;
      background:linear-gradient(90deg,var(--brown) 0%,var(--brown-hover) 100%);
      transform:scaleX(0);
      transform-origin:right;
      transition:transform 0.3s ease;
    }
    .card:hover{
      transform:translateY(-4px);
      box-shadow:0 8px 32px var(--shadow-lg);
      background:var(--card-hover);
    }
    .card:hover::before{
      transform:scaleX(1);
    }
    .card h3{
      font-family:'Amiri',serif;
      font-size:20px;
      margin-bottom:10px;
      color:var(--accent);
      font-weight:700;
    }
    .excerpt{
      font-family:'Amiri',serif;
      color:var(--muted);
      margin-bottom:14px;
      line-height:2;
      font-size:15px;
      min-height:60px;
    }
    .card-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
      padding-top:14px;
      border-top:1px solid var(--border);
    }
    .author{
      font-size:13px;
      color:var(--muted);
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .card-tags{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .card-tag{
      padding:4px 10px;
      border-radius:12px;
      font-size:11px;
      font-weight:600;
      background:rgba(139,94,60,0.15);
      color:var(--brown);
    }
    
    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      backdrop-filter:blur(8px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:1000;
      animation:modalFadeIn 0.3s ease;
    }
    @keyframes modalFadeIn{from{opacity:0}to{opacity:1}}
    .modal-inner{
      background:var(--card);
      max-width:800px;
      width:100%;
      border-radius:20px;
      padding:32px;
      max-height:90vh;
      overflow:auto;
      box-shadow:0 20px 60px rgba(0,0,0,0.3);
      animation:modalSlideUp 0.4s ease;
      border:1px solid var(--border);
    }
    @keyframes modalSlideUp{from{transform:translateY(40px);opacity:0}to{transform:translateY(0);opacity:1}}
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:20px;
      margin-bottom:24px;
      padding-bottom:20px;
      border-bottom:2px solid var(--border);
    }
    .modal-title{
      font-family:'Amiri',serif;
      font-size:28px;
      color:var(--accent);
      font-weight:700;
      margin-bottom:10px;
    }
    .modal-meta{
      color:var(--muted);
      font-size:14px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .poem-text{
      font-family:'Amiri',serif;
      white-space:pre-line;
      font-size:18px;
      line-height:2.5;
      margin-bottom:24px;
      color:var(--text);
      text-align:justify;
    }
    
    /* Form */
    .form-section{
      background:var(--card);
      border-radius:20px;
      padding:28px;
      margin-top:24px;
      box-shadow:0 8px 32px var(--shadow-lg);
      border:1px solid var(--border);
      animation:fadeIn 0.6s ease;
    }
    .form-title{
      font-size:22px;
      font-weight:700;
      color:var(--accent);
      margin-bottom:20px;
    }
    .form-group{
      margin-bottom:16px;
    }
    .form-group label{
      display:block;
      font-size:14px;
      font-weight:600;
      color:var(--text);
      margin-bottom:8px;
    }
    input[type="text"],textarea{
      width:100%;
      padding:10px 16px;
      border-radius:8px;
      border:1.5px solid #e8dcc8;
      font-size:15px;
      font-family:'Cairo',sans-serif;
      transition:all 0.3s ease;
      background:#fff;
    }
    input[type="text"]:focus,textarea:focus{
      outline:none;
      border-color:var(--brown);
      box-shadow:0 0 0 3px rgba(139,94,60,0.1);
    }
    textarea{
      min-height:160px;
      resize:vertical;
      font-family:'Amiri',serif;
      line-height:2;
    }
    .form-actions{
      display:flex;
      gap:12px;
      justify-content:flex-end;
      margin-top:24px;
    }
    
    /* Empty State */
    .empty-state{
      text-align:center;
      padding:60px 20px;
      background:var(--card);
      border-radius:20px;
      border:2px dashed var(--border);
      margin:24px 0;
    }
    .empty-icon{
      font-size:64px;
      margin-bottom:16px;
      opacity:0.5;
    }
    .empty-title{
      font-size:20px;
      font-weight:600;
      color:var(--text);
      margin-bottom:8px;
    }
    .empty-text{
      font-size:15px;
      color:var(--muted);
    }
    
    /* Footer */
    footer{
      text-align:center;
      color:var(--muted);
      margin-top:48px;
      padding:24px;
      font-size:14px;
    }
    
    /* Responsive */
    @media (max-width:768px){
      .header-content{flex-direction:column;align-items:stretch}
      nav{justify-content:stretch}
      .btn{flex:1;justify-content:center}
      .grid{grid-template-columns:1fr}
      .search-wrapper{flex-direction:column}
      input[type="search"]{min-width:100%}
      .modal-inner{padding:24px}
      .modal-title{font-size:24px}
      .poem-text{font-size:16px;line-height:2.3}
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="brand">
        <div class="brand-icon">☕</div>
        <div>
          <h1>Mody Poetry</h1>
          <p>قصائدي الذهبية — اضف وشارك واستمع</p>
        </div>
      </div>
      <nav>
        <button class="btn btn-secondary" id="btnList" style="display:none">📚 القصائد</button>
        <button class="btn btn-primary" id="btnAdd">✍️ أضف قصيدة</button>
      </nav>
    </div>
  </header>

  <div class="container">
    <section class="hero" id="heroSection">
      <div class="search-wrapper">
        <input id="searchInput" type="search" placeholder="🔍 ابحث في النصوص..." />
        <button class="btn btn-primary" id="btnDownload">💾 تحميل JSON</button>
      </div>
      <div id="tagsWrapper" class="tags-wrapper" style="margin-top:16px"></div>
    </section>

    <section id="listSection">
      <div id="poemGrid" class="grid"></div>
      <div id="emptyState" class="empty-state" style="display:none">
        <div class="empty-icon">📜</div>
        <div class="empty-title">لا توجد قصائد بعد</div>
        <div class="empty-text">ابدأ بإضافة أول قصيدة من زر "أضف قصيدة"</div>
      </div>
    </section>

    <section id="addSection" class="form-section" style="display:none">
      <h2 class="form-title">✍️ أضف قصيدة جديدة</h2>
      <form id="poemForm">
        <div class="form-group">
          <label>عنوان القصيدة *</label>
          <input type="text" id="inputTitle" placeholder="مثال: أنين السَّحَر" required />
        </div>
        <div class="form-group">
          <label>المؤلف / الراوي</label>
          <input type="text" id="inputAuthor" placeholder="مثال: مودي" />
        </div>
        <div class="form-group">
          <label>نص القصيدة *</label>
          <textarea id="inputText" placeholder="اكتب القصيدة هنا... (سطر جديد = سطر جديد)" required></textarea>
        </div>
        <div class="form-group">
          <label>مقتطف (اختياري)</label>
          <input type="text" id="inputExcerpt" placeholder="مقتطف قصير من القصيدة" />
        </div>
        <div class="form-group">
          <label>رابط الملف الصوتي</label>
          <input type="text" id="inputAudio" placeholder="https://example.com/audio.mp3" />
        </div>
        <div class="form-group">
          <label>الوسوم (مفصولة بفواصل)</label>
          <input type="text" id="inputTags" placeholder="مثال: حب, إيماني, حزن" />
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="btnReset">مسح الحقول</button>
          <button type="submit" class="btn btn-primary">نشر القصيدة 📤</button>
        </div>
      </form>
    </section>
  </div>

  <footer>
    © <span id="year"></span> مَجْنُونُ الشِّعر — All rights reserved
  </footer>

  <script>
    const STORAGE_KEY = 'mody_poems_v2';
    let poems = [];
    let currentFilter = '';
    let activeTag = null;

    // DOM Elements
    const poemGrid = document.getElementById('poemGrid');
    const emptyState = document.getElementById('emptyState');
    const listSection = document.getElementById('listSection');
    const addSection = document.getElementById('addSection');
    const searchInput = document.getElementById('searchInput');
    const tagsWrapper = document.getElementById('tagsWrapper');
    const poemForm = document.getElementById('poemForm');

    // Initialize
    function init() {
      loadPoems();
      setupEventListeners();
      document.getElementById('year').textContent = new Date().getFullYear();
    }

    // Load poems from localStorage or fetch
    function loadPoems() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          poems = JSON.parse(stored);
          renderPoems();
          renderTags();
        } else {
          // Try to load from poems.json file
          fetch('poems.json')
            .then(r => r.ok ? r.json() : Promise.reject('File not found'))
            .then(data => {
              poems = data;
              savePoems();
              renderPoems();
              renderTags();
            })
            .catch(() => {
              poems = [];
              renderPoems();
              renderTags();
            });
        }
      } catch (e) {
        poems = [];
        renderPoems();
        renderTags();
      }
    }

    // Save poems to localStorage
    function savePoems() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(poems));
      } catch (e) {
        console.error('Failed to save poems:', e);
      }
    }

    // Render poems grid
    function renderPoems() {
      const query = currentFilter.trim().toLowerCase();
      let filtered = poems;

      if (query) {
        filtered = poems.filter(p => {
          const searchText = `${p.title} ${p.text} ${p.excerpt || ''} ${(p.tags || []).join(' ')}`.toLowerCase();
          return searchText.includes(query);
        });
      }

      if (activeTag) {
        filtered = filtered.filter(p => (p.tags || []).includes(activeTag));
      }

      poemGrid.innerHTML = '';

      if (poems.length === 0) {
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';

      if (filtered.length === 0) {
        poemGrid.innerHTML = '<div class="empty-state"><div class="empty-title">لا توجد نتائج</div><div class="empty-text">حاول البحث بكلمات مختلفة</div></div>';
        return;
      }

      filtered.forEach(poem => {
        const card = createPoemCard(poem);
        poemGrid.appendChild(card);
      });
    }

    // Create poem card
    function createPoemCard(poem) {
      const card = document.createElement('div');
      card.className = 'card';
      
      const excerpt = poem.excerpt || poem.text.slice(0, 120) + (poem.text.length > 120 ? '...' : '');
      const tags = (poem.tags || []).map(t => `<span class="card-tag">${escapeHtml(t)}</span>`).join('');
      
      card.innerHTML = `
        <h3>${escapeHtml(poem.title)}</h3>
        <div class="excerpt">${escapeHtml(excerpt)}</div>
        <div class="card-footer">
          <div>
            ${poem.author ? `<div class="author">✒️ ${escapeHtml(poem.author)}</div>` : ''}
            ${tags ? `<div class="card-tags">${tags}</div>` : ''}
          </div>
        </div>
      `;
      
      card.addEventListener('click', () => openModal(poem));
      return card;
    }

    // Open poem modal
    function openModal(poem) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      
      const tags = (poem.tags || []).join(' • ');
      const audioHtml = poem.audio ? getAudioHtml(poem.audio) : '';
      
      modal.innerHTML = `
        <div class="modal-inner">
          <div class="modal-header">
            <div>
              <h2 class="modal-title">${escapeHtml(poem.title)}</h2>
              <div class="modal-meta">
                ${poem.author ? `<span>✒️ ${escapeHtml(poem.author)}</span>` : ''}
                ${tags ? `<span>• ${escapeHtml(tags)}</span>` : ''}
              </div>
            </div>
            <button class="btn btn-secondary" id="closeModal">✖️ إغلاق</button>
          </div>
          <div class="poem-text">${escapeHtml(poem.text)}</div>
          ${audioHtml}
        </div>
      `;
      
      document.body.appendChild(modal);
      
      modal.querySelector('#closeModal').addEventListener('click', () => {
        modal.remove();
        document.removeEventListener('keydown', escapeHandler);
      });
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
          document.removeEventListener('keydown', escapeHandler);
        }
      });
      
      // Close on Escape key
      const escapeHandler = (e) => {
        if (e.key === 'Escape') {
          modal.remove();
          document.removeEventListener('keydown', escapeHandler);
        }
      };
      document.addEventListener('keydown', escapeHandler);
    }

    // Get audio HTML
    function getAudioHtml(audio) {
      if (audio.includes('soundcloud.com') && !audio.includes('<iframe')) {
        return `<iframe width="100%" height="166" scrolling="no" frameborder="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=${encodeURIComponent(audio)}&color=%238b5e3c&auto_play=false&hide_related=true&show_comments=false&show_user=true&show_reposts=false&show_teaser=false"></iframe>`;
      } else if (audio.includes('<iframe')) {
        return audio;
      } else {
        return `<audio controls preload="metadata" style="width:100%;border-radius:12px"><source src="${audio}"></audio>`;
      }
    }

    // Render tags
    function renderTags() {
      const tagSet = new Set();
      poems.forEach(p => (p.tags || []).forEach(t => tagSet.add(t)));
      
      tagsWrapper.innerHTML = '<span class="tags-label">🏷️ الوسوم:</span>';
      
      const allTag = document.createElement('button');
      allTag.className = 'tag';
      allTag.textContent = 'الكل';
      if (!activeTag) allTag.classList.add('active');
      allTag.addEventListener('click', () => {
        activeTag = null;
        searchInput.value = '';
        currentFilter = '';
        renderPoems();
        renderTags();
      });
      tagsWrapper.appendChild(allTag);
      
      Array.from(tagSet).sort().forEach(tag => {
        const tagBtn = document.createElement('button');
        tagBtn.className = 'tag';
        tagBtn.textContent = tag;
        if (activeTag === tag) tagBtn.classList.add('active');
        tagBtn.addEventListener('click', () => {
          activeTag = tag;
          searchInput.value = '';
          currentFilter = '';
          renderPoems();
          renderTags();
        });
        tagsWrapper.appendChild(tagBtn);
      });
    }

    // Setup event listeners
    function setupEventListeners() {
      document.getElementById('btnList').addEventListener('click', showList);
      document.getElementById('btnAdd').addEventListener('click', showAdd);
      
      searchInput.addEventListener('input', (e) => {
        currentFilter = e.target.value;
        activeTag = null;
        renderPoems();
        renderTags();
      });
      
      document.getElementById('btnDownload').addEventListener('click', downloadPoems);
      document.getElementById('btnReset').addEventListener('click', () => poemForm.reset());
      
      poemForm.addEventListener('submit', (e) => {
        e.preventDefault();
        addPoem();
      });
    }

    // Show list view
    function showList() {
      listSection.style.display = 'block';
      addSection.style.display = 'none';
      document.getElementById('btnList').style.display = 'none';
      document.getElementById('btnAdd').style.display = 'inline-flex';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Show add form
    function showAdd() {
      listSection.style.display = 'none';
      addSection.style.display = 'block';
      document.getElementById('btnList').style.display = 'inline-flex';
      document.getElementById('btnAdd').style.display = 'none';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Add new poem
    function addPoem() {
      const newPoem = {
        id: 'p-' + Date.now(),
        title: document.getElementById('inputTitle').value.trim() || 'بدون عنوان',
        author: document.getElementById('inputAuthor').value.trim(),
        text: document.getElementById('inputText').value.trim(),
        excerpt: document.getElementById('inputExcerpt').value.trim(),
        audio: document.getElementById('inputAudio').value.trim(),
        tags: document.getElementById('inputTags').value
          .split(',')
          .map(t => t.trim())
          .filter(Boolean)
      };
      
      poems.unshift(newPoem);
      savePoems();
      poemForm.reset();
      showList();
      renderPoems();
      renderTags();
    }

    // Download poems as JSON
    function downloadPoems() {
      const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(poems, null, 2));
      const a = document.createElement('a');
      a.setAttribute('href', dataStr);
      a.setAttribute('download', 'mody_poems_' + Date.now() + '.json');
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    // Start app
    init();
  </script>
</body>
</html>
