<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ü™∂ Mody Poetry</title>
  <meta name="description" content="ŸÖÿ¨ŸÜŸàŸÜ ÿßŸÑÿ¥Ÿêÿπÿ± ‚Äî ŸÖŸàŸÇÿπ Ÿäÿ¨ŸÖÿπ ÿ£ÿ¨ŸÖŸÑ ŸÇÿµÿßÿ¶ÿØŸä Ÿàÿ™ÿ£ŸÖŸÑÿßÿ™Ÿä ÿßŸÑÿ¥ÿπÿ±Ÿäÿ©. ÿßŸÉÿ™ÿ¥ŸÅ ŸÖÿ¨ŸÖŸàÿπÿ™Ÿä ÿßŸÑÿ∞Ÿáÿ®Ÿäÿ© ŸÖŸÜ ÿßŸÑÿ£ÿ¥ÿπÿßÿ± ÿßŸÑÿ™Ÿä ÿ™ŸÑÿßŸÖÿ≥ ÿßŸÑŸÇŸÑÿ® Ÿàÿ™ÿπÿ®Ÿëÿ± ÿπŸÜ ÿßŸÑŸÖÿ¥ÿßÿπÿ± ÿ®ÿµÿØŸÇ" />
  <meta name="robots" content="index, follow">
  
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-gradient-1:#fff8f0;
      --bg-gradient-2:#fef3e8;
      --card:#ffffff;
      --card-hover:#fffbf5;
      --muted:#8b7355;
      --accent:#3a1f0b;
      --brown:#8b5e3c;
      --brown-hover:#a67c52;
      --text:#2e1a0f;
      --shadow:rgba(58,31,11,0.08);
      --shadow-lg:rgba(58,31,11,0.12);
      --border:#e8dcc8;
      --placeholder:rgba(139,94,60,0.08);
      --header-dark:#e8d2bf; 
      --header-dark-2:#d9c0a6;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow-x:hidden}
    body{
      font-family:'Cairo',system-ui,sans-serif;
      background:linear-gradient(135deg,var(--bg-gradient-1) 0%,var(--bg-gradient-2) 100%);
      background-attachment:fixed;
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.7;
      padding:0;
    }
    .container{max-width:1100px;margin:0 auto;padding:20px}
    header{
      background:linear-gradient(180deg,var(--header-dark) 0%, var(--header-dark-2) 100%);
      backdrop-filter:blur(6px);
      border-bottom:1px solid rgba(0,0,0,0.06);
      position:sticky;
      top:0;
      z-index:100;
      box-shadow:0 6px 28px rgba(0,0,0,0.08);
      animation:slideDown 0.35s ease;
    }
    @keyframes slideDown{from{transform:translateY(-100%)}to{transform:translateY(0)}}
    .header-content{max-width:1100px;margin:0 auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px;background:rgba(58,31,11,0.06);color:var(--brown);box-shadow:0 4px 12px rgba(0,0,0,0.06)}
    .brand h1{font-size:20px;font-weight:700;color:var(--accent)}
    .brand p{font-size:13px;color:rgba(0,0,0,0.45);margin-top:2px}
    nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap;position:relative}
    .btn{padding:8px 12px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;border:1.4px solid var(--brown);background:#fff;color:#5a3f2a;display:inline-flex;align-items:center;gap:8px;transition:all .18s ease}
    .btn:hover{background:#f5ebe0;border-color:var(--brown-hover)}
    .small{padding:6px 10px;font-size:13px}
    
    .menu-container{position:relative}
    .menu-toggle{position:relative}
    .dropdown-menu{
      position:absolute;
      top:calc(100% + 8px);
      left:0;
      background:#fff;
      border-radius:10px;
      box-shadow:0 12px 32px rgba(0,0,0,0.15);
      border:1px solid var(--border);
      min-width:240px;
      display:none;
      z-index:200;
      padding:6px;
    }
    .dropdown-menu.show{display:block}
    .menu-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:8px;
      font-size:14px;
      font-weight:600;
      color:#5a3f2a;
      cursor:pointer;
      transition:all .15s ease;
      border:none;
      background:transparent;
      width:100%;
      text-align:right;
    }
    .menu-item:hover{background:#f5ebe0}
    .menu-divider{height:1px;background:var(--border);margin:6px 0}

    .hero{background:linear-gradient(135deg,rgba(255,255,255,0.92) 0%,rgba(255,251,245,0.92) 100%);backdrop-filter:blur(8px);border-radius:14px;padding:16px;margin:18px 0;box-shadow:0 8px 32px var(--shadow-lg);border:1px solid var(--border)}
    .search-wrapper{display:flex;gap:8px;flex-wrap:wrap}
    input[type="search"]{flex:1;min-width:200px;padding:10px 12px;border-radius:8px;border:1.5px solid #e8dcc8;font-size:15px;background:#fff}

    .tags-wrapper{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;align-items:center}
    .tag{padding:7px 12px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;border:1.2px solid #d4c4b0;background:#fff;color:#5a3f2a;transition:all .18s ease}
    .tag:hover{background:#f5ebe0;border-color:var(--brown)}
    .tag.active{background:#f5ebe0;border-color:var(--brown);box-shadow:0 6px 14px rgba(58,31,11,0.06)}

    .tag-input-wrapper{display:flex;gap:8px;margin-bottom:8px}
    .tag-badge{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;background:#f5ebe0;border:1px solid var(--brown);border-radius:8px;font-size:13px;color:var(--brown);font-weight:600}
    .tag-badge button{background:none;border:none;color:var(--brown);cursor:pointer;font-size:16px;padding:0;margin:0;line-height:1}
    .tag-badge button:hover{color:#d9534f}

    .audio-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .audio-item{display:flex;align-items:center;gap:8px;padding:8px;background:#f9f9f9;border-radius:8px;border:1px solid var(--border)}
    .audio-item button{background:#d9534f;color:#fff;border:none;padding:4px 8px;border-radius:6px;cursor:pointer;font-size:12px}
    .audio-item button:hover{background:#c9302c}

    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-top:18px}
    .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 8px 20px rgba(0,0,0,0.04);border:1px solid var(--border);transition:all .22s cubic-bezier(0.4, 0, 0.2, 1);display:flex;gap:10px;align-items:flex-start;user-select:none;position:relative;overflow:hidden}
    .card::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(139,94,60,0.15),transparent);transition:left .5s ease;pointer-events:none}
    .card:hover{transform:translateY(-4px);box-shadow:0 12px 28px rgba(0,0,0,0.08)}
    .card:hover::before{left:100%}
    .card .drag-handle{flex:0 0 36px;display:flex;align-items:center;justify-content:center;border-radius:8px;cursor:grab;font-size:17px;color:var(--brown);user-select:none}
    .card .drag-handle:active{cursor:grabbing}
    .card .content{flex:1}
    .card h3{font-family:'Amiri',serif;margin:0 0 6px 0;color:var(--accent);font-size:19px;font-weight:700}
    .excerpt{font-family:'Amiri',serif;color:var(--muted);line-height:1.9;font-size:16px;min-height:56px}
    .card-footer{margin-top:8px;display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap}
    .card-tags{display:flex;gap:6px;flex-wrap:wrap}
    .card-tag{padding:4px 8px;border-radius:12px;font-size:12px;background:rgba(139,94,60,0.12);color:var(--brown);font-weight:700;display:inline-flex;align-items:center;gap:4px}
    .card-ghost{opacity:.4 !important;transform:scale(.98) rotate(2deg) !important;box-shadow:0 20px 40px rgba(0,0,0,.15) !important;transition:all .2s cubic-bezier(0.4, 0, 0.2, 1) !important}
    .card-placeholder{background:var(--placeholder);border:2px dashed rgba(139,94,60,0.18);min-height:72px;border-radius:10px;display:flex;align-items:center;justify-content:center;color:var(--muted)}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;padding:18px;z-index:1200}
    .modal-inner{background:var(--card);max-width:820px;width:100%;border-radius:12px;padding:20px;max-height:90vh;overflow:auto;box-shadow:0 30px 60px rgba(0,0,0,.25);border:1px solid var(--border)}
    .modal-title{font-family:'Amiri',serif;font-size:22px;margin-bottom:6px;color:var(--accent)}
    .poem-text{font-family:'Amiri',serif;white-space:pre-line;font-size:18px;line-height:2;margin-top:12px;color:var(--text);text-align:justify}
    .modal-tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    
    .confirm-modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;padding:18px;z-index:1400}
    .confirm-modal.show{display:flex}
    .confirm-box{background:var(--card);border-radius:12px;padding:24px;max-width:400px;width:100%;box-shadow:0 20px 50px rgba(0,0,0,.3);border:1px solid var(--border)}
    .confirm-message{font-size:16px;margin-bottom:20px;line-height:1.6;white-space:pre-line}
    .confirm-buttons{display:flex;gap:10px;justify-content:flex-end}

    footer{text-align:center;color:var(--muted);margin-top:36px;padding:20px;font-size:13px}

    @media (max-width:768px){
      .grid{grid-template-columns:1fr}
      .header-content{padding:12px}
      nav{gap:6px}
      .dropdown-menu{min-width:200px;right:0;left:auto}
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="brand">
        <div class="brand-icon">‚òï</div>
        <div>
          <h1>Mody Poetry</h1>
          <p class="muted">ŸÇÿµÿßÿ¶ÿØ ŸÖŸàÿØŸä ÿßŸÑÿ∞Ÿáÿ®Ÿäÿ© ‚Äîÿßÿ∂ŸÅ Ÿàÿ¥ÿßÿ±ŸÉ Ÿàÿßÿ≥ÿ™ŸÖÿπ</p>
        </div>
      </div>

      <nav>
        <button class="btn small" id="btnAdd">‚úçÔ∏è ÿ£ÿ∂ŸÅ</button>
        <div class="menu-container">
          <button class="btn small menu-toggle" id="menuToggle">‚ò∞ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©</button>
          <div class="dropdown-menu" id="dropdownMenu">
            <button class="menu-item" id="btnDownload">üíæ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÇÿµÿßÿ¶ÿØ</button>
            <div class="menu-divider"></div>
            <button class="menu-item" id="btnReloadAndSort">ü•≥ ÿ¨ÿØŸäÿØ ŸÖŸàÿØŸä + ÿ™ÿ±ÿ™Ÿäÿ®</button>
            <div class="menu-divider"></div>
            <button class="menu-item" id="btnImportJSON">üì• ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ JSON</button>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <!-- User Info Display -->
  <div id="userInfoDisplay" style="display:none;padding:10px 20px;background:rgba(139,94,60,0.1);border-bottom:1px solid var(--border)">
    <div style="max-width:1100px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
      <div>
        <span style="font-weight:600">üë§ ŸÖÿ±ÿ≠ÿ®ÿßŸãÿå </span>
        <span id="currentUserName" style="color:var(--brown)">---</span>
      </div>
      <button class="btn small" id="btnChangeProfile">ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä</button>
    </div>
  </div>

  <div class="container">
    <section class="hero">
      <div class="search-wrapper">
        <input id="searchInput" type="search" placeholder="üîç ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿπŸÜŸàÿßŸÜ ÿ£Ÿà ÿßŸÑŸÜÿµ..." />
      </div>
      <div id="tagsWrapper" class="tags-wrapper" aria-label="Ÿàÿ≥ŸàŸÖ ÿßŸÑŸÇÿµÿßÿ¶ÿØ"></div>
    </section>

    <section id="listSection">
      <div id="poemGrid" class="grid" aria-live="polite"></div>
      <div id="emptyState" style="display:none;margin-top:18px;padding:18px;border-radius:12px;border:2px dashed var(--border);text-align:center">
        <div style="font-size:28px">üìú</div>
        <div style="font-weight:700;margin-top:8px">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÇÿµÿßÿ¶ÿØ</div>
        <div class="muted" style="margin-top:6px">ÿßÿ∂ÿ∫ÿ∑ "ÿ£ÿ∂ŸÅ" ŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÇÿµŸäÿØÿ© ÿ¨ÿØŸäÿØÿ©</div>
      </div>
    </section>

    <!-- User Profile Modal -->
    <div id="userProfileModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:1500;align-items:center;justify-content:center;padding:18px">
      <div style="background:var(--card);border-radius:12px;padding:20px;max-width:400px;width:100%;box-shadow:0 20px 50px rgba(0,0,0,.25);border:1px solid var(--border)">
        <h3 style="margin:0 0 15px 0">üë§ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä</h3>
        <div style="display:flex;flex-direction:column;gap:10px">
          <input id="userName" type="text" placeholder="ÿßÿ≥ŸÖŸÉ *" required style="padding:10px;border-radius:8px;border:1px solid #e8dcc8" />
          <input id="userEmail" type="email" placeholder="ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)" style="padding:10px;border-radius:8px;border:1px solid #e8dcc8" />
          <textarea id="userBio" placeholder="ŸÜÿ®ÿ∞ÿ© ÿπŸÜŸÉ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)" style="min-height:80px;padding:10px;border-radius:8px;border:1px solid #e8dcc8"></textarea>
          <button class="btn" id="btnSaveProfile">ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä</button>
        </div>
      </div>
    </div>

    <!-- Add Poem Modal -->
    <div id="addModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:1300;align-items:center;justify-content:center;padding:18px">
      <div style="background:var(--card);border-radius:12px;padding:16px;max-width:720px;width:100%;box-shadow:0 20px 50px rgba(0,0,0,.25);border:1px solid var(--border);max-height:90vh;overflow-y:auto">
        <h3 style="margin:0 0 10px 0" id="modalFormTitle">‚úçÔ∏è ÿ£ÿ∂ŸÅ ŸÇÿµŸäÿØÿ©</h3>
        <form id="poemForm">
          <div style="display:flex;flex-direction:column;gap:8px">
            <input id="inputTitle" type="text" placeholder="ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÇÿµŸäÿØÿ© *" required style="padding:10px;border-radius:8px;border:1px solid #e8dcc8" />
            <input id="inputAuthor" type="text" placeholder="ÿßŸÑŸÖÿ§ŸÑŸÅ / ÿßŸÑÿ±ÿßŸàŸä" style="padding:10px;border-radius:8px;border:1px solid #e8dcc8" />
            <textarea id="inputText" placeholder="ŸÜÿµ ÿßŸÑŸÇÿµŸäÿØÿ© * (ÿ≥ÿ∑ÿ± ÿ¨ÿØŸäÿØ = ÿ≥ÿ∑ÿ± ÿ¨ÿØŸäÿØ)" required style="min-height:140px;padding:10px;border-radius:8px;border:1px solid #e8dcc8;font-family:Amiri,serif"></textarea>
            <input id="inputExcerpt" type="text" placeholder="ŸÖŸÇÿ™ÿ∑ŸÅ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)" style="padding:10px;border-radius:8px;border:1px solid #e8dcc8" />
            
            <div>
              <label style="display:block;margin-bottom:6px;font-size:14px;font-weight:600">ÿßŸÑŸàÿ≥ŸàŸÖ (ÿßÿ∂ÿ∫ÿ∑ Enter ŸÑÿ•ÿ∂ÿßŸÅÿ©)</label>
              <div id="tagsDisplay" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px"></div>
              <input id="inputTagField" type="text" placeholder="ÿßŸÉÿ™ÿ® Ÿàÿ≥ŸÖ Ÿàÿßÿ∂ÿ∫ÿ∑ Enter" style="padding:10px;border-radius:8px;border:1px solid #e8dcc8;width:100%" />
            </div>

            <div>
              <label style="display:block;margin-bottom:6px;font-size:14px;font-weight:600">ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿµŸàÿ™Ÿäÿ© ŸàÿßŸÑŸÖÿ±ÿ¶Ÿäÿ©</label>
              <div id="audioDisplay" class="audio-list"></div>
              
              <!-- URL input -->
              <div class="tag-input-wrapper">
                <input id="inputAudioField" type="text" placeholder="ÿ±ÿßÿ®ÿ∑ YouTube ÿ£Ÿà SoundCloud" style="flex:1;padding:10px;border-radius:8px;border:1px solid #e8dcc8" />
                <button type="button" id="btnAddAudio" class="btn small">‚ûï ÿ±ÿßÿ®ÿ∑</button>
              </div>
              
              <!-- File upload -->
              <div style="margin-top:8px">
                <input type="file" id="inputAudioFile" accept="audio/*,video/*" multiple style="padding:8px;border-radius:8px;border:1px solid #e8dcc8;width:100%;font-size:13px" />
              </div>
              
              <div style="margin-top:6px;font-size:12px;color:var(--muted)">
                üí° ŸäŸÖŸÉŸÜŸÉ ÿ±ŸÅÿπ ŸÖŸÑŸÅÿßÿ™ ÿµŸàÿ™Ÿäÿ© ÿ£Ÿà ŸÅŸäÿØŸäŸà ŸÖŸÜ ÿ£Ÿä ÿ≠ÿ¨ŸÖ - ÿ≥Ÿäÿ™ŸÖ ÿ±ŸÅÿπŸáÿß ÿπŸÑŸâ GitHub
              </div>
            </div>

            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button type="button" class="btn" id="btnCancelAdd">ÿ•ŸÑÿ∫ÿßÿ°</button>
              <button type="submit" class="btn">ŸÜÿ¥ÿ± ÿßŸÑŸÇÿµŸäÿØÿ© üì§</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="confirm-modal">
      <div class="confirm-box">
        <div id="confirmMessage" class="confirm-message"></div>
        <div class="confirm-buttons" id="confirmButtons"></div>
      </div>
    </div>
  </div>

  <footer>
    ¬© <span id="year"></span> ŸÖÿ¨ŸÜŸàŸÜ ÿßŸÑÿ¥Ÿêÿπÿ± ‚Äî All rights reserved
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
    // ========================================
    // GITHUB CONFIGURATION
    // ========================================
    const GITHUB_CONFIG = {
      owner: 'abdomedo2033-code',
      repo: 'ModyPoetry',
      branch: 'main'
    };

    // ‚ö†Ô∏è PUT YOUR GITHUB TOKEN HERE ‚ö†Ô∏è
    let GITHUB_TOKEN = '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';  // ‚Üê REPLACE WITH YOUR ACTUAL TOKEN

    // ========================================
    // STORAGE KEYS
    // ========================================
    const STORAGE_KEY = 'mody_poems_v_full_v1';
    const USER_KEY = 'mody_user_profile';

    // ========================================
    // STATE VARIABLES
    // ========================================
    let poems = [];
    let originalPoems = null;
    let isDragging = false;
    let activeTag = null;
    let editingPoem = null;
    let currentTags = [];
    let currentAudios = [];
    let currentUser = null;

    // ========================================
    // DOM ELEMENTS
    // ========================================
    const poemGrid = document.getElementById('poemGrid');
    const emptyState = document.getElementById('emptyState');
    const searchInput = document.getElementById('searchInput');
    const tagsWrapper = document.getElementById('tagsWrapper');
    const year = document.getElementById('year');
    const btnDownload = document.getElementById('btnDownload');
    const btnReloadAndSort = document.getElementById('btnReloadAndSort');
    const btnImportJSON = document.getElementById('btnImportJSON');
    const btnAdd = document.getElementById('btnAdd');
    const addModal = document.getElementById('addModal');
    const poemForm = document.getElementById('poemForm');
    const btnCancelAdd = document.getElementById('btnCancelAdd');
    const menuToggle = document.getElementById('menuToggle');
    const dropdownMenu = document.getElementById('dropdownMenu');
    const confirmModal = document.getElementById('confirmModal');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmButtons = document.getElementById('confirmButtons');
    const inputTagField = document.getElementById('inputTagField');
    const tagsDisplay = document.getElementById('tagsDisplay');
    const inputAudioField = document.getElementById('inputAudioField');
    const audioDisplay = document.getElementById('audioDisplay');
    const btnAddAudio = document.getElementById('btnAddAudio');
    
    // User profile elements
    const userProfileModal = document.getElementById('userProfileModal');
    const userInfoDisplay = document.getElementById('userInfoDisplay');
    const userName = document.getElementById('userName');
    const userEmail = document.getElementById('userEmail');
    const userBio = document.getElementById('userBio');
    const btnSaveProfile = document.getElementById('btnSaveProfile');
    const btnChangeProfile = document.getElementById('btnChangeProfile');
    const currentUserName = document.getElementById('currentUserName');
    const inputAudioFile = document.getElementById('inputAudioFile');

    year.textContent = new Date().getFullYear();

    // ========================================
    // UTILITY FUNCTIONS
    // ========================================
    function showAlert(message) {
      confirmMessage.textContent = message;
      confirmButtons.innerHTML = '<button class="btn" onclick="document.getElementById(\'confirmModal\').classList.remove(\'show\')">ÿ≠ÿ≥ŸÜÿßŸã</button>';
      confirmModal.classList.add('show');
    }
    
    function showConfirm(message, onConfirm) {
      confirmMessage.textContent = message;
      confirmButtons.innerHTML = '';
      
      const btnCancel = document.createElement('button');
      btnCancel.className = 'btn';
      btnCancel.textContent = 'ÿ•ŸÑÿ∫ÿßÿ°';
      btnCancel.onclick = function() {
        confirmModal.classList.remove('show');
      };
      
      const btnOk = document.createElement('button');
      btnOk.className = 'btn';
      btnOk.textContent = 'ÿ™ÿ£ŸÉŸäÿØ';
      btnOk.onclick = function() {
        confirmModal.classList.remove('show');
        onConfirm();
      };
      
      confirmButtons.appendChild(btnCancel);
      confirmButtons.appendChild(btnOk);
      confirmModal.classList.add('show');
    }

    function escapeHtml(text) {
      const d = document.createElement('div');
      d.textContent = text || '';
      return d.innerHTML;
    }

    // ========================================
    // USER PROFILE MANAGEMENT
    // ========================================
    function checkUserProfile() {
      const stored = localStorage.getItem(USER_KEY);
      if (stored) {
        currentUser = JSON.parse(stored);
        showUserInfo();
      } else {
        userProfileModal.style.display = 'flex';
      }
    }

    function showUserInfo() {
      currentUserName.textContent = currentUser.name;
      userInfoDisplay.style.display = 'block';
    }

    btnSaveProfile.addEventListener('click', function() {
      const name = userName.value.trim();
      if (!name) {
        showAlert('‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖŸÉ');
        return;
      }
      
      currentUser = {
        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        name: name,
        email: userEmail.value.trim(),
        bio: userBio.value.trim(),
        createdAt: new Date().toISOString()
      };
      
      localStorage.setItem(USER_KEY, JSON.stringify(currentUser));
      userProfileModal.style.display = 'none';
      showUserInfo();
      
      uploadUserProfileToGitHub();
    });

    btnChangeProfile.addEventListener('click', function() {
      userName.value = currentUser.name;
      userEmail.value = currentUser.email || '';
      userBio.value = currentUser.bio || '';
      userProfileModal.style.display = 'flex';
    });

    // ========================================
    // GITHUB UPLOAD FUNCTIONS
    // ========================================
    async function uploadUserProfileToGitHub() {
      if (!GITHUB_TOKEN || GITHUB_TOKEN === 'ghp_YOUR_NEW_TOKEN_HERE') {
        console.log('GitHub token not configured');
        return;
      }
      
      try {
        const path = `users/${currentUser.id}/profile.json`;
        
        let sha = null;
        try {
          const checkResponse = await fetch(
            `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`,
            {
              headers: { 'Authorization': 'token ' + GITHUB_TOKEN }
            }
          );
          if (checkResponse.ok) {
            const data = await checkResponse.json();
            sha = data.sha;
          }
        } catch(e) {}
        
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(currentUser, null, 2))));
        
        const body = {
          message: `Update profile for ${currentUser.name}`,
          content: content,
          branch: GITHUB_CONFIG.branch
        };
        
        if (sha) body.sha = sha;
        
        const response = await fetch(
          `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`,
          {
            method: 'PUT',
            headers: {
              'Authorization': 'token ' + GITHUB_TOKEN,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(body)
          }
        );
        
        if (!response.ok) throw new Error('Upload failed');
        
        console.log('‚úÖ Profile uploaded to GitHub');
      } catch (error) {
        console.error('Profile upload error:', error);
      }
    }

    async function uploadMediaToGitHub(file) {
      if (!GITHUB_TOKEN || GITHUB_TOKEN === 'ghp_YOUR_NEW_TOKEN_HERE') {
        showAlert('‚ùå GitHub Token ÿ∫Ÿäÿ± ŸÖÿ∂ÿ®Ÿàÿ∑ ŸÅŸä ÿßŸÑŸÉŸàÿØ');
        return null;
      }
      
      try {
        showAlert('‚è≥ ÿ¨ÿßÿ±Ÿä ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ ÿπŸÑŸâ GitHub...\nŸäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±');
        
        const reader = new FileReader();
        const base64 = await new Promise((resolve, reject) => {
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
const timestamp = Date.now();
        const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
        const path = `users/${currentUser.id}/media/${timestamp}_${safeName}`;
        
        const response = await fetch(
          `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`,
          {
            method: 'PUT',
            headers: {
              'Authorization': 'token ' + GITHUB_TOKEN,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              message: `Upload media by ${currentUser.name}: ${safeName}`,
              content: base64,
              branch: GITHUB_CONFIG.branch
            })
          }
        );
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error('Upload failed: ' + (errorData.message || response.status));
        }
        
        const data = await response.json();
        const fileUrl = `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${path}`;
        
        showAlert('‚úÖ ÿ™ŸÖ ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ ÿ®ŸÜÿ¨ÿßÿ≠ ÿπŸÑŸâ GitHub!');
        return fileUrl;
        
      } catch (error) {
        console.error('Upload error:', error);
        showAlert('‚ùå ŸÅÿ¥ŸÑ ÿ±ŸÅÿπ ÿßŸÑŸÖŸÑŸÅ: ' + error.message);
        return null;
      }
    }

    async function uploadPoemsToGitHub() {
      if (!GITHUB_TOKEN || GITHUB_TOKEN === 'ghp_YOUR_NEW_TOKEN_HERE' || !currentUser) return;
      
      try {
        const path = `users/${currentUser.id}/poems.json`;
        
        let sha = null;
        try {
          const checkResponse = await fetch(
            `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`,
            {
              headers: { 'Authorization': 'token ' + GITHUB_TOKEN }
            }
          );
          if (checkResponse.ok) {
            const data = await checkResponse.json();
            sha = data.sha;
          }
        } catch(e) {}
        
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(poems, null, 2))));
        
        const body = {
          message: `Update poems for ${currentUser.name}`,
          content: content,
          branch: GITHUB_CONFIG.branch
        };
        
        if (sha) body.sha = sha;
        
        await fetch(
          `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`,
          {
            method: 'PUT',
            headers: {
              'Authorization': 'token ' + GITHUB_TOKEN,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(body)
          }
        );
        
        console.log('‚úÖ Poems synced to GitHub');
      } catch (error) {
        console.error('Poems sync error:', error);
      }
    }

    // ========================================
    // TAG MANAGEMENT
    // ========================================
    function renderTagsInForm() {
      tagsDisplay.innerHTML = '';
      currentTags.forEach(function(tag, index) {
        const badge = document.createElement('span');
        badge.className = 'tag-badge';
        badge.innerHTML = escapeHtml(tag) + ' <button type="button" onclick="removeTag(' + index + ')">√ó</button>';
        tagsDisplay.appendChild(badge);
      });
    }

    function addTag() {
      const tag = inputTagField.value.trim();
      if (tag && !currentTags.includes(tag)) {
        currentTags.push(tag);
        renderTagsInForm();
        inputTagField.value = '';
      }
    }

    function removeTag(index) {
      currentTags.splice(index, 1);
      renderTagsInForm();
    }

    window.removeTag = removeTag;

    inputTagField.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        addTag();
      }
    });

    // ========================================
    // AUDIO MANAGEMENT
    // ========================================
    function renderAudiosInForm() {
      audioDisplay.innerHTML = '';
      currentAudios.forEach(function(audio, index) {
        const item = document.createElement('div');
        item.className = 'audio-item';
        
        let displayText = '';
        let badge = '';
        
        if (audio.type === 'file') {
          displayText = 'üìÅ ' + escapeHtml(audio.name);
          badge = '<span style="background:#28a745;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:6px">ŸÖÿ≠ŸÑŸä</span>';
        } else if (audio.source === 'github') {
          displayText = 'üì¶ ' + escapeHtml(audio.name || 'GitHub File');
          badge = '<span style="background:#6f42c1;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:6px">GitHub</span>';
        } else if (typeof audio === 'string') {
          displayText = 'üéµ ' + escapeHtml(audio.substring(0, 50)) + (audio.length > 50 ? '...' : '');
        } else {
          displayText = 'üéµ ' + escapeHtml(audio.data.substring(0, 50)) + (audio.data.length > 50 ? '...' : '');
        }
        
        item.innerHTML = badge + displayText + ' <button type="button" onclick="removeAudio(' + index + ')">ÿ≠ÿ∞ŸÅ</button>';
        audioDisplay.appendChild(item);
      });
    }

    function addAudio() {
      const audio = inputAudioField.value.trim();
      if (audio) {
        currentAudios.push({ type: 'url', data: audio });
        renderAudiosInForm();
        inputAudioField.value = '';
      }
    }

    function removeAudio(index) {
      currentAudios.splice(index, 1);
      renderAudiosInForm();
    }

    window.removeAudio = removeAudio;

    btnAddAudio.addEventListener('click', addAudio);

    // File upload handler
    if (inputAudioFile) {
      inputAudioFile.addEventListener('change', async function(e) {
        const files = e.target.files;
        
        for (const file of Array.from(files)) {
          const fileSizeMB = file.size / (1024 * 1024);
          
          // All files go to GitHub
          const url = await uploadMediaToGitHub(file);
          if (url) {
            currentAudios.push({ 
              type: 'url', 
              data: url,
              name: file.name,
              source: 'github',
              uploadedBy: currentUser.name,
              uploadedAt: new Date().toISOString()
            });
            renderAudiosInForm();
          }
        }
        
        e.target.value = '';
      });
    }

    // ========================================
    // MENU HANDLERS
    // ========================================
    menuToggle.addEventListener('click', function(e) {
      e.stopPropagation();
      dropdownMenu.classList.toggle('show');
    });

    document.addEventListener('click', function(e) {
      if (!e.target.closest('.menu-container')) {
        dropdownMenu.classList.remove('show');
      }
    });

    document.querySelectorAll('.menu-item').forEach(function(item) {
      item.addEventListener('click', function() {
        dropdownMenu.classList.remove('show');
      });
    });

    // ========================================
    // INITIALIZATION
    // ========================================
    function init() {
      checkUserProfile();
      
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try {
          poems = JSON.parse(stored);
          fetchJSONIntoOriginal();
        } catch (e) {
          console.error('failed parse localStorage, clearing', e);
          localStorage.removeItem(STORAGE_KEY);
          poems = [];
          loadFromJSON();
        }
      } else {
        loadFromJSON();
      }
      renderPoems();
      initSortable();
      attachListeners();
    }

    function loadFromJSON(forcePopulate) {
      const urls = [
        'https://raw.githubusercontent.com/abdomedo2033-code/ModyPoetry/main/poems.json',
        'poems.json'
      ];
      
      function tryFetch(urlIndex) {
        if (urlIndex >= urls.length) {
          console.warn('All URLs failed, using fallback data');
          useFallbackData();
          return;
        }
        
        fetch(urls[urlIndex] + '?_=' + Date.now(), {cache: 'no-store'})
          .then(function(res) {
            if (!res.ok) throw new Error('fetch failed: ' + res.status);
            return res.json();
          })
          .then(function(data) {
            if (!Array.isArray(data)) throw new Error('poems.json must be an array');
            originalPoems = data.map(function(p) { return {...p}; });
            if (!localStorage.getItem(STORAGE_KEY) || (forcePopulate && !localStorage.getItem(STORAGE_KEY))) {
              poems = originalPoems.map(function(p) { return {...p}; });
              savePoems();
            }
            console.log('poems.json loaded from:', urls[urlIndex], 'items:', originalPoems.length);
            renderPoems();
          })
          .catch(function(err) {
            console.warn('Failed to load from:', urls[urlIndex], err);
            tryFetch(urlIndex + 1);
          });
      }
      
      tryFetch(0);
    }
    
    function useFallbackData() {
      if (!localStorage.getItem(STORAGE_KEY) && poems.length === 0) {
        poems = [];
        originalPoems = [];
        renderPoems();
      }
    }

    function fetchJSONIntoOriginal() {
      const urls = [
        'https://raw.githubusercontent.com/abdomedo2033-code/ModyPoetry/main/poems.json'
      ];
      
      function tryFetch(urlIndex) {
        if (urlIndex >= urls.length) return;
        
        fetch(urls[urlIndex] + '?_=' + Date.now(), {cache:'no-store'})
          .then(function(res) {
            if (!res.ok) throw new Error('fetch failed');
            return res.json();
          })
          .then(function(data) {
            if (Array.isArray(data)) {
              originalPoems = data.map(function(p) { return {...p}; });
              console.log('Background refresh successful from:', urls[urlIndex]);
            }
          })
          .catch(function(e) {
            tryFetch(urlIndex + 1);
          });
      }
      
      tryFetch(0);
    }

    function savePoems() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(poems));
        uploadPoemsToGitHub();
      } catch (e) { 
        console.error('Failed to save:', e); 
      }
    }

    // ========================================
    // RENDERING FUNCTIONS
    // ========================================
    function renderTags() {
      const tagSet = new Set();
      poems.forEach(function(p) {
        (p.tags || []).forEach(function(t) { tagSet.add(t); });
      });
      tagsWrapper.innerHTML = '';
      const allBtn = document.createElement('button');
      allBtn.className = 'tag';
      allBtn.textContent = 'ÿßŸÑŸÉŸÑ';
      if (!activeTag) allBtn.classList.add('active');
      allBtn.addEventListener('click', function() {
        activeTag = null;
        searchInput.value = '';
        renderPoems();
      });
      tagsWrapper.appendChild(allBtn);
      Array.from(tagSet).sort().forEach(function(tag) {
        const btn = document.createElement('button');
        btn.className = 'tag';
        btn.textContent = tag;
        if (activeTag === tag) btn.classList.add('active');
        btn.addEventListener('click', function() {
          activeTag = tag;
          searchInput.value = '';
          renderPoems();
        });
        tagsWrapper.appendChild(btn);
      });
    }

    function renderPoems() {
      const q = (searchInput.value || '').trim().toLowerCase();
      poemGrid.innerHTML = '';

      let filtered;
      if (activeTag) {
        filtered = poems.filter(function(p) {
          return (p.tags || []).includes(activeTag);
        });
      } else {
        filtered = poems.filter(function(p) {
          if (!q) return true;
          const s = (p.title + ' ' + p.text + ' ' + (p.excerpt || '') + ' ' + (p.tags||[]).join(' ')).toLowerCase();
          return s.includes(q);
        });
      }

      if (filtered.length === 0) {
        emptyState.style.display = 'block';
        renderTags();
        return;
      } else {
        emptyState.style.display = 'none';
      }

      filtered.forEach(function(poem) {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.id = poem.id || ('p-' + (Math.random()*1e9|0));

        const tagsHtml = (poem.tags || []).slice(0,3).map(function(t){ 
          return '<span class="card-tag">' + escapeHtml(t) + '</span>'; 
        }).join('');

        card.innerHTML = `
          <div class="drag-handle" title="ÿßÿ∂ÿ∫ÿ∑ Ÿàÿßÿ≥ÿ≠ÿ® ŸÖŸÜ ŸáŸÜÿß">‚ò∞</div>
          <div class="content">
            <h3>${escapeHtml(poem.title)}</h3>
            <div class="excerpt">${escapeHtml(poem.excerpt || poem.text.slice(0,120) + (poem.text.length>120?'...':''))}</div>
            <div class="card-footer">
              <div>${poem.author?'<span class="muted">‚úíÔ∏è '+escapeHtml(poem.author)+'</span>':''}</div>
              <div class="card-tags">${tagsHtml}</div>
            </div>
          </div>
        `;

        card.addEventListener('click', function(e) {
          if (isDragging) return;
          openModal(poem);
        });

        poemGrid.appendChild(card);
      });

      renderTags();
    }

    function openModal(poem) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      
      const tagsHtml = (poem.tags || []).map(function(t){ 
        return '<span class="card-tag">' + escapeHtml(t) + '</span>'; 
      }).join('');

      const audiosHtml = (poem.audios || []).map(function(audio){ 
        return '<div style="margin-top:8px">' + getAudioHtml(audio) + '</div>'; 
      }).join('');

      const legacyAudioHtml = (poem.audio && !poem.audios) ? '<div style="margin-top:8px">' + getAudioHtml(poem.audio) + '</div>' : '';

      modal.innerHTML = `
        <div class="modal-inner">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
            <div style="flex:1">
              <div class="modal-title">${escapeHtml(poem.title)}</div>
              <div class="muted" style="margin-top:6px">${poem.author? '‚úíÔ∏è '+escapeHtml(poem.author):''}</div>
              ${tagsHtml ? '<div class="modal-tags">' + tagsHtml + '</div>' : ''}
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn small" id="editPoem">‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ</button>
              <button class="btn small" id="deletePoem">üóëÔ∏è ÿ≠ÿ∞ŸÅ</button>
              <button class="btn small" id="closeModal">‚úñÔ∏è ÿ•ÿ∫ŸÑÿßŸÇ</button>
            </div>
          </div>
          <div class="poem-text">${escapeHtml(poem.text)}</div>
          ${audiosHtml}
          ${legacyAudioHtml}
        </div>
      `;
      document.body.appendChild(modal);

      modal.querySelector('#closeModal').addEventListener('click', function() { modal.remove(); });
      modal.addEventListener('click', function(e) { if (e.target === modal) modal.remove(); });
      
      modal.querySelector('#editPoem').addEventListener('click', function() {
        editingPoem = poem;
        document.getElementById('inputTitle').value = poem.title || '';
        document.getElementById('inputAuthor').value = poem.author || '';
        document.getElementById('inputText').value = poem.text || '';
        document.getElementById('inputExcerpt').value = poem.excerpt || '';
        
        currentTags = poem.tags || [];
        renderTagsInForm();
        
        if (poem.audios && Array.isArray(poem.audios)) {
          currentAudios = poem.audios.map(function(a) {
            if (typeof a === 'string') {
              return { type: 'url', data: a };
            }
            return a;
          });
        } else if (poem.audio) {
          currentAudios = [{ type: 'url', data: poem.audio }];
        } else {
          currentAudios = [];
        }
        renderAudiosInForm();
        
        document.getElementById('modalFormTitle').textContent = '‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÇÿµŸäÿØÿ©';
        addModal.style.display = 'flex';
        modal.remove();
      });
      
      modal.querySelector('#deletePoem').addEventListener('click', function() {
        showConfirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÇÿµŸäÿØÿ©ÿü', function() {
          poems = poems.filter(function(p) { return p.id !== poem.id; });
          savePoems();
          renderPoems();
          modal.remove();
        });
      });
      
      document.addEventListener('keydown', function esc(e){ 
        if (e.key === 'Escape') { 
          modal.remove(); 
          document.removeEventListener('keydown', esc); 
        }
      });
    }

    function getAudioHtml(audio) {
      if (!audio) return '';
      
      if (audio.type === 'file') {
        if (audio.mimeType && audio.mimeType.startsWith('video/')) {
          return '<video controls preload="metadata" style="width:100%;max-height:400px;border-radius:8px"><source src="' + audio.data + '" type="' + audio.mimeType + '"></video>';
        } else {
          return '<audio controls preload="metadata" style="width:100%;border-radius:8px"><source src="' + audio.data + '" type="' + (audio.mimeType || 'audio/mpeg') + '"></audio>';
        }
      } else if (audio.type === 'url' || typeof audio === 'string') {
        const url = audio.data || audio;
        
        // YouTube
        if (url.includes('youtube.com') || url.includes('youtu.be')) {
          let videoId = '';
          if (url.includes('youtu.be/')) {
            videoId = url.split('youtu.be/')[1].split('?')[0];
          } else if (url.includes('youtube.com')) {
            const urlParams = new URLSearchParams(url.split('?')[1] || '');
            videoId = urlParams.get('v');
          }
          if (videoId) {
            return '<iframe width="100%" height="315" src="https://www.youtube.com/embed/' + videoId + '" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="border-radius:8px"></iframe>';
          }
        }
        
        // SoundCloud
        if (url.includes('soundcloud.com') && !url.includes('<iframe')) {
          return '<iframe width="100%" height="166" scrolling="no" frameborder="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=' + encodeURIComponent(url) + '&color=%238b5e3c&auto_play=false&hide_related=true"></iframe>';
        }
        
        // Direct iframe embed
        if (url.includes('<iframe')) {
          return url;
        }
        
        // Regular audio/video URL
        return '<audio controls preload="metadata" style="width:100%;border-radius:8px"><source src="' + escapeHtml(url) + '"></audio>';
      }
      
      return '';
    }

    // ========================================
    // SORTABLE
    // ========================================
    let sortableInstance = null;
    function initSortable() {
      if (!poemGrid) return;
      if (sortableInstance && typeof sortableInstance.destroy === 'function') {
        try { sortableInstance.destroy(); } catch(e){}
      }
      sortableInstance = new Sortable(poemGrid, {
        animation: 200,
        easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
        ghostClass: 'card-ghost',
        chosenClass: 'card-chosen',
        dragClass: 'card-drag',
        handle: '.drag-handle',
        fallbackOnBody: true,
        swapThreshold: 0.65,
        forceFallback: false,
        dataIdAttr: 'data-id',
        onStart: function() { isDragging = true; },
        onEnd: function() {
          const ids = Array.from(poemGrid.children).map(function(c) { return c.dataset.id; }).filter(Boolean);
          const newOrder = [];
          ids.forEach(function(id) {
            const found = poems.find(function(p) { return p.id === id; });
            if (found) newOrder.push(found);
          });
          const missing = poems.filter(function(p) { return !ids.includes(p.id); });
          poems = newOrder.concat(missing);
          savePoems();
          setTimeout(function() { isDragging = false; }, 80);
        }
      });
    }

    // ========================================
    // EVENT LISTENERS
    // ========================================
    function attachListeners() {
      searchInput.addEventListener('input', function() {
        activeTag = null;
        renderPoems();
      });

      btnDownload.addEventListener('click', function() {
        const a = document.createElement('a');
        const blob = new Blob([JSON.stringify(poems, null, 2)], {type: 'application/json'});
        a.href = URL.createObjectURL(blob);
        a.download = 'mody_poems_' + Date.now() + '.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
      });

      btnReloadAndSort.addEventListener('click', function() {
        showConfirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ¨ŸÑÿ® ÿ¢ÿÆÿ± ŸÇÿµÿßÿ¶ÿØ ŸÖŸàÿØŸä ŸÖŸÜ GitHub Ÿàÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÇÿµÿßÿ¶ÿØÿü', function() {
          const urls = [
            'https://raw.githubusercontent.com/abdomedo2033-code/ModyPoetry/main/poems.json',
            'poems.json'
          ];
          
          function tryFetchReload(urlIndex) {
            if (urlIndex >= urls.length) {
              showAlert('‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖŸÑŸÅ ÿπŸÑŸâ GitHub.\n\nüí° ŸÜÿµŸäÿ≠ÿ©:\n1. ÿ£ŸÜÿ¥ÿ¶ ŸÖŸÑŸÅ poems.json ŸÅŸä ŸÖÿ≥ÿ™ŸàÿØÿπŸÉ\n2. ÿ™ÿ£ŸÉÿØ ÿ£ŸÜ ÿßŸÑŸÖÿ≥ÿ™ŸàÿØÿπ Public\n3. ÿßÿ≥ÿ™ÿÆÿØŸÖ "ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ JSON" ŸÑÿ±ŸÅÿπ ŸÖŸÑŸÅ ŸÖŸÜ ÿ¨Ÿáÿßÿ≤ŸÉ');
              return;
            }
            
            console.log('üîÑ Trying to load from:', urls[urlIndex]);
            
            fetch(urls[urlIndex] + '?_=' + Date.now(), {cache: 'no-store'})
              .then(function(res) {
                console.log('Response status:', res.status);
                if (!res.ok) throw new Error('Status: ' + res.status);
                return res.json();
              })
              .then(function(data) {
                if (!Array.isArray(data)) throw new Error('ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸäÿ≥ÿ™ ŸÖÿµŸÅŸàŸÅÿ©');
                originalPoems = data.map(function(p) { return {...p}; });
                
                const currentMap = new Map(poems.map(function(p) { return [p.id, p]; }));
                let added = 0;
                originalPoems.forEach(function(orig) {
                  if (!currentMap.has(orig.id)) {
                    poems.push({...orig});
                    added++;
                  }
                });
                
                const ordered = [];
                const seen = new Set();
                originalPoems.forEach(function(orig) {
                  const found = poems.find(function(p) { return p.id === orig.id; });
                  if (found) {
                    ordered.push(found);
                    seen.add(found.id);
                  }
                });
                poems.forEach(function(p) {
                  if (!seen.has(p.id)) ordered.push(p);
                });
                poems = ordered;
                
                savePoems();
                renderPoems();
                showAlert('‚úÖ ÿ™ŸÖ ÿ®ŸÜÿ¨ÿßÿ≠!\n\nüéâ ÿ£Ÿèÿ∂ŸäŸÅ: ' + added + ' ŸÇÿµŸäÿØÿ© ÿ¨ÿØŸäÿØÿ©\nüìã ÿπÿØÿØ ÿßŸÑŸÇÿµÿßÿ¶ÿØ ÿßŸÑŸÉŸÑŸä: ' + poems.length + '\n‚ú® ÿ™ŸÖ ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÇÿµÿßÿ¶ÿØ ÿ≠ÿ≥ÿ® ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä');
              })
              .catch(function(err) {
                console.error('‚ùå Failed from ' + urls[urlIndex] + ':', err);
                tryFetchReload(urlIndex + 1);
              });
          }
          
          tryFetchReload(0);
        });
      });

      btnImportJSON.addEventListener('click', function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json,application/json';
        input.onchange = function(e) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function(evt) {
            try {
              const text = evt.target.result;
              const data = JSON.parse(text);
              if (!Array.isArray(data)) throw new Error('ÿßŸÑŸÖŸÑŸÅ Ÿäÿ¨ÿ® ÿ£ŸÜ Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ŸÖÿµŸÅŸàŸÅÿ© ŸÖŸÜ ÿßŸÑŸÇÿµÿßÿ¶ÿØ');
              const currentIds = new Set(poems.map(function(p) { return p.id; }));
              let addedCount = 0;
              data.forEach(function(p) {
                if (!p.id) {
                  p.id = 'p-' + Date.now() + (Math.random()*1e6|0);
                }
                if (!currentIds.has(p.id)) {
                  poems.push({...p});
                  currentIds.add(p.id);
                  addedCount++;
                }
              });
              if (addedCount > 0) {
                savePoems();
                renderPoems();
              }
              showAlert('ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ' + addedCount + ' ŸÇÿµŸäÿØÿ© ÿ¨ÿØŸäÿØÿ© ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅ.');
            } catch (err) {
              showAlert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿπŸÜÿØ ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ: ' + (err.message || err));
            }
          };
          reader.readAsText(file);
        };
        input.click();
      });

      btnAdd.addEventListener('click', function() {
        editingPoem = null;
        poemForm.reset();
        currentTags = [];
        currentAudios = [];
        renderTagsInForm();
        renderAudiosInForm();
        document.getElementById('modalFormTitle').textContent = '‚úçÔ∏è ÿ£ÿ∂ŸÅ ŸÇÿµŸäÿØÿ©';
        addModal.style.display = 'flex';
      });
      
      btnCancelAdd.addEventListener('click', function() {
        editingPoem = null;
        addModal.style.display = 'none';
        poemForm.reset();
        currentTags = [];
        currentAudios = [];
        renderTagsInForm();
        renderAudiosInForm();
      });
      
      poemForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const poemData = {
          title: document.getElementById('inputTitle').value.trim() || 'ÿ®ÿØŸàŸÜ ÿπŸÜŸàÿßŸÜ',
          author: document.getElementById('inputAuthor').value.trim(),
          text: document.getElementById('inputText').value.trim(),
          excerpt: document.getElementById('inputExcerpt').value.trim(),
          tags: currentTags,
          audios: currentAudios,
          createdBy: currentUser.name,
          userId: currentUser.id
        };
        
        if (editingPoem) {
          const index = poems.findIndex(function(p) { return p.id === editingPoem.id; });
          if (index !== -1) {
            poems[index] = { ...poemData, id: editingPoem.id };
          }
          editingPoem = null;
        } else {
          poemData.id = 'p-' + Date.now();
          poems.unshift(poemData);
        }
        
        savePoems();
        renderPoems();
        addModal.style.display = 'none';
        poemForm.reset();
        currentTags = [];
        currentAudios = [];
        renderTagsInForm();
        renderAudiosInForm();
      });
    }

    // ========================================
    // START APPLICATION
    // ========================================
    init();
  </script>
</body>
</html>
      
